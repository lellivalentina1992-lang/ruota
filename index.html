<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - V16 (Grafica TV & Accessibilità)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- STILE GRAFICO "TV SHOW" --- */
        body {
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); /* Sfondo studio TV */
            color: #ffffff;
            font-family: 'Verdana', sans-serif;
            margin: 0; padding: 10px;
            min-height: 100vh;
        }

        /* FOCUS AD ALTO CONTRASTO (Per ipovedenti/tastiera) */
        *:focus {
            outline: 4px solid #ffd700 !important;
            outline-offset: 4px;
            box-shadow: 0 0 15px #ffd700;
        }

        h1 {
            color: #ffd700;
            text-align: center;
            text-shadow: 2px 2px 0px #ff0000;
            font-size: 2em; margin-bottom: 10px;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        /* SETUP PANEL */
        #setup-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px; border-radius: 15px;
            border: 2px solid #444;
            backdrop-filter: blur(5px);
        }

        /* STATUS BAR */
        .status-bar {
            background: linear-gradient(90deg, #002244 0%, #004488 100%);
            padding: 15px; text-align: center; font-size: 1.3em;
            border: 2px solid #0088ff; border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,136,255,0.5);
        }
        .turn-active {
            background: linear-gradient(90deg, #004400 0%, #008800 100%);
            border-color: #00ff00;
            color: #fff; text-shadow: 0 0 5px #00ff00;
            transform: scale(1.02); transition: 0.3s;
        }

        /* TABELLONE GRAFICO (EFFETTO 3D) */
        #board-container {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            background: rgba(0, 50, 0, 0.8); /* Sfondo verde scuro semitrasparente */
            padding: 20px; border-radius: 15px; border: 4px solid #ffd700;
            margin-bottom: 20px;
            box-shadow: inset 0 0 20px #000;
            min-height: 120px; justify-content: center;
        }
        .board-row { display: flex; gap: 6px; }
        
        .tile {
            width: 40px; height: 55px;
            background: linear-gradient(to bottom, #ffffff 0%, #e0e0e0 100%);
            color: black; font-weight: 900; font-size: 2em;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px;
            box-shadow: 0 4px 0 #999; /* Effetto 3D */
            text-transform: uppercase;
        }
        /* Lettera nascosta (Bianca vuota) */
        .tile.hidden { color: transparent; background: white; }
        /* Spazio vuoto (Verde scuro) */
        .tile.empty {
            background: transparent; box-shadow: none; border: 1px dashed rgba(0,255,0,0.2);
        }

        /* LAYOUT DUE COLONNE (PC) */
        .game-area { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; align-items: flex-start; }
        .col-visual { flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; }
        .col-controls { flex: 1; min-width: 300px; }

        /* RUOTA GRAFICA */
        #wheel-wrapper {
            position: relative; width: 280px; height: 280px; margin-bottom: 15px;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
        }
        #wheel-visual {
            width: 100%; height: 100%; border-radius: 50%;
            border: 8px solid #fff;
            background: conic-gradient(
                #ff0000 0deg 36deg, #ff8800 36deg 72deg, #ffff00 72deg 108deg, 
                #00aa00 108deg 144deg, #0088ff 144deg 180deg, #8800ff 180deg 216deg, 
                #ff00ff 216deg 252deg, #222222 252deg 288deg, #cccccc 288deg 324deg, #ffd700 324deg 360deg
            );
            transition: transform 4s cubic-bezier(0.1, 0.8, 0.1, 1);
        }
        /* Perno centrale */
        #wheel-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; background: white; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 2;
        }
        /* Indicatore */
        #wheel-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 35px solid #ffffff; z-index: 3;
            filter: drop-shadow(0 2px 2px black);
        }
        #wheel-status-text {
            background: #000; color: #ffd700; padding: 10px 20px;
            border: 2px solid #ffd700; border-radius: 50px;
            font-size: 1.5em; font-weight: bold; text-align: center;
            margin-bottom: 20px;
        }

        /* BOTTONI */
        button {
            width: 100%; padding: 15px; margin-bottom: 10px; font-size: 1.2em;
            border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; text-transform: uppercase;
            transition: transform 0.1s, background 0.2s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: #ffcc00; color: #000; border-bottom: 4px solid #b38f00; }
        .btn-secondary { background: #0088ff; color: #fff; border-bottom: 4px solid #0055aa; }
        .btn-accent { background: #ff0066; color: #fff; border-bottom: 4px solid #aa0044; }
        .btn-host { background: #aa0000; color: #fff; border: 1px solid red; }
        
        button:disabled { background: #444; color: #888; border-bottom: none; cursor: not-allowed; }

        /* LISTA GIOCATORI */
        #player-list { list-style: none; padding: 0; margin-top: 20px; }
        #player-list li {
            background: rgba(255,255,255,0.1); margin-bottom: 5px; padding: 10px;
            border-radius: 5px; display: flex; justify-content: space-between;
        }

        /* MODALE */
        #input-area, #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        #game-input {
            font-size: 3em; padding: 10px; width: 80%; text-align: center;
            background: #fff; color: #000; border-radius: 10px; border: none;
        }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<div id="inspector-overlay" class="hidden" role="dialog" aria-label="Ispettore Testuale">
    <div style="background:#222; padding:30px; border-radius:10px; border:2px solid #ffd700; max-width:90%; max-height:80%; overflow:auto;">
        <h2 style="color:#ffd700; margin-top:0;">Modalità Lettura (Frecce SU/GIÙ)</h2>
        <div id="inspector-text" tabindex="-1" style="font-size:1.5em; line-height:1.6; color:#fff;"></div>
        <button onclick="closeInspector()" class="btn-secondary" style="margin-top:20px;">CHIUDI (ESC)</button>
    </div>
</div>

<div class="container">
    <h1>LA RUOTA DELLA FORTUNA</h1>

    <div id="setup-panel">
        <label style="font-size:1.2em;">Il tuo nome:</label>
        <input id="inp-name" type="text" placeholder="Nome" style="padding:10px; width:95%; margin:10px 0; font-size:1.2em;">
        <label style="font-size:1.2em;">Codice Stanza:</label>
        <input id="inp-code" type="text" placeholder="Es. CASA" style="padding:10px; width:95%; margin:10px 0; font-size:1.2em;">
        <button onclick="joinGame(true)" class="btn-primary">CREA NUOVA STANZA</button>
        <button onclick="joinGame(false)" class="btn-secondary">ENTRA IN STANZA</button>
    </div>

    <div id="game-panel" class="hidden">
        
        <div class="status-bar">
            <div id="turn-indicator">In attesa...</div>
            <div id="my-score" style="font-size:0.9em; margin-top:5px; color:#ffd700;">Tu: €0 | Jolly: 0</div>
        </div>

        <div class="game-area">
            <div class="col-controls">
                <div id="category-display" style="text-align:center; font-style:italic; margin-bottom:10px; color:#00ff00; font-size:1.2em;">CATEGORIA: —</div>
                
                <div id="board-container" aria-hidden="true"></div>
                
                <div style="text-align:center; color:#aaa; font-size:0.9em; margin-bottom:15px;">
                    Usa le ⬆️⬇️⬅️➡️ frecce per leggere il tabellone.
                </div>

                <ul id="player-list"></ul>
            </div>

            <div class="col-visual">
                <div id="wheel-wrapper" aria-hidden="true">
                    <div id="wheel-pointer"></div>
                    <div id="wheel-visual"><div id="wheel-center"></div></div>
                </div>
                
                <div id="wheel-status-text">GIRA LA RUOTA</div>

                <button id="btn-spin" class="btn-primary" onclick="doSpin()">1. GIRA RUOTA (Ctrl+G)</button>
                <div style="display:flex; gap:10px; width:100%;">
                    <button id="btn-vowel" class="btn-secondary" onclick="openInput('vowel')">2. VOCALE (Ctrl+V)</button>
                    <button id="btn-solve" class="btn-accent" onclick="openInput('solve')">3. RISOLVI (Ctrl+S)</button>
                </div>
                <button id="btn-read-letters" class="btn-secondary" onclick="readRevealedLetters()" style="background:#444; border-bottom:4px solid #222;">LEGGI LETTERE (Ctrl+L)</button>

                <div id="host-controls" class="hidden" style="margin-top:15px; width:100%;">
                    <button onclick="startNewRound()" class="btn-host">HOST: NUOVO ROUND (Ctrl+H)</button>
                    <button onclick="destroyRoom()" class="btn-host" style="background:#550000;">HOST: CHIUDI STANZA</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="input-area" class="hidden">
    <label id="input-label" for="game-input" style="color:#ffd700; font-size:2em; margin-bottom:20px;">INSERISCI:</label>
    <input id="game-input" type="text" autocomplete="off">
    <div style="display:flex; gap:20px; margin-top:20px; width:80%;">
        <button onclick="submitInput()" class="btn-primary">CONFERMA (Invio)</button>
        <button onclick="closeInput()" class="btn-secondary" style="background:#555; border-color:#333;">ANNULLA (Esc)</button>
    </div>
</div>

<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>

<script>
    const supabase = window.supabase.createClient(
        'https://azcwkpdjbysnivknnino.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU'
    );
    const WHEEL_VALUES = [100, 200, 300, 400, 500, 1000, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO'];
    const NATO = {'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','À':'A accentata','È':'E accentata','Ì':'I accentata','Ò':'O accentata','Ù':'U accentata'};

    let myId, myRoomId, myIndex, isHost = false;
    let roomState = {};
    let currentSolution = "";
    let currentRevealed = [];
    let inputMode = null;
    let isSpinning = false;
    let isProcessing = false;
    let navWordIdx = 0;
    let navCharIdx = 0;
    let parsedBoard = [];
    let wheelRot = 0;

    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = '';
        setTimeout(() => el.textContent = text, 50);
        console.log("SPEAK:", text);
    }
    function cleanStr(str) { return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z]/g, ""); }
    function playHitSound(times) {
        let count = 0;
        function loop() {
            if (count < times) {
                const audio = document.getElementById('snd-hit');
                if(audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
                count++; setTimeout(loop, 250);
            }
        } loop();
    }
    function play(id) { document.getElementById(id).play().catch(()=>{}); }

    document.getElementById('game-input').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') { e.preventDefault(); submitInput(); }
    });

    // NAVIGAZIONE GLOBALE
    document.addEventListener('keydown', (e) => {
        if(document.activeElement.tagName === 'INPUT') return;
        
        // Tasti Funzione
        if(e.ctrlKey) {
            const k = e.key.toLowerCase();
            if(k==='i') { e.preventDefault(); openInspector(); return; }
            if(k==='l') { e.preventDefault(); readRevealedLetters(); return; }
            if(k==='h') { e.preventDefault(); if(isHost) startNewRound(); return; }
            if(['g','v','s'].includes(k)) {
                e.preventDefault();
                if(inputMode || document.getElementById('game-panel').classList.contains('hidden')) return;
                if(roomState.stato !== 'gioco') { speak("Gioco fermo."); return; }
                if(roomState.id_giocatore_corrente !== myIndex) { speak("Non tocca a te."); return; }
                if(k==='g') doSpin(); if(k==='v') openInput('vowel'); if(k==='s') openInput('solve');
                return;
            }
        }

        if(e.key === 'Escape') {
            if(inputMode) closeInput();
            closeInspector();
            document.getElementById('btn-spin').focus();
            return;
        }

        // Navigazione Tabellone (Frecce)
        if(parsedBoard.length > 0) {
            let moved = false;
            if (e.key === 'ArrowRight') { navCharIdx++; moved=true; }
            if (e.key === 'ArrowLeft') { navCharIdx--; moved=true; }
            if (e.key === 'ArrowDown') { navWordIdx++; navCharIdx=0; moved=true; }
            if (e.key === 'ArrowUp') { navWordIdx--; navCharIdx=0; moved=true; }
            
            if(moved) {
                e.preventDefault();
                if(navWordIdx < 0) navWordIdx = 0;
                if(navWordIdx >= parsedBoard.length) navWordIdx = parsedBoard.length - 1;
                let w = parsedBoard[navWordIdx];
                if(navCharIdx < 0) navCharIdx = 0;
                if(navCharIdx >= w.chars.length) navCharIdx = w.chars.length - 1;
                
                let c = w.chars[navCharIdx];
                let charText = "Nascosta";
                if(c.isRevealed) charText = `${c.realChar}, ${NATO[c.realChar.toUpperCase()]||""}`;
                speak(`${navCharIdx===0 ? "Parola "+(navWordIdx+1)+". " : ""}${charText}, ${navCharIdx+1} di ${w.chars.length}`);
            }
        }
    });

    async function joinGame(create) {
        const name = document.getElementById('inp-name').value.trim().toUpperCase();
        const code = document.getElementById('inp-code').value.trim().toUpperCase();
        if(!name || !code) return speak("Dati mancanti");

        if(create) {
             const time = new Date(Date.now() - 3600000).toISOString();
             await supabase.from('stanze').delete().lt('created_at', time);
        }

        let rId;
        if(create) {
            const {data, error} = await supabase.from('stanze').insert({codice:code, stato:'attesa'}).select().single();
            if(error) return speak("Errore codice");
            rId = data.id;
        } else {
            const {data} = await supabase.from('stanze').select('*').eq('codice',code).maybeSingle();
            if(!data) return speak("Stanza inesistente");
            rId = data.id;
        }
        myRoomId = rId;

        const {data:exist} = await supabase.from('giocatori').select('*').eq('stanza_id',rId).eq('nome',name).maybeSingle();
        if(exist) {
            myId=exist.id; myIndex=exist.indice; speak("Bentornato " + name);
        } else {
            const {count} = await supabase.from('giocatori').select('*',{count:'exact',head:true}).eq('stanza_id',rId);
            const {data:neu} = await supabase.from('giocatori').insert({stanza_id:rId, nome:name, indice:count||0}).select().single();
            myId=neu.id; myIndex=neu.indice; speak("Benvenuto " + name);
        }

        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('game-panel').classList.remove('hidden');
        document.getElementById('btn-spin').focus();
        startSync();
    }

    function startSync() {
        supabase.channel('room').on('postgres_changes',{event:'*',schema:'public',table:'stanze',filter:'id=eq.'+myRoomId}, 
            p => { if(p.eventType==='DELETE'){alert("Stanza chiusa");location.reload();} else updateRoom(p.new); })
        .subscribe();
        supabase.channel('players').on('postgres_changes',{event:'*',schema:'public',table:'giocatori',filter:'stanza_id=eq.'+myRoomId}, updatePlayers).subscribe();
        
        supabase.from('stanze').select('*').eq('id',myRoomId).single().then(r=>updateRoom(r.data));
        updatePlayers();
    }

    async function updatePlayers() {
        const {data: pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        if(!pl) return;
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        
        if (pl.length > 0) {
            const oldest = pl[0];
            if (oldest.id === myId && !isHost) { isHost = true; document.getElementById('host-controls').classList.remove('hidden'); }
            else if (oldest.id !== myId && isHost) { isHost = false; document.getElementById('host-controls').classList.add('hidden'); }
        }

        pl.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${p.indice+1}. ${p.nome} ${p.id===myId?"(TU)":""}</span> <strong>€${p.punteggio_totale}</strong> (Jolly: ${p.jolly})`;
            if(p.indice === roomState.id_giocatore_corrente && roomState.stato === 'gioco') {
                li.style.background = 'rgba(0,255,0,0.2)'; li.style.border = '1px solid #0f0';
            }
            list.appendChild(li);
            if(p.id === myId) document.getElementById('my-score').textContent = `Tu: €${p.punteggio_totale} | Jolly: ${p.jolly}`;
        });
    }

    async function updateRoom(data) {
        if(!data) return;
        roomState = data;
        const isMyTurn = (data.id_giocatore_corrente === myIndex && data.stato === 'gioco');
        const ti = document.getElementById('turn-indicator');

        if(data.stato !== 'gioco') ti.textContent = "ATTESA (Host preme CTRL+H)";
        else if(isMyTurn) { ti.textContent = "È IL TUO TURNO!"; ti.className='status-bar turn-active'; }
        else { ti.textContent = `Turno Giocatore ${data.id_giocatore_corrente+1}`; ti.className='status-bar'; }

        ['btn-spin','btn-vowel','btn-solve'].forEach(id => document.getElementById(id).disabled = !isMyTurn);
        
        const wTxt = document.getElementById('wheel-status-text');
        wTxt.textContent = data.montepremi_round > 0 ? `VALORE: €${data.montepremi_round}` : "GIRA LA RUOTA";

        if(data.frase_corrente_id) {
            if(!currentSolution || data.stato === 'attesa') {
                const {data:f} = await supabase.from('frasi').select('*').eq('id',data.frase_corrente_id).single();
                if(f) { currentSolution = f.soluzione.toUpperCase(); document.getElementById('category-display').textContent = "CATEGORIA: " + f.categoria; }
            }
            currentRevealed = data.lettere_rivelate || [];
            parseBoardData();
        }

        if(isMyTurn && data.montepremi_round > 0 && !inputMode && !isSpinning && !isProcessing) openInput('letter');
    }

    function doSpin() {
        if(isSpinning) return;
        isSpinning = true;
        play('snd-spin');
        
        // Rotazione Visiva
        wheelRot += (720 + Math.random() * 360);
        document.getElementById('wheel-visual').style.transform = `rotate(${wheelRot}deg)`;
        
        setTimeout(async () => {
            isSpinning = false;
            const val = WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
            
            if(val === 'BANCAROTTA') {
                const {data:me} = await supabase.from('giocatori').select('jolly').eq('id',myId).single();
                if(me.jolly > 0) {
                    await supabase.from('giocatori').update({jolly: me.jolly - 1}).eq('id',myId);
                    speak("Bancarotta! Salvato dal Jolly.");
                    await supabase.from('stanze').update({montepremi_round:0}).eq('id',myRoomId);
                } else {
                    speak("Bancarotta!");
                    await supabase.from('giocatori').update({punteggio_totale:0}).eq('id',myId);
                    passTurn();
                }
            } 
            else if (val === 'PASSA') { speak("Passa"); passTurn(); } 
            else if (val === 'MISTERO') { await handleMistero(); } 
            else {
                speak(`Esce ${val}.`);
                await supabase.from('stanze').update({montepremi_round:val}).eq('id',myRoomId);
            }
        }, 3000);
    }

    async function handleMistero() {
        const outs = ['BANKRUPT', 'DOUBLE', 'FREE_CONS', 'FREE_VOWEL', 'JOLLY'];
        const res = outs[Math.floor(Math.random() * outs.length)];
        const {data:me} = await supabase.from('giocatori').select('*').eq('id',myId).single();

        if(res === 'BANKRUPT') {
            if(me.jolly > 0) {
                await supabase.from('giocatori').update({jolly: me.jolly - 1}).eq('id',myId);
                speak("Mistero Bancarotta (Salvato)");
            } else {
                await supabase.from('giocatori').update({punteggio_totale: 0}).eq('id',myId);
                speak("Mistero Bancarotta"); passTurn(); return;
            }
        } else if (res === 'DOUBLE') {
            await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale * 2}).eq('id',myId);
            speak("Mistero Raddoppio");
        } else if (res === 'JOLLY') {
            await supabase.from('giocatori').update({jolly: me.jolly + 1}).eq('id',myId);
            speak("Mistero Jolly");
        } else {
            let norm = cleanStr(currentSolution);
            let cands = [];
            for(let i=0; i<norm.length; i++) {
                if(!currentRevealed.includes(i)) {
                    let ch = currentSolution[i].toUpperCase();
                    let isV = "AEIOUÀÈÌÒÙ".includes(ch);
                    if((res==='FREE_VOWEL' && isV) || (res==='FREE_CONS' && !isV && /[A-Z]/.test(ch))) cands.push(ch);
                }
            }
            if(cands.length > 0) {
                let pick = cands[Math.floor(Math.random()*cands.length)];
                let ind = [];
                for(let i=0; i<currentSolution.length; i++) if(currentSolution[i].toUpperCase()===pick) ind.push(i);
                let nr = [...new Set([...currentRevealed,...ind])];
                await supabase.from('stanze').update({lettere_rivelate:nr}).eq('id',myRoomId);
                speak("Mistero regala "+pick);
            } else speak("Mistero vuoto");
        }
        await supabase.from('stanze').update({montepremi_round:0}).eq('id',myRoomId);
    }

    function openInput(mode) {
        if(mode === 'vowel') {
            const sc = parseInt(document.getElementById('my-score').textContent.split('€')[1])||0;
            if(sc < 500) { speak("Servono 500 euro"); return; }
        }
        inputMode = mode;
        document.getElementById('input-area').classList.remove('hidden');
        const inp = document.getElementById('game-input');
        const lbl = document.getElementById('input-label');
        inp.value = ''; inp.focus();
        if(mode==='letter') lbl.textContent = `CONSONANTE (€${roomState.montepremi_round})`;
        else if(mode==='vowel') lbl.textContent = "VOCALE (€500)";
        else lbl.textContent = "SOLUZIONE";
    }

    function closeInput() {
        document.getElementById('input-area').classList.add('hidden');
        inputMode = null; document.getElementById('btn-spin').focus();
    }

    async function submitInput() {
        if(isProcessing) return;
        const txt = document.getElementById('game-input').value.toUpperCase().trim();
        if(!txt) return;
        isProcessing = true;
        const mode = inputMode;
        closeInput();

        if(mode === 'solve') {
            if(cleanStr(txt) === cleanStr(currentSolution)) {
                playHitSound(3); speak("VITTORIA!");
                await supabase.from('stanze').update({stato:'attesa',montepremi_round:0}).eq('id',myRoomId);
            } else { play('snd-miss'); speak("Errato."); passTurn(); }
            isProcessing = false; return;
        }

        const char = txt.charAt(0);
        if(mode === 'vowel') {
             const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
             await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale - 500}).eq('id',myId);
        }

        let ind = [];
        for(let i=0; i<currentSolution.length; i++) {
            if(cleanStr(currentSolution[i]) === cleanStr(char)) ind.push(i);
        }

        if(ind.length > 0 && currentRevealed.includes(ind[0])) {
            speak("Già chiamata!"); passTurn();
        } else if(ind.length > 0) {
            playHitSound(ind.length); speak("Trovate "+ind.length);
            let nr = [...new Set([...currentRevealed,...ind])];
            if(mode === 'letter') {
                 const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
                 const win = roomState.montepremi_round * ind.length;
                 await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale + win}).eq('id',myId);
                 await supabase.from('stanze').update({lettere_rivelate:nr, montepremi_round: 0}).eq('id',myRoomId);
            } else {
                 await supabase.from('stanze').update({lettere_rivelate:nr}).eq('id',myRoomId);
            }
        } else {
            play('snd-miss'); speak("Non c'è."); passTurn();
        }
        setTimeout(() => { isProcessing = false; }, 1000);
    }

    async function passTurn() {
        const {data:pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        const nxt = (myIndex + 1) % pl.length;
        await supabase.from('stanze').update({id_giocatore_corrente:nxt, montepremi_round:0}).eq('id',myRoomId);
    }

    async function startNewRound() {
        const {data:f} = await supabase.from('frasi').select('*');
        if(!f || !f.length) return speak("Nessuna frase");
        const pick = f[Math.floor(Math.random()*f.length)];
        await supabase.from('stanze').update({stato:'gioco', frase_corrente_id:pick.id, lettere_rivelate:[], montepremi_round:0}).eq('id',myRoomId);
        speak("Nuovo round!");
    }
    
    async function destroyRoom() {
        if(!isHost) return;
        if(confirm("Chiudere stanza?")) {
            await supabase.from('giocatori').delete().eq('stanza_id', myRoomId);
            await supabase.from('stanze').delete().eq('id', myRoomId);
            location.reload();
        }
    }

    function readRevealedLetters() {
        if(currentRevealed.length === 0) return speak("Nessuna.");
        let u = new Set(); currentRevealed.forEach(i => u.add(currentSolution[i].toUpperCase()));
        let msg = "Presenti: " + Array.from(u).sort().join(", ");
        speak(msg);
    }

    function openInspector() {
        const txt = document.getElementById('inspector-text');
        let html = `<p style="color:#ffd700">CAT: ${document.getElementById('category-display').textContent.split(': ')[1]}</p>`;
        parsedBoard.forEach((w, i) => {
            html += `<p>Parola ${i+1}: ${w.chars.map(c => c.isRevealed ? c.realChar : "_").join(" ")}</p>`;
        });
        txt.innerHTML = html;
        document.getElementById('inspector-overlay').classList.remove('hidden');
        txt.focus();
    }
    function closeInspector() {
        document.getElementById('inspector-overlay').classList.add('hidden');
        document.getElementById('btn-spin').focus();
    }

    function parseBoardData() {
        parsedBoard = [];
        if (!currentSolution) return;
        const raw = currentSolution.split(' ');
        let g = 0;
        raw.forEach(w => {
            let obj = { chars: [] };
            for (let i = 0; i < w.length; i++) {
                const ch = w[i];
                obj.chars.push({ realChar: ch, isRevealed: currentRevealed.includes(g) });
                g++;
            }
            parsedBoard.push(obj); g++; 
        });
        
        // RENDER GRAFICO
        const cont = document.getElementById('board-container');
        cont.innerHTML = '';
        parsedBoard.forEach(w => {
            const row = document.createElement('div');
            row.className = 'board-row';
            w.chars.forEach(c => {
                const tile = document.createElement('div');
                tile.className = 'tile' + (c.isRevealed ? '' : ' hidden');
                tile.textContent = c.realChar;
                row.appendChild(tile);
            });
            cont.appendChild(row);
        });
    }
</script>
</body>
</html>