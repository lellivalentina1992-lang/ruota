<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Ruota - V35 Audio Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg-body: #111; --col-text: #fff; --col-focus: #ffd700; --bg-panel: #222; }
        body.high-contrast { --bg-body: #000; --col-text: #fff; --col-focus: #00ffff; --bg-panel: #000; border: 2px solid yellow; }
        body { background: var(--bg-body); color: var(--col-text); font-family: 'Verdana', sans-serif; margin: 0; padding: 10px; text-align: center; padding-bottom: 120px; }
        
        *:focus { outline: 4px solid var(--col-focus) !important; box-shadow: 0 0 15px var(--col-focus); }
        
        .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); }
        .hidden { display: none !important; }
        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
        #game-panel, #setup-panel, #end-panel, #round-over-panel { border: 2px solid #555; padding: 15px; margin-top: 15px; background: var(--bg-panel); border-radius: 10px; width: 95%; }
        #public-rooms-container { margin-top: 30px; border-top: 2px solid #555; padding-top: 20px; width: 100%; }
        .room-btn { width: 100%; padding: 15px; margin: 5px 0; background: #333; color: #fff; border: 2px solid #00ff00; border-radius: 8px; font-size: 1.2em; cursor: pointer; text-align: left; }
        
        #flash-overlay { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 700px; padding: 20px; background: rgba(0, 0, 0, 0.9); border: 6px solid var(--col-focus); border-radius: 15px; z-index: 5000; text-align: center; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        #flash-overlay.visible { opacity: 1; }
        #flash-message { font-size: 2.8em; font-weight: 900; color: #fff; text-transform: uppercase; margin: 0; line-height: 1.2; text-shadow: 2px 2px 0 #000; }
        
        #board-container { display: flex; flex-direction: column; align-items: center; gap: 8px; background: #053305; border: 4px solid #fff; padding: 20px; margin: 20px 0; min-height: 150px; outline: none; }
        .board-row { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .tile { width: 45px; height: 65px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 2.2em; color: #000; background: #fff; border: 2px solid #000; }
        .tile.empty { background: #004400; border: 1px dashed #006600; color: transparent; }
        .tile.punct { background: #ccc; color: #000; border: 1px solid #999; }
        
        .tile.cursor-char { border: 5px solid var(--col-focus); transform: scale(1.1); z-index: 10; }
        .board-row.cursor-word { outline: 3px solid var(--col-focus); background: rgba(255, 255, 0, 0.2); }
        
        #tactile-nav { display: flex; justify-content: center; gap: 10px; padding: 10px; position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 2px solid var(--col-focus); z-index: 2000; }
        .nav-btn { background: #333; color: #fff; border: 2px solid #555; width: 55px; height: 55px; border-radius: 50%; font-size: 1.8em; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        #wheel-visual { width: 150px; height: 150px; margin: 10px auto; border-radius: 50%; border: 5px solid #fff; background: conic-gradient(#f00, #ff0, #0f0, #00f, #f0f, orange); transition: transform 3.5s cubic-bezier(0.1, 0.9, 0.1, 1); }
        #wheel-pointer { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #fff; margin: 0 auto -20px auto; position: relative; z-index: 20; }
        
        button.action-btn { padding: 15px 30px; margin: 10px; cursor: pointer; font-weight: 900; font-size: 1.2em; text-transform: uppercase; border: 3px solid #fff; border-radius: 10px; }
        .btn-primary { background: #ffd700; color: #000; }
        .btn-secondary { background: #00ffff; color: #000; }
        .btn-danger { background: #ff4444; color: #fff; }
        .btn-special { background: #ff00ff; color: #fff; border-color: #fff; }
        .btn-pass { background: #888; color: #fff; border-color: #aaa; }
        .disabled-btn { background: #444 !important; color: #888 !important; cursor: not-allowed; }
        
        #input-area, #inspector-overlay, #privacy-dialog, #dialog-generic { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input { font-size: 2.5em; padding: 15px; text-align: center; width: 80%; background: #222; color: #fff; border: 3px solid var(--col-focus); border-radius: 10px; margin-bottom: 20px; }
        
        .modal-content { background: #222; border: 4px solid var(--col-focus); padding: 20px; width: 90%; border-radius: 15px; text-align: center; }
        .modal-title { color: #ffd700; font-size: 2em; margin-bottom: 20px; text-transform: uppercase; }
        .modal-body { color: #fff; font-size: 1.5em; margin-bottom: 30px; }

        @media (min-width: 769px) { #tactile-nav { position: relative; background: transparent; border: none; padding: 20px; } .tile { width: 50px; height: 75px; font-size: 2.5em; } }
    </style>
</head>
<body>
    <div id="sr-announcer" class="sr-only" aria-live="assertive"></div>
    <div id="flash-overlay" aria-hidden="true"><div id="flash-title">ULTIMA AZIONE</div><p id="flash-message"></p></div>
    <div style="display:flex; justify-content:space-between; width:95%; max-width:900px; margin:0 auto;">
         <button id="contrast-toggle-btn" onclick="toggleContrast()" style="margin-bottom:10px;">Cambia Contrasto (C)</button>
         <button id="history-btn" onclick="openActionHistory()" style="margin-bottom:10px;">Storico (A)</button>
    </div>

    <audio id="snd-spin" src="ruota.wav"></audio>
    <audio id="snd-hit" src="lettera presente.wav"></audio>
    <audio id="snd-miss" src="lettera assente.wav"></audio>
    
    <audio id="snd-turn" src="tocca_a_te.mp3"></audio>
    <audio id="snd-bankrupt" src="bancarotta.mp3"></audio>
    <audio id="snd-win" src="vittoria.mp3"></audio>
    <audio id="snd-drum" src="rullo.mp3"></audio>
    
    <audio id="snd-clap" src="applausi.mp3"></audio>
    <audio id="snd-laugh" src="risata.mp3"></audio>
    <audio id="snd-boo" src="buuu.mp3"></audio>
    <audio id="snd-ooh" src="peccato.mp3"></audio>

    <div id="setup-panel" class="container">
        <h1 style="color:#ffd700;">LA RUOTA V35 AUDIO EXP</h1>
        <input id="inp-name" type="text" placeholder="IL TUO NOME"><br><br>
        <input id="inp-code" type="text" placeholder="CODICE STANZA (OPZIONALE)"><br><br>
        <button onclick="askPrivacy()" class="action-btn btn-primary">CREA NUOVA STANZA</button>
        <button onclick="joinGame(false)" class="action-btn btn-secondary">ENTRA CON CODICE</button>
        <div id="public-rooms-container">
            <h2 style="color:#00ff00;">STANZE PUBBLICHE</h2>
            <button onclick="fetchPublicRooms()" class="action-btn" style="font-size:1em; padding:10px;">AGGIORNA LISTA</button>
            <div id="rooms-list" style="width:100%; padding:10px;"><p>Premi aggiorna...</p></div>
        </div>
    </div>

    <div id="game-panel" class="container hidden">
        <div id="timer-box" role="timer" aria-live="off" style="font-size:2em; color:red; border:2px solid red; padding:5px 15px; border-radius:20px; display:inline-block;">120</div>
        <div class="info-bar" style="width:100%; display:flex; justify-content:space-between; padding:10px;">
            <div style="text-align:left;">
                <span id="round-indicator" style="color:#aaa;">Round 1/10</span><br>
                <span id="turn-indicator" style="font-size:1.2em; font-weight:bold;">...</span>
            </div>
            <div style="text-align:right;">
                <span style="color:#00ff00;">‚Ç¨</span> <span id="score-round" style="color:#00ff00; font-weight:bold; font-size:1.4em;">0</span><br>
                <span style="color:#ffd700;">Tot: ‚Ç¨</span> <span id="score-total" style="color:#ffd700;">0</span><br>
                <span id="jolly-indicator" style="color:#ff00ff; font-weight:bold;"></span>
            </div>
        </div>
        
        <div id="special-round-info" class="hidden" style="background: #300030; padding: 10px; border: 2px solid #f0f; margin-bottom: 10px; border-radius: 8px;">
            <h3 style="color: #f0f; margin: 0;">ROUND SPECIALE</h3>
            <p id="special-round-rules" style="color: #fff; margin: 5px 0; font-weight: bold;"></p>
        </div>

        <h2 id="live-category" style="color:#00ffff; margin: 10px 0;">...</h2>
        <h3 id="round-hint" style="color:#ffd700; margin-bottom: 15px;"></h3>
        <div id="board-container" aria-label="Tabellone di gioco"></div>
        
        <div id="tactile-nav">
            <button class="nav-btn" onclick="moveWordNav(-1)" aria-label="Parola Precedente"><span>&#171;</span></button>
            <button class="nav-btn" onclick="moveNav(-1)" aria-label="Lettera Precedente"><span>&#8249;</span></button>
            <button class="nav-btn btn-read" onclick="readFullBoard()" aria-label="Leggi Tutto"><span>&#9679;</span></button>
            <button class="nav-btn" onclick="moveNav(1)" aria-label="Lettera Successiva"><span>&#8250;</span></button>
            <button class="nav-btn" onclick="moveWordNav(1)" aria-label="Parola Successiva"><span>&#187;</span></button>
        </div>

        <div id="wheel-pointer"></div><div id="wheel-visual"></div>
        <div id="wheel-status-text" tabindex="-1" style="font-size: 1.5em; font-weight: bold; color: #00ff00; margin: 10px; min-height: 1.5em;"></div>
        
        <div id="controls">
            <button id="btn-spin" class="action-btn btn-primary" onclick="doSpin()">GIRA (G)</button>
            <button id="btn-free-vowel" class="action-btn btn-special hidden" onclick="openInput('vowel_free')">VOCALE GRATIS</button>
            <button id="btn-vowel" class="action-btn btn-secondary" onclick="openInput('vowel')">VOCALE (V)</button>
            <button id="btn-solve" class="action-btn btn-danger" onclick="openInput('solve')">RISOLVI (S)</button>
            <button id="btn-pass" class="action-btn btn-pass" onclick="passTurn()">PASSA (P)</button>
            <button id="btn-manual-cons" class="action-btn hidden" onclick="openInput('letter')" style="background: #00ff00; color: #000;">DI UNA CONSONANTE</button>
        </div>
        <div style="margin-top:10px; border-top:1px solid #555; padding-top:10px;">
            <p style="color:#aaa; font-size:0.9em;">REAZIONI RAPIDE (Tasti 1-4)</p>
            <button onclick="playAudio('snd-clap')" class="action-btn" style="padding:10px; font-size:1em;">üëè (1)</button>
            <button onclick="playAudio('snd-laugh')" class="action-btn" style="padding:10px; font-size:1em;">üòÇ (2)</button>
            <button onclick="playAudio('snd-boo')" class="action-btn" style="padding:10px; font-size:1em;">üëé (3)</button>
            <button onclick="playAudio('snd-ooh')" class="action-btn" style="padding:10px; font-size:1em;">üòì (4)</button>
        </div>
        <button id="btn-close-room" class="action-btn btn-danger hidden" onclick="closeRoom()" style="border-color:red; margin-top:20px;">CHIUDI STANZA (HOST)</button>
    </div>

    <div id="round-over-panel" class="container hidden">
        <h2 id="round-title" style="color: #00ff00;">ROUND COMPLETATO!</h2>
        <p id="round-winner-msg" style="font-size: 1.5em;">...</p>
        <p id="solution-msg" style="color: #ffd700; font-size: 1.5em; font-weight:bold;">...</p>
        <button id="btn-next-round" onclick="startNewRound()" class="action-btn btn-primary">PROSSIMO ROUND (INVIO)</button>
        <button id="btn-close-room-round" class="action-btn btn-danger hidden" onclick="closeRoom()">CHIUDI STANZA</button>
    </div>

    <div id="end-panel" class="container hidden">
        <h2 style="color: #ffd700;">FINE PARTITA</h2>
        <ul id="ranking-list" style="list-style: none; padding: 0; font-size: 1.5em;"></ul>
        <button onclick="location.reload()" class="action-btn btn-secondary">TORNA AL MENU</button>
    </div>

    <div id="input-area" class="hidden">
        <h2 id="input-title" style="color:#ffd700;">...</h2>
        <input id="game-input" type="text" autocomplete="off" placeholder="Scrivi qui...">
        <div style="display:flex; justify-content:center; flex-wrap:wrap;">
            <button onclick="submitInput()" class="action-btn btn-primary">OK (INVIO)</button>
            <button onclick="clearInput()" class="action-btn" style="background: #ff9900; color: #000;">SVUOTA</button>
            <button onclick="closeInput()" class="action-btn btn-secondary">ANNULLA (ESC)</button>
        </div>
    </div>

    <div id="dialog-generic" class="hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h2 id="dialog-title" class="modal-title">ATTENZIONE</h2>
            <div id="dialog-body" class="modal-body">Messaggio...</div>
            <div id="dialog-actions">
                </div>
        </div>
    </div>

    <div id="privacy-dialog" class="hidden" role="dialog" aria-modal="true" aria-label="Scegli privacy stanza">
        <h2 style="color:#fff;">COME VUOI LA STANZA?</h2>
        <p style="color:#aaa; max-width: 600px; padding: 10px;">Pubblica: visibile a tutti.<br>Privata: serve il codice.</p>
        <div>
            <button id="btn-create-public" onclick="createRoomFinal(true)" class="action-btn btn-primary">PUBBLICA</button>
            <button onclick="createRoomFinal(false)" class="action-btn btn-secondary">PRIVATA</button>
        </div>
        <button onclick="document.getElementById('privacy-dialog').classList.add('hidden')" class="action-btn" style="margin-top:20px;">ANNULLA</button>
    </div>

    <div id="inspector-overlay" class="hidden" role="dialog" aria-modal="true" aria-label="Ispettore">
        <div id="inspector-content" style="background:#222; border:4px solid #ffd700; padding:20px; width:90%; max-height:80%; overflow-y:auto; color:#fff; font-size: 1.4em;" tabindex="-1"></div>
        <button onclick="closeInspector()" class="action-btn btn-secondary" style="margin-top:20px;">CHIUDI (ESC)</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://azcwkpdjbysnivknnino.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const NATO={'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','√Ä':'A accentata','√à':'E aperta','√â':'E chiusa','√å':'I accentata','√í':'O accentata','√ô':'U accentata', "'": "Apostrofo", "?": "Punto di domanda", "!": "Punto esclamativo", ".": "Punto", ",": "Virgola", "0":"Zero", "1":"Uno", "2":"Due", "3":"Tre", "4":"Quattro", "5":"Cinque", "6":"Sei", "7":"Sette", "8":"Otto", "9":"Nove"};
        const WHEEL_VALUES=[100,200,300,400,500,600,700,800,900,1000,2000,'MISTERO','PASSA','BANCAROTTA'];
        const VOWELS_LIST=['A','E','I','O','U','√Ä','√à','√â','√å','√í','√ô'];
        const AUTO_VOWELS=['A','E','I','O']; 
        const TURN_LIMIT_SEC=120;

        let myId,myIndex,roomId,isHost=false,currentFrase=null,currentStanza=null,currentPuzzleText="",currentHintText="",fullSolutionText="",lastTimestamp="",isSpinning=false,inputMode=null,wheelAngle=0,parsedBoard=[],navWordIdx=0,navCharIdx=0,pollingInterval=null,timerInterval=null,actionLog=[],isFetching=false,isProcessingInput=false,isHandlingTimeout=false;
        let lastFocusedElement=null;
        let isReadingList=false;
        let pendingMultiplier=1; 
        let vowelsBoughtThisTurn = 0;
        let wasMyTurn = false; // Per rilevare cambio turno

        function playAudio(id){const a=document.getElementById(id);if(a){a.pause();a.currentTime=0;a.play().catch(e=>{});}}
        function playMultiHit(n){let count=n>10?10:n;let i=0;function l(){if(i<count){playAudio('snd-hit');i++;setTimeout(l,300);}}l();}
        function speak(t){const e=document.getElementById('sr-announcer');e.textContent='';setTimeout(()=>{e.textContent=t;},50);}
        function cleanStr(s){return s?s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,""):"";}
        function showFlashMessage(msg,type){const ov=document.getElementById('flash-overlay'),txt=document.getElementById('flash-message');txt.textContent=msg;if(type==='bad'){ov.style.borderColor='#ff0000';txt.style.color='#ff4444';}else if(type==='good'){ov.style.borderColor='#00ff00';txt.style.color='#00ff00';}else{ov.style.borderColor='#ffd700';txt.style.color='#fff';}ov.classList.add('visible');setTimeout(()=>{ov.classList.remove('visible');},4000);}
        function toggleContrast(){document.body.classList.toggle('high-contrast');localStorage.setItem('highContrast',document.body.classList.contains('high-contrast'));speak(document.body.classList.contains('high-contrast')?"Alto contrasto attivato":"Contrasto normale");}
        if(localStorage.getItem('highContrast')==='true')document.body.classList.add('high-contrast');
        function setBtnState(id,d){const b=document.getElementById(id);if(!b)return;if(d){b.classList.add('disabled-btn');b.setAttribute('aria-disabled','true');b.disabled=true;}else{b.classList.remove('disabled-btn');b.setAttribute('aria-disabled','false');b.disabled=false;}}
        function isBtnDisabled(id){return document.getElementById(id).getAttribute('aria-disabled')==='true';}

        function askPrivacy(){const nm=document.getElementById('inp-name').value.trim();if(!nm)return speak("Inserisci nome.");document.getElementById('privacy-dialog').classList.remove('hidden');document.getElementById('btn-create-public').focus();}
        async function createRoomFinal(isPublic){document.getElementById('privacy-dialog').classList.add('hidden');let cd=document.getElementById('inp-code').value.trim().toUpperCase();if(!cd)cd="STANZA-"+Math.floor(Math.random()*9999);joinGame(true,cd,isPublic);}
        async function fetchPublicRooms(){const l=document.getElementById('rooms-list');l.innerHTML="Caricamento...";speak("Cerco...");const{data:s}=await supabase.from('stanze').select('codice,stato').eq('is_public',true).neq('stato','terminata').limit(10);if(!s||!s.length){l.innerHTML="<p>Nessuna stanza.</p>";speak("Nessuna stanza trovata.");return;}l.innerHTML="";s.forEach(r=>{const b=document.createElement('button');b.className='room-btn';b.textContent=`${r.codice} (${r.stato})`;b.onclick=()=>{document.getElementById('inp-code').value=r.codice;joinGame(false);};l.appendChild(b);});speak(`Trovate ${s.length} stanze.`);}
        async function closeRoom(){if(!confirm("Sicuro?"))return;if(roomId){await supabase.from('giocatori').delete().eq('stanza_id',roomId);await supabase.from('stanze').delete().eq('id',roomId);location.reload();}}

        async function joinGame(cr,forcedCode=null,isPublic=false){
            const nm=document.getElementById('inp-name').value.trim().toUpperCase(),cd=forcedCode||document.getElementById('inp-code').value.trim().toUpperCase();
            if(!nm)return speak("Manca nome");if(!cd&&!cr)return speak("Manca codice");
            try{let st;if(cr){
                const{data:fr}=await supabase.from('frasi').select('id');
                const rid=fr[Math.floor(Math.random()*fr.length)].id;
                const{data:old}=await supabase.from('stanze').select('id').eq('codice',cd).maybeSingle();
                if(old){await supabase.from('giocatori').delete().eq('stanza_id',old.id);await supabase.from('stanze').delete().eq('id',old.id);}
                const{data}=await supabase.from('stanze').insert({codice:cd,frase_corrente_id:rid,is_public:isPublic,azione_timestamp:new Date().toISOString()}).select().maybeSingle();st=data;
            }else{const{data}=await supabase.from('stanze').select('*').eq('codice',cd).maybeSingle();if(!data)return speak("Stanza non trovata");st=data;
            roomId=st.id;await supabase.from('giocatori').delete().eq('stanza_id',roomId).eq('nome',nm);} 
            
            roomId=st.id;
            const{data:mx}=await supabase.from('giocatori').select('indice').eq('stanza_id',roomId).order('indice',{ascending:false}).limit(1).maybeSingle();
            myIndex=(mx)?mx.indice+1:0;isHost=(myIndex===0);
            const{data:pl}=await supabase.from('giocatori').insert({stanza_id:roomId,nome:nm,indice:myIndex,is_host:isHost,jolly_scadenze:[]}).select().maybeSingle();myId=pl.id;
            document.getElementById('setup-panel').classList.add('hidden');document.getElementById('game-panel').classList.remove('hidden');
            speak("Benvenuto. In attesa.");
            supabase.channel('game').on('postgres_changes',{event:'UPDATE',schema:'public',table:'stanze',filter:`id=eq.${roomId}`},fetchFullState).subscribe();
            supabase.channel('game-del').on('postgres_changes',{event:'DELETE',schema:'public',table:'stanze',filter:`id=eq.${roomId}`},()=>{speak("Stanza chiusa.");setTimeout(()=>location.reload(),3000);}).subscribe();
            fetchFullState();pollingInterval=setInterval(fetchFullState,15000);timerInterval=setInterval(checkTurnTimer,1000);
            }catch(e){console.error(e);speak("Errore.");}
        }

        async function fetchFullState(){if(isFetching)return;isFetching=true;const{data:s}=await supabase.from('stanze').select('*,frasi(*),giocatori(*)').eq('id',roomId).maybeSingle();isFetching=false;if(!s)return;updateUI(s);}

        function checkTurnTimer(){
            if(!currentStanza||currentStanza.stato!=='gioco')return;
            const baseT=currentStanza.azione_timestamp;if(!baseT)return;
            const elapsed = Math.floor((new Date().getTime()-new Date(baseT).getTime())/1000);
            const left=Math.max(0,(TURN_LIMIT_SEC+(inputMode==='solve'||inputMode==='letter'?30:0))-elapsed);
            document.getElementById('timer-box').textContent=left;
            if(left<=10&&left>0)playAudio('snd-hit');
            if(left===0&&!isSpinning&&!isHandlingTimeout&&isHost)handleTimeout();
        }
        
        async function handleTimeout(){ passTurn(); }

        function getDynamicVowelCost() {
            if(!currentPuzzleText) return 1000;
            const len = currentPuzzleText.length; 
            if(len <= 50) return 500;
            if(len <= 80) return 1000;
            return 2000;
        }

        async function passTurn(){
            if(isHandlingTimeout)return; isHandlingTimeout=true;
            const s=currentStanza;
            const n=(s.id_giocatore_corrente+1)%s.giocatori.length;
            
            vowelsBoughtThisTurn = 0;

            let currentPhase = s.vocali_speciali_chiamate || 0;
            let nextPhase = currentPhase;
            const isLastPlayerOfLap = (s.id_giocatore_corrente === s.giocatori[s.giocatori.length - 1].indice);
            let nullRoundTrigger = false;

            if(s.fase_speciale === 1) { 
                if(isLastPlayerOfLap && (currentPhase === 0 || currentPhase === 1)) {
                    nextPhase++;
                }
                
                if(currentPhase === 2 && isLastPlayerOfLap) {
                    await giveAutomaticVowels(s); 
                    return;
                }

                if(currentPhase >= 100) {
                    nextPhase = currentPhase + 1;
                    if(nextPhase >= 112) nullRoundTrigger = true;
                }
            }

            await supabase.from('stanze').update({
                id_giocatore_corrente: n, 
                vocali_speciali_chiamate: nextPhase, 
                ultima_azione:'timeout', 
                ultimo_messaggio: "Passo il turno.", 
                montepremi_round:0, 
                azione_timestamp:new Date().toISOString()
            }).eq('id',roomId);
            
            if(nullRoundTrigger) {
                setTimeout(async () => {
                    await supabase.from('stanze').update({
                        ultimo_messaggio: "CONSONANTI FINITE! TEMPO SCADUTO!",
                        ultima_azione: 'info',
                        azione_timestamp: new Date().toISOString()
                    }).eq('id', roomId);
                }, 1000);
            }

            isHandlingTimeout=false; fetchFullState();
        }

        async function giveAutomaticVowels(s) {
            if(isProcessingInput) return; isProcessingInput = true;
            
            const numPlayers = s.giocatori.length;
            let vowelsToGive = 3 - numPlayers;
            if(vowelsToGive < 0) vowelsToGive = 0;

            let msg = "GIRO VOCALI FINITO.";
            let newRevealed = [...(s.lettere_rivelate || [])];
            
            if(vowelsToGive > 0) {
                msg = `IL SISTEMA REGALA ${vowelsToGive} VOCALI!`;
                
                let sol = currentPuzzleText.toUpperCase();
                let candidates = [...AUTO_VOWELS]; 
                const called = s.lettere_chiamate || [];
                candidates = candidates.filter(c => !called.includes(c));
                
                candidates.sort(() => Math.random() - 0.5);
                const selectedChars = candidates.slice(0, vowelsToGive);
                
                let foundChars = [];
                selectedChars.forEach(char => {
                    let gI2 = 0;
                    let foundAny = false;
                    for(let i=0; i<sol.length; i++) {
                        if(sol[i].match(/[A-Z√Ä-√ô]/)) {
                            if(cleanStr(sol[i]) === cleanStr(char)) {
                                newRevealed.push(gI2);
                                foundAny = true;
                            }
                            gI2++;
                        }
                    }
                    if(foundAny) foundChars.push(char);
                });
                if(foundChars.length > 0) msg += ` ECCO: ${foundChars.join(", ")}.`;
                else msg += " NESSUNA TROVATA.";
            }

            await supabase.from('stanze').update({
                lettere_rivelate: [...new Set(newRevealed)], 
                vocali_speciali_chiamate: 3, 
                ultimo_messaggio: msg, 
                ultima_azione: 'info', 
                azione_timestamp: new Date().toISOString()
            }).eq('id', roomId);

            isProcessingInput = false;

            setTimeout(async () => {
                await supabase.from('stanze').update({
                    vocali_speciali_chiamate: 100, 
                    id_giocatore_corrente: 0, 
                    ultimo_messaggio: "VIA ALLE 12 CONSONANTI! ORA!",
                    ultima_azione: 'info',
                    azione_timestamp: new Date().toISOString()
                }).eq('id', roomId);
            }, 5000);
        }

        function updateUI(s){
            if(s.stato!=='gioco'&&inputMode)closeInput();
            currentStanza=s;s.giocatori=Array.isArray(s.giocatori)?s.giocatori:[];s.giocatori.sort((a,b)=>a.indice-b.indice);
            
            if(isHost){document.getElementById('btn-close-room').classList.remove('hidden');document.getElementById('btn-close-room-round').classList.remove('hidden');}
            else{document.getElementById('btn-close-room').classList.add('hidden');document.getElementById('btn-close-room-round').classList.add('hidden');}

            if(s.stato==='attesa'){
                document.getElementById('game-panel').classList.add('hidden');document.getElementById('round-over-panel').classList.remove('hidden');
                document.getElementById('round-title').textContent="PRONTI";document.getElementById('round-winner-msg').textContent="Codice: "+s.codice;
                document.getElementById('solution-msg').textContent="Attesa Host...";
                document.getElementById('btn-next-round').textContent="AVVIA PARTITA";
                if(s.azione_timestamp!==lastTimestamp){lastTimestamp=s.azione_timestamp;speak("Partita pronta.");}
                return;
            }
            if(s.stato==='terminata'){ 
                 document.getElementById('game-panel').classList.add('hidden');document.getElementById('end-panel').classList.remove('hidden');
                 const l=document.getElementById('ranking-list');l.innerHTML="";
                 [...s.giocatori].sort((a,b)=>b.punteggio_totale-a.punteggio_totale).forEach((p,i)=>{
                     const jl = (p.jolly_scadenze && Array.isArray(p.jolly_scadenze)) ? p.jolly_scadenze.length : 0;
                     l.innerHTML+=`<li>${i+1}. ${p.nome}: ‚Ç¨${p.punteggio_totale} (Jolly residui: ${jl})</li>`
                 });
                 return;
            }
            if(s.stato==='finito'){
                if(s.buffer_frasi_speciali && s.buffer_frasi_speciali.length > 0) {
                    let maxBufferLen = s.buffer_frasi_speciali.length;
                    if(s.indice_buffer < maxBufferLen - 1) {
                        if(isHost && s.azione_timestamp!==lastTimestamp) setTimeout(startNewRound, 4000); 
                        if(s.azione_timestamp!==lastTimestamp){ lastTimestamp=s.azione_timestamp; playMultiHit(3); showFlashMessage("PROSSIMA FRASE...", "good"); }
                        return; 
                    }
                }
                document.getElementById('game-panel').classList.add('hidden');document.getElementById('round-over-panel').classList.remove('hidden');
                document.getElementById('round-title').textContent="FINE ROUND";document.getElementById('round-winner-msg').textContent=s.ultimo_messaggio;document.getElementById('solution-msg').textContent=fullSolutionText;
                document.getElementById('btn-next-round').textContent="PROSSIMO ROUND";
                if(s.azione_timestamp!==lastTimestamp){
                    lastTimestamp=s.azione_timestamp;
                    playAudio('snd-win'); // SUONO VITTORIA
                    speak("Fine Round. "+s.ultimo_messaggio);
                    setTimeout(()=>document.getElementById('btn-next-round').focus(),500);
                }
                return;
            }

            document.getElementById('round-over-panel').classList.add('hidden');document.getElementById('game-panel').classList.remove('hidden');
            if(!s.frasi)return;
            if(!currentFrase||currentFrase.id!==s.frasi.id){
                currentFrase=s.frasi;navWordIdx=0;navCharIdx=0;fullSolutionText=currentFrase.soluzione;
                if(currentFrase.categoria==='SITUAZIONI QUOTIDIANE' && currentFrase.tema) {
                    currentHintText = "ARGOMENTO: " + currentFrase.tema;
                    currentPuzzleText = currentFrase.soluzione;
                } else if(fullSolutionText.includes(" - ")){const p=fullSolutionText.split(" - ");currentHintText=p[0].trim();currentPuzzleText=p[1].trim();}else{currentHintText="";currentPuzzleText=fullSolutionText;}
                
                let intro = `Categoria: ${currentFrase.categoria}. ${currentHintText}.`;
                if(s.fase_speciale > 0) intro += ` Round Situazioni Quotidiane.`;
                speak(intro);
                pendingMultiplier = 1; 
                vowelsBoughtThisTurn = 0; 
                wasMyTurn = false;
            }

            document.getElementById('round-indicator').textContent=`R ${s.round_giocati}/10`;

            const phase = s.vocali_speciali_chiamate || 0;
            const spInfo = document.getElementById('special-round-info');
            const spRules = document.getElementById('special-round-rules');
            const isMe = (s.id_giocatore_corrente===myIndex);
            
            // ALERT SUONO TURNO
            if(isMe && !wasMyTurn) {
                playAudio('snd-turn');
                // speak("Tocca a te!"); // Ridondante se c'√® il suono, ma utile
            }
            wasMyTurn = isMe;

            let canSpin = false, canSolve = false, canVowel = false, canFreeVowel = false, canPass = true, canManual = false;
            
            if(s.fase_speciale === 1) { 
                spInfo.classList.remove('hidden');
                if(phase === 0) { 
                    spRules.textContent = "GIRO 1: CONSONANTI (VALORE 50%)"; spRules.style.color = "#fff";
                    canSpin=true; canSolve=true; canVowel=false; 
                }
                else if(phase === 1) { 
                    spRules.textContent = "GIRO 2: CONSONANTI (VALORE 100%)"; spRules.style.color = "#fff";
                    canSpin=true; canSolve=true; canVowel=false; 
                }
                else if(phase === 2) { 
                    spRules.textContent = "GIRO 3: UNA VOCALE A TESTA (GRATIS)"; spRules.style.color = "#fff";
                    canFreeVowel=true; 
                    canPass=true; 
                    canSpin=false; 
                    canSolve=true; 
                } 
                else if(phase === 3) {
                    spRules.textContent = "ATTENDERE... AGGIUNTA VOCALI AUTOMATICA"; spRules.style.color = "#fff";
                    canSpin=false; canSolve=false; canPass=false; 
                }
                else if(phase >= 100) {
                    let chiamateFatte = phase - 100;
                    let rimasteTotali = 12 - chiamateFatte;
                    let numPlayers = s.giocatori.length;
                    
                    let testoFase = `GIRO 4: 12 CONSONANTI (${chiamateFatte}/12)`;
                    let alertMode = false;

                    if(rimasteTotali <= numPlayers && rimasteTotali > 0) {
                        testoFase += " - ULTIMA PER TE!";
                        alertMode = true;
                        if(s.azione_timestamp !== lastTimestamp) {
                            showFlashMessage("ULTIMA LETTERA PER TE!", "info");
                            speak("Attenzione. √à la tua ultima consonante.");
                        }
                    }

                    spRules.textContent = testoFase;
                    spRules.style.color = alertMode ? "#ff0000" : "#fff";

                    canSpin=false; canSolve=true; canVowel=false; canManual=true; 
                }
            } else {
                 spInfo.classList.add('hidden'); canSpin=true; canSolve=true; canVowel=true; canManual=true; 
            }

            if(!isMe || isSpinning || inputMode) { canSpin=false; canSolve=false; canVowel=false; canFreeVowel=false; canPass=false; canManual=false; }
            if(canSpin && s.montepremi_round > 0) canSpin = false;

            setBtnState('btn-spin', !canSpin); setBtnState('btn-solve', !canSolve); setBtnState('btn-pass', !canPass);
            document.getElementById('btn-free-vowel').classList.add('hidden');
            if(canFreeVowel) { document.getElementById('btn-free-vowel').classList.remove('hidden'); setBtnState('btn-vowel', true); } 
            else {
                 const me=s.giocatori.find(p=>p.indice===myIndex);
                 const currentCost = getDynamicVowelCost();
                 const hasMoney = (me && me.punteggio_round >= currentCost);
                 setBtnState('btn-vowel', !(canVowel && hasMoney));
            }
            if(canManual) document.getElementById('btn-manual-cons').classList.remove('hidden');
            else document.getElementById('btn-manual-cons').classList.add('hidden');

            if(s.azione_timestamp && s.azione_timestamp!==lastTimestamp){
                lastTimestamp=s.azione_timestamp;
                if(s.ultimo_messaggio) {
                     if(actionLog.length === 0 || actionLog[0].msg !== s.ultimo_messaggio) {
                         const time = new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                         actionLog.unshift({time: time, msg: s.ultimo_messaggio});
                         if(actionLog.length > 20) actionLog.pop();
                     }
                }
                showFlashMessage(s.ultimo_messaggio, (s.ultima_azione==='vittoria'?'good':(s.ultima_azione==='errore'?'bad':'info')));
                
                // Se non √® il MISTERO (che gestiamo a mano), leggi il messaggio
                if(!s.ultimo_messaggio.includes("MISTERO")) {
                    speak(s.ultimo_messaggio);
                }

                if(s.ultima_azione==='chiama_lettera' && s.ultimo_messaggio.includes("Trovate")){ playMultiHit((s.ultimo_messaggio.match(/\d+/)||['1'])[0]); }
                else if(s.ultima_azione==='errore') playAudio('snd-miss');
            }

            document.getElementById('live-category').textContent=currentFrase.categoria;
            document.getElementById('round-hint').textContent=currentHintText;
            document.getElementById('wheel-status-text').textContent=s.montepremi_round>0?`IN PALIO: ‚Ç¨${s.montepremi_round}`:"";
            parseAndRenderBoard(currentPuzzleText,s.lettere_rivelate);

            const cpName=s.giocatori.find(p=>p.indice===s.id_giocatore_corrente)?.nome||"Giocatore";
            document.getElementById('turn-indicator').textContent=isMe?"TOCCA A TE":`Turno di ${cpName}`;
            document.getElementById('turn-indicator').style.color=isMe?"#0f0":"#fff";
            const meObj=s.giocatori.find(p=>p.indice===myIndex);
            if(meObj){
                document.getElementById('score-round').textContent=meObj.punteggio_round;
                document.getElementById('score-total').textContent=meObj.punteggio_totale;
                const jCount = (meObj.jolly_scadenze && Array.isArray(meObj.jolly_scadenze)) ? meObj.jolly_scadenze.length : 0;
                document.getElementById('jolly-indicator').textContent = jCount > 0 ? ` JOLLY: ${jCount}` : "";
            }
        }

        function openActionHistory() {
            if(!actionLog || actionLog.length === 0) return speak("Nessuna azione nello storico.");
            const el = document.getElementById('inspector-overlay');
            const cnt = document.getElementById('inspector-content');
            let html = `<h2 style="color:#ffd700; border-bottom: 2px solid #fff; padding-bottom:10px;">ULTIME AZIONI</h2>`;
            actionLog.forEach((item, i) => {
                html += `<div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding: 10px 0;">
                            <span style="color:#888; font-size:0.8em;">${item.time}</span><br>
                            <span style="color:#fff;">${item.msg}</span>
                         </div>`;
            });
            html += `<button onclick="closeInspector()" class="action-btn" style="margin-top:20px;">CHIUDI (ESC)</button>`;
            cnt.innerHTML = html;
            el.classList.remove('hidden');
            cnt.focus();
            speak("Storico aperto.");
        }

        function parseAndRenderBoard(text,rev){
            rev=Array.isArray(rev)?rev:[];
            const c=document.getElementById('board-container');c.innerHTML='';parsedBoard=[];
            let gI=0;
            text.toUpperCase().split(' ').forEach(wS=>{
                let wO={str:wS,chars:[]};
                const r=document.createElement('div');r.className='board-row';
                for(let j=0;j<wS.length;j++){
                    const ch=wS[j];
                    const isL = ch.match(/[A-Z√Ä-√ô]/);
                    const isR = !isL || rev.includes(gI);
                    wO.chars.push({char:ch, isRevealed:isR, isLetter:!!isL});
                    const d=document.createElement('div');
                    let cls = 'tile';
                    if(isL) {
                        if(isR) cls += ' revealed';
                        else cls += ' empty';
                    } else {
                        cls += ' punct'; 
                    }
                    d.className = cls;
                    d.textContent = (isL && !isR) ? '' : ch;
                    d.id=`tile-${parsedBoard.length}-${j}`;
                    r.appendChild(d);
                    if(isL) gI++; 
                }
                r.id=`row-${parsedBoard.length}`;c.appendChild(r);parsedBoard.push(wO);
            });
            highlightNav();
        }

        function moveNav(d) {
            if (!parsedBoard.length) return;
            let currentW = parsedBoard[navWordIdx];
            let newCharIdx = navCharIdx + d;
            if (newCharIdx >= currentW.chars.length) { newCharIdx = currentW.chars.length - 1; } 
            else if (newCharIdx < 0) { newCharIdx = 0; }
            if(newCharIdx !== navCharIdx) { navCharIdx = newCharIdx; highlightNav(); readSingleChar(); } else { readSingleChar(); }
        }

        function moveWordNav(d) {
            if (!parsedBoard.length) return;
            let n = navWordIdx + d;
            if (n < 0) { n = 0; speak("Inizio frase."); } 
            else if (n >= parsedBoard.length) { n = parsedBoard.length - 1; speak("Fine frase."); } 
            else { navWordIdx = n; navCharIdx = 0; highlightNav(true); readWholeWord(); }
        }

        function getCharReadString(wordObj, cIdx) {
            const c = wordObj.chars[cIdx];
            const pos = (cIdx + 1) + " di " + wordObj.chars.length;
            if (c.isLetter && !c.isRevealed) return `Nascosta, ${pos}`;
            let speakChar = NATO[c.char] || c.char;
            if (!c.isLetter) speakChar = NATO[c.char] || "Simbolo " + c.char;
            return `${c.char}, ${speakChar}, ${pos}`;
        }
        function readSingleChar(){ const w = parsedBoard[navWordIdx]; speak(getCharReadString(w, navCharIdx)); }
        function readWholeWord(){
            const w = parsedBoard[navWordIdx]; let reading = "", missing = 0;
            w.chars.forEach(c => { if (c.isLetter && !c.isRevealed) { reading += " asterisco "; missing++; } else { reading += c.char; } });
            let info = `Parola ${navWordIdx + 1}, ${w.chars.length} lettere. `;
            if(missing === 0) info += reading; else if(missing === w.chars.length) info += "Tutta nascosta."; else info += reading;
            speak(info);
        }
        function readFullBoard(){ let f=`${currentFrase.categoria}. ${currentHintText}. `; parsedBoard.forEach((w,i)=>{let s="";w.chars.forEach(c=>s+=c.isRevealed?c.char:"_");f+=` P${i+1}: ${s}. `}); speak(f); }

        function highlightNav(wd=false){
            document.querySelectorAll('.cursor-char').forEach(e=>e.classList.remove('cursor-char'));
            document.querySelectorAll('.cursor-word').forEach(e=>e.classList.remove('cursor-word'));
            if(wd){ const r=document.getElementById(`row-${navWordIdx}`); if(r)r.classList.add('cursor-word'); }
            else{ const e=document.getElementById(`tile-${navWordIdx}-${navCharIdx}`); if(e)e.classList.add('cursor-char'); }
        }

        function openInspector() {
            if (!currentStanza || !parsedBoard.length) return speak("Nessuna frase attiva.");
            const el = document.getElementById('inspector-overlay');
            const cnt = document.getElementById('inspector-content');
            el.classList.remove('hidden');
            let html = `<h2 style="color:#ffd700; margin-bottom:20px;">RIEPILOGO FRASE (${parsedBoard.length} Parole)</h2>`;
            parsedBoard.forEach((w, i) => {
                let wordText = "";
                w.chars.forEach(c => { if (c.isLetter && !c.isRevealed) { wordText += "*"; } else { wordText += c.char; } });
                html += `<p style="margin: 15px 0; border-bottom: 1px solid #555; padding-bottom: 5px;"><span style="color:#00ff00;">Parola ${i + 1}:</span> <span style="color:#fff; font-weight:bold; font-size:1.2em; margin-left:10px;">${wordText}</span></p>`;
            });
            html += `<p style="color:#aaa; margin-top:20px;">Premi ESC per chiudere.</p>`;
            cnt.innerHTML = html; cnt.focus(); speak(`Ispettore aperto. ${parsedBoard.length} parole.`);
        }

        async function readRevealedLetters() {
            if (!currentStanza || !currentStanza.lettere_rivelate) return speak("Nessuna lettera svelata.");
            isReadingList = true;
            const sol = currentPuzzleText.toUpperCase();
            let revSet = new Set(), gIdx = 0;
            for (let i = 0; i < sol.length; i++) {
                if (sol[i].match(/[A-Z√Ä-√ô]/)) { if (currentStanza.lettere_rivelate.includes(gIdx)) { revSet.add(sol[i]); } gIdx++; }
            }
            const arr = Array.from(revSet).sort();
            if (arr.length === 0) return speak("Nessuna lettera presente scoperta.");
            speak(`Ci sono ${arr.length} lettere scoperte.`);
            await new Promise(r => setTimeout(r, 1500)); 
            for (const char of arr) {
                if(!isReadingList || inputMode) break; 
                const spell = NATO[char] || char; speak(`${char}, ${spell}`); await new Promise(r => setTimeout(r, 800)); 
            }
            isReadingList = false;
        }

        function showDialog(title, text, buttons) {
            const d = document.getElementById('dialog-generic');
            document.getElementById('dialog-title').textContent = title;
            document.getElementById('dialog-body').textContent = text;
            const acts = document.getElementById('dialog-actions');
            acts.innerHTML = '';
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.className = 'action-btn ' + b.cls;
                btn.textContent = b.text;
                btn.onclick = () => { d.classList.add('hidden'); b.action(); };
                acts.appendChild(btn);
            });
            d.classList.remove('hidden');
            speak(title + ". " + text);
            setTimeout(() => acts.firstChild.focus(), 100);
        }

        async function doSpin(isReSpin = false){
            if(!isReSpin && isBtnDisabled('btn-spin'))return;
            document.getElementById('wheel-status-text').focus();
            if(isReSpin) speak("La ruota gira da sola per il Raddoppia!");
            else speak("Gira...");
            playAudio('snd-spin');isSpinning=true;
            setBtnState('btn-spin',true);setBtnState('btn-solve',true);setBtnState('btn-vowel',true);
            wheelAngle+=(1000+Math.random()*500);document.getElementById('wheel-visual').style.transform=`rotate(${wheelAngle}deg)`;
            await new Promise(r=>setTimeout(r,3500));
            
            let v=WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
            const phase = currentStanza.vocali_speciali_chiamate || 0;
            if(typeof v === 'number' && currentStanza.fase_speciale > 0 && currentStanza.fase_speciale !== 10 && phase === 0) {
                v = Math.floor(v / 2); speak("Met√† prezzo! " + v);
            }
            
            if(v === 'MISTERO') {
                if(isReSpin) { v = 1000; } 
                else {
                    isSpinning = false;
                    showDialog("MISTERO!", "Vuoi tenere 500‚Ç¨ sicuri o aprire il Mistero?", [
                        { text: "TIENI 500‚Ç¨", cls: "btn-primary", action: () => handleMysteryOutcome('SAFE') },
                        { text: "APRI MISTERO", cls: "btn-special", action: () => handleMysteryOutcome('RISK') }
                    ]);
                    return;
                }
            }
            handleSpinResult(v);
        }

        async function handleMysteryOutcome(choice) {
            if(choice === 'SAFE') { handleSpinResult(500); } 
            else {
                // LOGICA SUSPENSE (Richiesta 4)
                speak("Apro la busta...");
                playAudio('snd-drum');
                await new Promise(r => setTimeout(r, 3000));

                const opts = ['RADDOPPIA', 'DIMEZZA', 'BANCAROTTA', 'PASSA', 'JOLLY', 'SCEGLI_AVVERSARIO'];
                const res = opts[Math.floor(Math.random() * opts.length)];
                speak("Il mistero contiene: " + res);
                await new Promise(r => setTimeout(r, 1500));
                
                if(res === 'RADDOPPIA') {
                    pendingMultiplier = 2; speak("Raddoppia attivo! Gira di nuovo!"); setTimeout(() => doSpin(true), 1000); return; 
                } else if (res === 'DIMEZZA') {
                     const me = currentStanza.giocatori.find(p=>p.id===myId);
                     const newScore = Math.floor((me.punteggio_round||0) / 2);
                     await supabase.from('giocatori').update({punteggio_round:newScore}).eq('id',myId);
                     handleSpinResult(500, "Dimezzato! ");
                } else if (res === 'SCEGLI_AVVERSARIO') { chooseOpponent(); } 
                else if (res === 'JOLLY') {
                    const me = currentStanza.giocatori.find(p=>p.id===myId);
                    let myJollys = (me.jolly_scadenze && Array.isArray(me.jolly_scadenze)) ? [...me.jolly_scadenze] : [];
                    const expiry = currentStanza.round_giocati + 4; 
                    myJollys.push(expiry);
                    await supabase.from('giocatori').update({jolly_scadenze:myJollys}).eq('id',myId);
                    handleSpinResult(500, "Hai vinto un JOLLY! Vale fino al round " + expiry + ". ");
                } else { handleSpinResult(res); }
            }
        }

        function chooseOpponent() {
            const others = currentStanza.giocatori.filter(p => p.id !== myId);
            if(others.length === 0) { speak("Sei solo. Passi il turno a te stesso."); passTurn(); } 
            else {
                const btns = others.map(p => ({
                    text: p.nome,
                    cls: 'btn-secondary',
                    action: async () => {
                         await supabase.from('stanze').update({id_giocatore_corrente: p.indice, ultima_azione:'timeout', ultimo_messaggio: `Turno ceduto a ${p.nome}`, azione_timestamp:new Date().toISOString()}).eq('id',roomId);
                         fetchFullState();
                    }
                }));
                showDialog("SCEGLI AVVERSARIO", "A chi passi la mano?", btns);
            }
        }

        async function handleSpinResult(v, prefixMsg="") {
            const myName=document.getElementById('inp-name').value;
            if (typeof v !== 'number' && pendingMultiplier > 1) { pendingMultiplier = 1; speak("Casella speciale! Raddoppia annullato."); await new Promise(r=>setTimeout(r,1500)); }
            if (v === 'BANCAROTTA' || v === 'PASSA') {
                const me = currentStanza.giocatori.find(p => p.id === myId);
                if(v === 'BANCAROTTA') playAudio('snd-bankrupt'); // SUONO BANCAROTTA
                
                const jollys = (me.jolly_scadenze && Array.isArray(me.jolly_scadenze)) ? me.jolly_scadenze : [];
                if (jollys.length > 0) {
                    isSpinning = false;
                    showDialog("USARE JOLLY?", `√à uscito ${v}. Hai ${jollys.length} Jolly. Usarne uno per salvarti?`, [
                        { text: "S√å, USA JOLLY", cls: "btn-primary", action: async () => {
                            let newJollys = [...jollys]; newJollys.sort((a,b)=>a-b); newJollys.shift(); 
                            await supabase.from('giocatori').update({jolly_scadenze:newJollys}).eq('id', myId);
                            speak("Jolly usato! Ti salvi."); setBtnState('btn-spin', false); fetchFullState();
                        }},
                        { text: "NO, SUBISCI", cls: "btn-danger", action: async () => { if(v==='BANCAROTTA') await supabase.from('giocatori').update({punteggio_round:0}).eq('id',myId); passTurn(); }}
                    ]);
                    return;
                }
            }
            isSpinning=false;
            let msg=`${prefixMsg}${myName} gira: ${v}`;
            if(typeof v==='number'&&v>=0){
                if(pendingMultiplier > 1) { v = v * pendingMultiplier; msg += ` (X${pendingMultiplier}!)`; }
                await supabase.from('stanze').update({montepremi_round:v,ultima_azione:'gira_ruota',ultimo_messaggio:msg,azione_timestamp:new Date().toISOString()}).eq('id',roomId);
                fetchFullState();setTimeout(()=>openInput('letter'),500);
            } else {
                if(v==='BANCAROTTA')await supabase.from('giocatori').update({punteggio_round:0}).eq('id',myId);
                await passTurn();
            }
        }

        function clearInput(){document.getElementById('game-input').value="";document.getElementById('game-input').focus();speak("Svuotato");}
        function openInput(m){
            const me=currentStanza.giocatori.find(p=>p.id===myId);
            const dynamicCost = getDynamicVowelCost();
            if(m==='vowel') {
                if(!document.getElementById('btn-free-vowel').checkVisibility()){
                     if((me.punteggio_round||0)<dynamicCost) return speak(`Servono ${dynamicCost} euro.`);
                     if(vowelsBoughtThisTurn >= 1) return speak("Hai gi√† comprato una vocale in questo giro. Gira la ruota o rispondi.");
                     speak(`Costo vocale: ${dynamicCost} euro. Inserisci vocale.`);
                }
            }
            lastFocusedElement=document.activeElement;inputMode=m; isReadingList=false;
            document.getElementById('input-area').classList.remove('hidden');
            const inp=document.getElementById('game-input');inp.value='';
            if(m==='solve'){
                let prefill="",gI=0,txt=currentPuzzleText.toUpperCase();
                for(let i=0;i<txt.length;i++){
                    const c=txt[i];
                    if(c.match(/[A-Z√Ä-√ô]/)){ prefill+=currentStanza.lettere_rivelate.includes(gI)?c:"*"; gI++; }
                    else prefill+=c; 
                }
                inp.value=prefill;speak("Scrivi sugli asterischi.");
            }else if(m==='vowel_free'){
                document.getElementById('input-title').textContent="VOCALE GRATIS";
                speak("Inserisci vocale gratis.");
            }else if(m!=='vowel') document.getElementById('input-title').textContent="CONSONANTE"; 
            else document.getElementById('input-title').textContent=`VOCALE (${dynamicCost}‚Ç¨)`; 
            setTimeout(()=>{inp.focus();if(m==='solve')inp.setSelectionRange(0,0);},100);
        }
        function closeInput(){document.getElementById('input-area').classList.add('hidden');inputMode=null;if(lastFocusedElement)lastFocusedElement.focus();}

        async function submitInput(){
            if(isProcessingInput)return;isProcessingInput=true;
            const t=document.getElementById('game-input').value.trim().toUpperCase();
            if(!t){isProcessingInput=false;return;}
            const m=inputMode,c=t.charAt(0),isV=VOWELS_LIST.includes(c);
            
            if(m!=='solve' && !t.match(/^[A-Z√Ä-√ô]$/)){speak("Lettera non valida");isProcessingInput=false;return;}
            if(m==='letter'&&isV){speak("Serve consonante");isProcessingInput=false;return;}
            if((m==='vowel'||m==='vowel_free')&&!isV){speak("Serve vocale");isProcessingInput=false;return;}

            const n=(myIndex+1)%currentStanza.giocatori.length,myName=document.getElementById('inp-name').value;
            const isLastPlayerOfLap = (myIndex === currentStanza.giocatori[currentStanza.giocatori.length - 1].indice);
            
            if(m==='solve'){
                closeInput();
                if(cleanStr(t)===cleanStr(currentPuzzleText)){
                    const me=currentStanza.giocatori.find(p=>p.id===myId);
                    let base=me.punteggio_round||0, bonus=base<1000?1000:(base<2000?700:400);
                    if(currentStanza.fase_speciale > 0) { base=0; bonus=1000; } 
                    await supabase.from('giocatori').update({punteggio_totale:(me.punteggio_totale||0)+base+bonus,punteggio_round:0}).eq('id',myId);
                    const sol=currentPuzzleText.toUpperCase();let allIdx=[],gIdx=0;for(let i=0;i<sol.length;i++){if(sol[i].match(/[A-Z√Ä-√ô]/)){allIdx.push(gIdx);gIdx++;}}
                    await supabase.from('stanze').update({stato:'finito', ultima_azione:'vittoria', ultimo_messaggio:`${myName} VINCE!`, lettere_rivelate:allIdx, azione_timestamp:new Date().toISOString()}).eq('id',roomId);
                }else{
                    let nextPhase = currentStanza.vocali_speciali_chiamate || 0;
                    await supabase.from('stanze').update({
                        id_giocatore_corrente:n, 
                        vocali_speciali_chiamate: nextPhase,
                        ultima_azione:'errore', 
                        ultimo_messaggio:`${myName}: Errato.`, 
                        montepremi_round:0, 
                        azione_timestamp:new Date().toISOString()
                    }).eq('id',roomId);
                }
            } else {
                closeInput(); 

                const me=currentStanza.giocatori.find(p=>p.id===myId);
                
                // SE E' UNA VOCALE, SCALO I SOLDI PRIMA DI CONTROLLARE SE E' GIA' STATA DETTA
                if(m==='vowel') {
                    const dynamicCost = getDynamicVowelCost();
                    await supabase.from('giocatori').update({punteggio_round: (me.punteggio_round || 0) - dynamicCost}).eq('id', myId);
                    vowelsBoughtThisTurn++;
                }

                // CONTROLLO LETTERA GIA' CHIAMATA (PENALITA')
                const oc=currentStanza.lettere_chiamate||[];
                if(oc.some(k=>cleanStr(k)===cleanStr(c))) {
                    let nextPhase = currentStanza.vocali_speciali_chiamate || 0;
                    await supabase.from('stanze').update({
                        id_giocatore_corrente:n, 
                        vocali_speciali_chiamate: nextPhase,
                        ultima_azione:'errore', 
                        ultimo_messaggio:`${myName}: ${c} gi√† detta!`, 
                        montepremi_round:0, 
                        azione_timestamp:new Date().toISOString()
                    }).eq('id',roomId);
                    isProcessingInput=false;
                    return; 
                }

                const sol=currentPuzzleText.toUpperCase();let fd=[],gI=0;
                for(let i=0;i<sol.length;i++){if(sol[i].match(/[A-Z√Ä-√ô]/)){if(cleanStr(sol[i])===cleanStr(c))fd.push(gI);gI++;}}
                
                let currentPhase = currentStanza.vocali_speciali_chiamate || 0;
                let nextPhase = currentPhase;
                let autoVowelsTrigger = false;
                let nullRoundTrigger = false;

                if(currentStanza.fase_speciale === 1) {
                    if(currentPhase === 0 || currentPhase === 1) { if(isLastPlayerOfLap) nextPhase++; }
                    else if(currentPhase === 2) { if(isLastPlayerOfLap) autoVowelsTrigger = true; }
                    else if(currentPhase >= 100) { nextPhase = currentPhase + 1; if(nextPhase >= 112) nullRoundTrigger = true; }
                }

                const nc=[...new Set([...oc,c])];
                    
                if(fd.length>0){
                    if(m==='letter') {
                         if(currentPhase < 100 && currentPhase !== 2) {
                             let val = currentStanza.montepremi_round;
                             if(currentStanza.fase_speciale === 1 && currentPhase === 0) val = Math.floor(val/2);
                             let gain = (val * fd.length);
                             await supabase.from('giocatori').update({punteggio_round:(me.punteggio_round||0)+gain}).eq('id',myId);
                         }
                         vowelsBoughtThisTurn = 0; 
                    }
                    const newRev=[...new Set([...(currentStanza.lettere_rivelate||[]),...fd])];
                    await supabase.from('stanze').update({
                        lettere_rivelate:newRev, 
                        lettere_chiamate:nc, 
                        id_giocatore_corrente: currentStanza.id_giocatore_corrente, // Resta il giocatore
                        ultima_azione:'chiama_lettera', 
                        ultimo_messaggio:`${myName}: Trovate ${fd.length} ${c}`, 
                        montepremi_round:0, 
                        vocali_speciali_chiamate: nextPhase, 
                        azione_timestamp:new Date().toISOString()
                    }).eq('id',roomId);
                } else {
                    pendingMultiplier = 1;
                    await supabase.from('stanze').update({
                        lettere_chiamate:nc, 
                        id_giocatore_corrente: n,
                        ultima_azione:'chiama_lettera', 
                        ultimo_messaggio:`${myName}: ${c} non c'√®`, 
                        montepremi_round:0, 
                        vocali_speciali_chiamate: nextPhase, 
                        azione_timestamp:new Date().toISOString()
                    }).eq('id',roomId);
                }
                
                if(autoVowelsTrigger) { setTimeout(() => giveAutomaticVowels(currentStanza), 500); }
                if(nullRoundTrigger) {
                     setTimeout(async () => {
                         await supabase.from('stanze').update({
                             ultimo_messaggio: "CONSONANTI FINITE! CHI RISOLVE?",
                             ultima_azione: 'info',
                             azione_timestamp: new Date().toISOString()
                         }).eq('id', roomId);
                     }, 1000);
                }
            }
            pendingMultiplier = 1;
            isProcessingInput=false; fetchFullState();
        }

        async function startNewRound(){
            if(!isHost) return speak("Solo l'host pu√≤.");
            let s = currentStanza;
            let nextRoundIdx = s.round_giocati; 
            let nextBufferIdx = s.indice_buffer;
            let nextBuffer = s.buffer_frasi_speciali || []; 
            let nextFaseSpeciale = 0; 
            
            if(s.stato === 'finito' && nextBuffer.length > 0 && nextBufferIdx < nextBuffer.length - 1) {
                nextBufferIdx++;
                nextFaseSpeciale = 1; 
                await supabase.from('giocatori').update({punteggio_round:0}).eq('stanza_id',roomId);
                await supabase.from('stanze').update({
                    frase_corrente_id: nextBuffer[nextBufferIdx], stato: 'gioco',
                    lettere_rivelate: [], lettere_chiamate: [], montepremi_round: 0,
                    indice_buffer: nextBufferIdx, 
                    fase_speciale: nextFaseSpeciale, 
                    vocali_speciali_chiamate: 0, 
                    ultima_azione: 'nuovo', ultimo_messaggio: `Frase ${nextBufferIdx+1} di 4`,
                    azione_timestamp: new Date().toISOString()
                }).eq('id', roomId); 
                fetchFullState(); return;
            }

            nextRoundIdx++;
            if(nextRoundIdx > 10) { await supabase.from('stanze').update({stato:'terminata'}).eq('id',roomId); return; }

            const {data: allPlayers} = await supabase.from('giocatori').select('*').eq('stanza_id', roomId);
            if(allPlayers) {
                for (const p of allPlayers) {
                    if(p.jolly_scadenze && Array.isArray(p.jolly_scadenze) && p.jolly_scadenze.length > 0) {
                        const validJollys = p.jolly_scadenze.filter(expiryRound => expiryRound >= nextRoundIdx);
                        if(validJollys.length !== p.jolly_scadenze.length) {
                             await supabase.from('giocatori').update({jolly_scadenze: validJollys}).eq('id', p.id);
                        }
                    }
                }
            }

            let nextFraseId = null, newBuffer = [], newFase = 0;

            if([4, 7, 10].includes(nextRoundIdx)) {
                const {data: temi} = await supabase.from('frasi').select('tema').eq('categoria', 'SITUAZIONI QUOTIDIANE');
                if(temi && temi.length){
                    const uniqueTemi = [...new Set(temi.map(i => i.tema))];
                    const randomTema = uniqueTemi[Math.floor(Math.random() * uniqueTemi.length)];
                    const {data: frasiSet} = await supabase.from('frasi').select('id').eq('categoria', 'SITUAZIONI QUOTIDIANE').eq('tema', randomTema).limit(4);
                    if(frasiSet && frasiSet.length === 4) { 
                        newBuffer = frasiSet.map(f => f.id); nextFraseId = newBuffer[0]; newFase = 1; 
                    }
                }
            } 
            
            if(!nextFraseId) {
                const {data:fr}=await supabase.from('frasi').select('id').neq('categoria','SITUAZIONI QUOTIDIANE').neq('categoria','FILO CONDUTTORE');
                nextFraseId=fr[Math.floor(Math.random()*fr.length)].id;
            }

            await supabase.from('giocatori').update({punteggio_round:0}).eq('stanza_id',roomId);
            await supabase.from('stanze').update({
                frase_corrente_id: nextFraseId, stato: 'gioco', round_giocati: nextRoundIdx,
                buffer_frasi_speciali: newBuffer, indice_buffer: 0, 
                fase_speciale: newFase, 
                vocali_speciali_chiamate: 0, 
                lettere_rivelate: [], lettere_chiamate: [], montepremi_round: 0,
                ultima_azione: 'nuovo', ultimo_messaggio: `Round ${nextRoundIdx}`,
                azione_timestamp: new Date().toISOString()
            }).eq('id', roomId); 
            fetchFullState();
        }
        
        document.getElementById('game-input').addEventListener('keydown',function(e){if(inputMode!=='solve'||e.key.length>1)return;const p=this.selectionStart,v=this.value;if(v[p]==='*'&&e.key.match(/^[a-zA-Z√†-√π0-9]$/i)){e.preventDefault();this.value=v.substring(0,p)+e.key.toUpperCase()+v.substring(p+1);this.setSelectionRange(p+1,p+1);}});
        
        document.addEventListener('keydown', e => {
            if (!e.key) return;
            const k = e.key.toLowerCase();
            const ia = document.activeElement.tagName === 'INPUT';
            const isInspectorOpen = !document.getElementById('inspector-overlay').classList.contains('hidden');
            const isDialogGenericOpen = !document.getElementById('dialog-generic').classList.contains('hidden');

            if (e.ctrlKey && k === 'l') { e.preventDefault(); readRevealedLetters(); return; }
            if (e.ctrlKey && k === 'i') { e.preventDefault(); openInspector(); return; }
            if (e.ctrlKey && k === 'r') { e.preventDefault(); readFullBoard(); return; }
            if (e.ctrlKey && k === 'c') { e.preventDefault(); toggleContrast(); return; }
            
            if (k === 'a' || (e.ctrlKey && k === 'a')) { e.preventDefault(); openActionHistory(); return; }
            
            // TASTI RAPIDI EMOTE
            if (k === '1') { playAudio('snd-clap'); return; }
            if (k === '2') { playAudio('snd-laugh'); return; }
            if (k === '3') { playAudio('snd-boo'); return; }
            if (k === '4') { playAudio('snd-ooh'); return; }

            if (ia) {
                if (k === 'enter') submitInput();
                if (k === 'escape') closeInput();
                return;
            }
            if (isInspectorOpen) { if (k === 'escape') closeInspector(); return; }
            if (isDialogGenericOpen) return; 

            if (!inputMode) {
                if (k === 'g' || (e.ctrlKey && k === 'g')) { e.preventDefault(); doSpin(); return; }
                if (k === 'v' || (e.ctrlKey && k === 'v')) { e.preventDefault(); openInput('vowel'); return; }
                if (k === 's' || (e.ctrlKey && k === 's')) { e.preventDefault(); openInput('solve'); return; }
                if (k === 'p' || (e.ctrlKey && k === 'p')) { e.preventDefault(); passTurn(); return; }
                
                if (k === 'l') { e.preventDefault(); readRevealedLetters(); return; }
                if (k === 'i') { e.preventDefault(); openInspector(); return; }
                if (k === 'r') { e.preventDefault(); readFullBoard(); return; } 
                if (k === 'c') { e.preventDefault(); toggleContrast(); return; } 
                
                if (k === 'arrowright') { e.preventDefault(); moveNav(1); }
                if (k === 'arrowleft') { e.preventDefault(); moveNav(-1); }
                if (k === 'arrowup') { e.preventDefault(); moveWordNav(-1); }
                if (k === 'arrowdown') { e.preventDefault(); moveWordNav(1); }
                
                if (k === 'enter' && !document.getElementById('round-over-panel').classList.contains('hidden')) { e.preventDefault(); startNewRound(); return; }
                
                if (k === ' ') { e.preventDefault(); readSingleChar(); }
                if (k === 'escape') { e.preventDefault(); if(document.getElementById('privacy-dialog').classList.contains('hidden') === false) document.getElementById('privacy-dialog').classList.add('hidden'); }
            }
        });

        function closeInspector() {
            document.getElementById('inspector-overlay').classList.add('hidden');
            if (lastFocusedElement) lastFocusedElement.focus();
        }
    </script>
</body>
</html>