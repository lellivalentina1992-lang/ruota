<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - Accessibile V6</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* STILE BASE ALTO CONTRASTO */
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0; padding: 10px;
        }
        
        /* FOCUS VISIBILE E FORTE */
        *:focus {
            outline: 4px solid #ffd700 !important;
            outline-offset: 2px;
            background-color: #333;
        }

        h1 { color: #ffd700; font-size: 1.4em; margin: 10px 0; text-align: center; }
        
        .container { max-width: 800px; margin: 0 auto; }

        /* SETUP PANEL */
        #setup-panel { padding: 20px; background: #222; border: 1px solid #444; }
        #setup-panel input, #setup-panel button {
            display: block; width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1.1em;
        }
        
        /* STATUS BAR */
        .status-bar {
            background: #222; padding: 10px; margin-bottom: 15px; border: 1px solid #444;
            font-size: 1.1em; text-align: center;
        }
        .turn-active { 
            color: #00ff00; font-weight: bold; border: 2px solid #00ff00; 
            padding: 10px; display:block; background: #001100;
        }
        
        /* RUOTA BOX */
        #wheel-status {
            background: #000; border: 3px solid #ffd700; color: #ffd700;
            padding: 20px; text-align: center; font-size: 1.5em; font-weight: bold; margin-bottom: 20px;
        }

        /* TABELLONE NAVIGABILE */
        #board-navigator {
            background: #000; border: 2px dashed #666; padding: 20px; margin: 15px 0;
            color: #fff; font-family: monospace; font-size: 1.2em; cursor: pointer;
            position: relative; min-height: 50px;
        }
        /* Testo visivo per ipovedenti, nascosto a screen reader per evitare lettura "trattino trattino" */
        #visual-board-content {
            opacity: 0.8; font-weight: bold; letter-spacing: 2px;
        }

        /* INPUT POPUP (MODALE) */
        #input-area {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; padding: 20px;
            box-sizing: border-box;
        }
        #input-area label { font-size: 1.5em; color: #ffd700; margin-bottom: 20px; }
        #game-input { font-size: 2em; padding: 10px; margin-bottom: 20px; text-transform: uppercase; }
        .modal-btns button { width: 100%; padding: 20px; font-size: 1.2em; margin-bottom: 10px; cursor: pointer; font-weight: bold; }

        /* BOTTONI AZIONE */
        .action-btn {
            width: 100%; padding: 20px; margin-bottom: 10px; font-size: 1.2em; font-weight: bold;
            background: #444; color: #fff; border: none; cursor: pointer; text-align: left;
            border-left: 5px solid transparent;
        }
        .action-btn:hover { background: #555; }
        .action-btn:focus { border-left: 5px solid #ffd700; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #222; color: #777; }

        /* UTILS */
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<div id="inspector-overlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:2000; padding:20px; overflow:auto;">
    <h2 style="color:#ffd700">Modalità Lettura</h2>
    <div id="inspector-text" tabindex="-1" style="font-size:1.4em; line-height:1.5; color:#fff;"></div>
    <button onclick="closeInspector()" style="margin-top:20px; padding:20px; width:100%; font-size:1.2em; background:#333; color:white;">CHIUDI (ESC)</button>
</div>

<div class="container">
    <h1>LA RUOTA V6</h1>

    <div id="setup-panel">
        <label for="inp-name">Tuo Nome:</label>
        <input id="inp-name" type="text" placeholder="Nome">
        <label for="inp-code">Codice Stanza:</label>
        <input id="inp-code" type="text" placeholder="Es. CASA">
        <button onclick="joinGame(true)" style="background:#ffd700; color:black;">Crea Stanza</button>
        <button onclick="joinGame(false)" style="background:#444; color:white;">Entra in Stanza</button>
    </div>

    <div id="game-panel" class="hidden">
        
        <div class="status-bar">
            <div id="turn-indicator">In attesa...</div>
            <div id="my-score" style="margin-top:10px;">Tu: €0</div>
        </div>

        <div id="wheel-status" role="status" aria-live="polite">Ruota ferma</div>

        <h2 style="color:#4caf50; margin-top:20px;">TABELLONE</h2>
        <div id="category-display" style="font-style:italic; margin-bottom:10px;">Categoria: —</div>
        
        <div id="board-navigator" tabindex="0" role="application" aria-label="Tabellone. Usa le frecce per leggere. Premi ESC per uscire.">
            <div id="visual-board-content" aria-hidden="true">
                (In attesa...)
            </div>
        </div>
        <div style="font-size:0.9em; color:#aaa; margin-bottom:20px;">
            SU/GIÙ: Salta Parola | DX/SX: Lettera | CTRL+I: Testo puro
        </div>

        <h2>AZIONI</h2>
        <button id="btn-spin" class="action-btn" onclick="doSpin()">1. GIRA RUOTA (Ctrl+G)</button>
        <button id="btn-vowel" class="action-btn" onclick="openInput('vowel')">2. VOCALE €500 (Ctrl+V)</button>
        <button id="btn-solve" class="action-btn" onclick="openInput('solve')">3. RISOLVI (Ctrl+S)</button>

        <div style="margin-top:30px; border-top:1px solid #555; padding-top:10px;">
            <h3>Giocatori:</h3>
            <ul id="player-list" style="list-style:none; padding:0;"></ul>
        </div>

        <div id="host-controls" class="hidden" style="margin-top:20px;">
            <button onclick="startNewRound()" style="width:100%; padding:15px; background:#550000; color:fff;">[HOST] NUOVO ROUND</button>
        </div>
    </div>
</div>

<div id="input-area" class="hidden">
    <label id="input-label" for="game-input">Inserisci:</label>
    <input id="game-input" type="text" autocomplete="off">
    <div class="modal-btns">
        <button onclick="submitInput()" style="background:#00ff00; color:#000;">CONFERMA (Invio)</button>
        <button onclick="closeInput()" style="background:#ccc; color:#000;">ANNULLA (Esc)</button>
    </div>
</div>

<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>

<script>
    // --- CONFIGURAZIONE SUPABASE ---
    const supabase = window.supabase.createClient(
        'https://azcwkpdjbysnivknnino.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU'
    );
    
    const WHEEL_VALUES = [100, 200, 300, 400, 500, 1000, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO'];

    // STATO GLOBALE
    let myId, myRoomId, myIndex, isHost = false;
    let roomState = {};
    let currentSolution = "";
    let currentRevealed = [];
    let inputMode = null; // 'letter', 'vowel', 'solve'
    let isSpinning = false;
    
    // NAVIGAZIONE TABELLONE
    let navWordIdx = 0;
    let navCharIdx = 0;
    let parsedBoard = [];

    // UTILS
    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = '';
        setTimeout(() => { el.textContent = text; }, 50);
        console.log("SPEAK:", text);
    }
    
    function play(id) {
        const audio = document.getElementById(id);
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.warn("Audio play fallito:", e));
        }
    }

    // --- LOGICA TABELLONE ---
    function parseBoardData() {
        parsedBoard = [];
        if (!currentSolution) return;
        const rawWords = currentSolution.split(' ');
        let globalIndex = 0;

        rawWords.forEach((w) => {
            let wordObj = { wordStr: w, chars: [] };
            for (let i = 0; i < w.length; i++) {
                const char = w[i];
                const isRev = currentRevealed.includes(globalIndex);
                wordObj.chars.push({
                    realChar: char,
                    displayChar: isRev ? char : '_',
                    isRevealed: isRev
                });
                globalIndex++;
            }
            parsedBoard.push(wordObj);
            globalIndex++; // Spazio
        });
        updateVisual();
    }

    function updateVisual() {
        const vis = document.getElementById('visual-board-content');
        if(parsedBoard.length === 0) {
            vis.textContent = "(Nessuna frase)";
            return;
        }
        vis.textContent = parsedBoard.map(w => w.chars.map(c => c.displayChar).join(' ')).join('   /   ');
    }

    // --- NAVIGAZIONE FOCUS (TABELLONE) ---
    document.getElementById('board-navigator').addEventListener('keydown', (e) => {
        // GESTIONE ESC SPECIFICA
        if (e.key === 'Escape') {
            e.preventDefault();
            document.getElementById('btn-spin').focus();
            speak("Focus su azioni.");
            return;
        }

        if (e.ctrlKey) return; // Lascia passare le scorciatoie globali

        if (parsedBoard.length === 0) return;
        let handled = false;

        if (e.key === 'ArrowRight') {
            moveNextChar(); handled = true;
        } else if (e.key === 'ArrowLeft') {
            movePrevChar(); handled = true;
        } else if (e.key === 'ArrowDown') {
            jumpNextWord(); handled = true;
        } else if (e.key === 'ArrowUp') {
            jumpPrevWord(); handled = true;
        }

        if (handled) {
            e.preventDefault();
            announcePos();
        }
    });

    function moveNextChar() {
        navCharIdx++;
        let wLen = parsedBoard[navWordIdx].chars.length;
        if (navCharIdx >= wLen) {
            if (navWordIdx < parsedBoard.length - 1) {
                navWordIdx++; navCharIdx = 0;
            } else {
                navCharIdx = wLen - 1; speak("Fine frase");
            }
        }
    }
    function movePrevChar() {
        navCharIdx--;
        if (navCharIdx < 0) {
            if (navWordIdx > 0) {
                navWordIdx--; navCharIdx = parsedBoard[navWordIdx].chars.length - 1;
            } else {
                navCharIdx = 0; speak("Inizio frase");
            }
        }
    }
    function jumpNextWord() {
        if (navWordIdx < parsedBoard.length - 1) {
            navWordIdx++; navCharIdx = 0;
        } else { speak("Ultima parola"); }
    }
    function jumpPrevWord() {
        if (navWordIdx > 0) {
            navWordIdx--; navCharIdx = 0;
        } else { speak("Prima parola"); }
    }

    function announcePos() {
        const w = parsedBoard[navWordIdx];
        const c = w.chars[navCharIdx];
        let msg = "";
        if (navCharIdx === 0) msg += `Parola ${navWordIdx + 1}. `;
        let charAudio = c.isRevealed ? c.realChar : "Nascosta";
        msg += `${charAudio}, ${navCharIdx + 1} di ${w.chars.length}`;
        speak(msg);
    }

    // --- TASTI GLOBALI ---
    document.addEventListener('keydown', (e) => {
        // DEBUG LOG
        if(e.key === 'Control' || e.key === 'g') console.log("Tasto premuto:", e.key, "Ctrl:", e.ctrlKey, "InputMode:", inputMode);

        // CTRL+I Inspector
        if (e.ctrlKey && (e.key === 'i' || e.key === 'I')) {
            e.preventDefault(); openInspector(); return;
        }
        
        // ESC GENERICO
        if (e.key === 'Escape') {
            if(inputMode) closeInput();
            closeInspector();
            document.getElementById('btn-spin').focus();
            return;
        }

        // SCORCIATOIE GIOCO
        // Funzionano solo se non sto scrivendo (inputMode null) e sono nel gioco
        if (inputMode === null && !document.getElementById('game-panel').classList.contains('hidden')) {
            
            // Controllo turno per feedback
            const isMyTurn = (roomState.id_giocatore_corrente === myIndex && roomState.stato === 'gioco');

            if (e.ctrlKey && (e.key === 'g' || e.key === 'G')) { 
                e.preventDefault(); 
                if(isMyTurn) doSpin(); 
                else speak("Non è il tuo turno");
            }
            if (e.ctrlKey && (e.key === 'v' || e.key === 'V')) { 
                e.preventDefault(); 
                if(isMyTurn) openInput('vowel');
                else speak("Non è il tuo turno");
            }
            if (e.ctrlKey && (e.key === 's' || e.key === 'S')) { 
                e.preventDefault(); 
                if(isMyTurn) openInput('solve');
                else speak("Non è il tuo turno");
            }
        }
    });

    // --- ISPETTORE TESTUALE ---
    function openInspector() {
        const ov = document.getElementById('inspector-overlay');
        const txt = document.getElementById('inspector-text');
        let html = `<p>Categoria: ${document.getElementById('category-display').textContent}</p>`;
        if (parsedBoard.length === 0) html += "<p>Vuoto.</p>";
        else {
            parsedBoard.forEach((w, i) => {
                let s = w.chars.map(c => c.isRevealed ? c.realChar : "-").join("");
                html += `<p>Parola ${i+1}: ${s}</p>`;
            });
        }
        txt.innerHTML = html;
        ov.classList.remove('hidden');
        txt.focus();
    }
    function closeInspector() {
        document.getElementById('inspector-overlay').classList.add('hidden');
        document.getElementById('btn-spin').focus();
    }

    // --- SUPABASE ---
    async function joinGame(create) {
        const name = document.getElementById('inp-name').value.trim().toUpperCase();
        const code = document.getElementById('inp-code').value.trim().toUpperCase();
        if(!name || !code) return speak("Inserisci nome e codice");
        
        let rId;
        if(create) {
            const {data, error} = await supabase.from('stanze').insert({codice:code, stato:'attesa'}).select().single();
            if(error) return speak("Errore creazione stanza (codice usato?)");
            rId = data.id; isHost = true;
        } else {
            const {data} = await supabase.from('stanze').select('*').eq('codice',code).maybeSingle();
            if(!data) return speak("Stanza non trovata");
            rId = data.id;
        }
        myRoomId = rId;

        const {data:exist} = await supabase.from('giocatori').select('*').eq('stanza_id',rId).eq('nome',name).maybeSingle();
        if(exist) {
            myId=exist.id; myIndex=exist.indice; isHost=exist.is_host;
            speak("Bentornato " + name);
        } else {
            const {count} = await supabase.from('giocatori').select('*',{count:'exact', head:true}).eq('stanza_id',rId);
            const {data:neu} = await supabase.from('giocatori').insert({stanza_id:rId, nome:name, indice:count||0, is_host:isHost}).select().single();
            myId=neu.id; myIndex=neu.indice;
            speak("Sei entrato come " + name);
        }
        
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('game-panel').classList.remove('hidden');
        if(isHost) document.getElementById('host-controls').classList.remove('hidden');
        
        // Focus iniziale sul pulsante di gioco
        document.getElementById('btn-spin').focus();
        
        startSync();
    }

    function startSync() {
        supabase.channel('room').on('postgres_changes',{event:'*',schema:'public',table:'stanze',filter:'id=eq.'+myRoomId}, p=>updateRoom(p.new)).subscribe();
        supabase.channel('players').on('postgres_changes',{event:'*',schema:'public',table:'giocatori',filter:'stanza_id=eq.'+myRoomId}, updatePlayers).subscribe();
        supabase.from('stanze').select('*').eq('id',myRoomId).single().then(r=>updateRoom(r.data));
        updatePlayers();
    }

    async function updateRoom(data) {
        roomState = data;
        
        // Turno
        const isMyTurn = (data.id_giocatore_corrente === myIndex);
        const ti = document.getElementById('turn-indicator');
        if(isMyTurn) {
            ti.textContent = "È IL TUO TURNO!";
            ti.className = 'turn-active';
            ['btn-spin','btn-vowel','btn-solve'].forEach(id=>document.getElementById(id).disabled=false);
        } else {
            ti.textContent = `Turno di Giocatore ${data.id_giocatore_corrente}`;
            ti.className = '';
            ['btn-spin','btn-vowel','btn-solve'].forEach(id=>document.getElementById(id).disabled=true);
        }

        // Ruota
        const w = document.getElementById('wheel-status');
        w.textContent = data.montepremi_round > 0 ? `VALORE ATTIVO: €${data.montepremi_round}` : "Ruota Ferma";

        // Frase
        if(data.frase_corrente_id) {
            if(!currentSolution || data.stato === 'attesa') {
                const {data:f} = await supabase.from('frasi').select('*').eq('id',data.frase_corrente_id).single();
                if(f) {
                    currentSolution = f.soluzione.toUpperCase();
                    document.getElementById('category-display').textContent = "Categoria: "+f.categoria;
                }
            }
            currentRevealed = data.lettere_rivelate || [];
            parseBoardData();
        }

        // Auto-apertura input se ho girato la ruota
        if(isMyTurn && data.montepremi_round > 0 && !inputMode && !isSpinning) {
            openInput('letter');
        }
    }

    async function updatePlayers() {
        const {data} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        data.forEach(p => {
            const li = document.createElement('li');
            li.textContent = `${p.nome}: €${p.punteggio_totale}`;
            if(p.indice === roomState.id_giocatore_corrente) li.style.color='#00ff00';
            if(p.id === myId) document.getElementById('my-score').textContent = `Tu: €${p.punteggio_totale}`;
            list.appendChild(li);
        });
    }

    // --- AZIONI DI GIOCO ---
    function doSpin() {
        if(isSpinning) return;
        isSpinning = true;
        play('snd-spin');
        speak("La ruota gira...");
        document.getElementById('wheel-status').textContent = "GIRANDO...";
        
        setTimeout(async () => {
            isSpinning = false;
            const val = WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
            
            if(val === 'BANCAROTTA') {
                speak("Bancarotta!");
                await supabase.from('giocatori').update({punteggio_totale:0}).eq('id',myId);
                passTurn();
            } else if (val === 'PASSA') {
                speak("Passa la mano");
                passTurn();
            } else if (val === 'MISTERO') {
                speak("Mistero... ma non succede nulla");
                passTurn();
            } else {
                speak(`Valore ${val} euro. Chiama consonante.`);
                await supabase.from('stanze').update({montepremi_round:val}).eq('id',myRoomId);
            }
        }, 3000);
    }

    function openInput(mode) {
        inputMode = mode; // Imposta modalità
        const area = document.getElementById('input-area');
        const lbl = document.getElementById('input-label');
        const inp = document.getElementById('game-input');
        
        area.classList.remove('hidden');
        inp.value = '';
        inp.focus();

        if(mode==='letter') lbl.textContent = `Consonante per €${roomState.montepremi_round}:`;
        if(mode==='vowel') lbl.textContent = "Vocale (€500):";
        if(mode==='solve') lbl.textContent = "Soluzione Completa:";
    }

    function closeInput() {
        document.getElementById('input-area').classList.add('hidden');
        inputMode = null;
        document.getElementById('btn-spin').focus();
    }

    async function submitInput() {
        const txt = document.getElementById('game-input').value.toUpperCase().trim();
        if(!txt) return;
        
        // SALVA IL MODO PRIMA DI RESETTARE
        const currentMode = inputMode; 
        
        // Chiudi UI
        document.getElementById('input-area').classList.add('hidden');
        inputMode = null;
        document.getElementById('btn-spin').focus();

        // LOGICA RISOLVI
        if(currentMode === 'solve') {
            const cleanSol = currentSolution.replace(/[^A-Z]/g,'');
            const cleanInp = txt.replace(/[^A-Z]/g,'');
            if(cleanSol === cleanInp) {
                play('snd-hit'); speak("Esatto! Hai vinto il round!");
                await supabase.from('stanze').update({stato:'attesa',montepremi_round:0}).eq('id',myRoomId);
            } else {
                play('snd-miss'); speak("Errato.");
                passTurn();
            }
            return;
        }

        // LOGICA LETTERA / VOCALE
        const char = txt.charAt(0);
        const isVowel = "AEIOU".includes(char);
        
        if(currentMode === 'vowel') {
             const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
             await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale - 500}).eq('id',myId);
        }

        // Conta occorrenze
        let indices = [];
        let normSol = currentSolution.replace(/[ÀÁ]/g,'A').replace(/[ÈÉ]/g,'E').replace(/[ÌÍ]/g,'I').replace(/[ÒÓ]/g,'O').replace(/[ÙÚ]/g,'U');
        
        for(let i=0; i<normSol.length; i++) {
            if(normSol[i] === char) indices.push(i);
        }

        if(indices.length > 0) {
            play('snd-hit');
            speak(`Presente ${indices.length} volte.`);
            let newRev = [...new Set([...(roomState.lettere_rivelate||[]),...indices])];
            
            if(currentMode === 'letter') {
                 const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
                 const win = roomState.montepremi_round * indices.length;
                 await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale + win}).eq('id',myId);
            }
            await supabase.from('stanze').update({lettere_rivelate:newRev}).eq('id',myRoomId);
        } else {
            play('snd-miss');
            speak("Lettera assente.");
            passTurn();
        }
    }

    async function passTurn() {
        const {data:pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        const nxt = (myIndex + 1) % pl.length;
        await supabase.from('stanze').update({id_giocatore_corrente:nxt, montepremi_round:0}).eq('id',myRoomId);
    }

    async function startNewRound() {
        const {data:f} = await supabase.from('frasi').select('*');
        if(!f || !f.length) return speak("Nessuna frase nel DB");
        const pick = f[Math.floor(Math.random()*f.length)];
        await supabase.from('stanze').update({stato:'gioco', frase_corrente_id:pick.id, lettere_rivelate:[], montepremi_round:0}).eq('id',myRoomId);
    }
</script>
</body>
</html>