<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - Accessibile V3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* STILE ALTO CONTRASTO "BLIND-FIRST" */
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0; padding: 20px;
            overflow-x: hidden;
        }
        h1 { color: #ffd700; font-size: 1.6em; margin-bottom: 10px; }
        h2 { color: #4caf50; font-size: 1.3em; border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 20px; }
        
        .container { max-width: 900px; margin: 0 auto; }

        /* SEZIONE 1: SETUP */
        #setup-panel input {
            display: block; width: 100%; padding: 10px; margin: 5px 0 15px 0;
            font-size: 1.1em; background: #222; color: #fff; border: 1px solid #555;
        }
        #setup-panel button {
            width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold;
            background: #ffd700; color: #000; border: none; cursor: pointer; margin-bottom: 10px;
        }

        /* SEZIONE 2: GIOCO */
        .status-bar {
            background: #1a1a1a; padding: 15px; border: 1px solid #333; margin-bottom: 15px;
            display: flex; justify-content: space-between; flex-wrap: wrap;
        }
        .turn-active { color: #00ff00; font-weight: bold; text-transform: uppercase; }
        
        /* RUOTA TESTUALE */
        #wheel-status {
            background: #2a2a2a; border: 2px solid #ffd700; padding: 20px;
            text-align: center; font-size: 1.4em; font-weight: bold; margin: 15px 0;
        }

        /* TABELLONE INTERATTIVO */
        #board-navigator {
            background: #000; border: 1px dashed #666; padding: 10px; margin: 10px 0;
            color: #ccc; font-family: monospace;
        }
        #board-navigator:focus {
            outline: 3px solid #00ff00; border-color: #00ff00; color: #fff;
        }

        /* INPUT DI GIOCO */
        #input-area {
            background: #330000; padding: 20px; border: 2px solid #ff0000; margin-top: 15px;
        }
        #game-input {
            width: 100%; font-size: 1.5em; padding: 10px; text-transform: uppercase;
        }

        /* PULSANTI AZIONE */
        .action-btn {
            width: 100%; padding: 15px; margin: 5px 0; font-size: 1.2em; font-weight: bold;
            background: #333; color: #fff; border: 1px solid #555; cursor: pointer; text-align: left;
        }
        .action-btn:disabled { color: #777; background: #111; cursor: not-allowed; }
        .action-btn:hover:not(:disabled) { background: #444; }

        /* MODALE ISPETTORE (CTRL+I) */
        #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; padding: 20px; box-sizing: border-box;
            overflow-y: auto;
        }
        .inspector-content p {
            font-size: 1.4em; line-height: 1.6; margin-bottom: 15px; font-family: 'Verdana', sans-serif;
        }

        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<div id="inspector-overlay" class="hidden" role="dialog" aria-label="Ispettore Testuale Tabellone">
    <h2 style="color:white; border:none;">Modalità Lettura (Usa frecce standard)</h2>
    <div id="inspector-text" class="inspector-content" tabindex="-1"></div>
    <button onclick="closeInspector()" style="margin-top:20px; padding:10px; font-size:1.2em;">Chiudi (ESC)</button>
</div>

<div class="container" id="main-container">
    <h1>LA RUOTA - Audio Game</h1>

    <div id="setup-panel">
        <h2>Configurazione</h2>
        <label for="inp-name">Nome:</label>
        <input id="inp-name" type="text" placeholder="Il tuo nome">
        <label for="inp-code">Codice Stanza:</label>
        <input id="inp-code" type="text" placeholder="Es. CASA">
        <button onclick="joinGame(true)">CREA STANZA</button>
        <button onclick="joinGame(false)">ENTRA IN STANZA</button>
    </div>

    <div id="game-panel" class="hidden">
        
        <div class="status-bar">
            <div id="turn-indicator">In attesa...</div>
            <div id="my-score">Tu: €0</div>
        </div>

        <div id="wheel-status" role="status" aria-live="polite">Ruota ferma.</div>

        <h2>TABELLONE (Navigabile)</h2>
        <div id="category-display" style="font-style:italic; margin-bottom:5px; color:#aaa;">Categoria: —</div>
        
        <div id="board-navigator" tabindex="0" role="application" aria-label="Tabellone di gioco. Usa le frecce per esplorare.">
            (Il tabellone apparirà qui. Premi le frecce per navigare.)
        </div>
        <div style="font-size:0.9rem; color:#888; margin-top:5px;">
            Comandi focus: SU/GIÙ (lettera dett.), CTRL+SU/GIÙ (parola), CTRL+I (Testo puro).
        </div>

        <h2 style="margin-top:30px;">AZIONI</h2>
        <button id="btn-spin" class="action-btn" onclick="doSpin()" disabled>1. GIRA RUOTA (Ctrl+G)</button>
        <button id="btn-vowel" class="action-btn" onclick="openInput('vowel')" disabled>2. COMPRA VOCALE €500 (Ctrl+V)</button>
        <button id="btn-solve" class="action-btn" onclick="openInput('solve')" disabled>3. RISOLVI (Ctrl+S)</button>

        <div id="input-area" class="hidden">
            <label id="input-label" for="game-input" style="font-size:1.2em; font-weight:bold; display:block; margin-bottom:10px;">Inserisci:</label>
            <input id="game-input" type="text" autocomplete="off">
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="submitInput()" style="flex:1; padding:15px; background:#00ff00; font-weight:bold;">CONFERMA (Invio)</button>
                <button onclick="closeInput()" style="flex:1; padding:15px; background:#ccc;">ANNULLA (Esc)</button>
            </div>
        </div>

        <div style="margin-top:30px; border-top:1px solid #444; padding-top:10px;">
            <h3>Giocatori:</h3>
            <ul id="player-list" style="list-style:none; padding:0;"></ul>
        </div>
        
        <div id="host-controls" class="hidden" style="margin-top:20px;">
            <button onclick="startNewRound()" style="padding:10px; background:#555; color:white;">[HOST] NUOVO ROUND</button>
        </div>
    </div>
</div>

<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>

<script>
    // --- CONFIG ---
    const supabase = window.supabase.createClient(
        'https://azcwkpdjbysnivknnino.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU'
    );
    const WHEEL_VALUES = [100, 200, 300, 400, 500, 1000, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO'];

    // --- STATO ---
    let myId, myRoomId, myIndex, isHost = false;
    let roomState = {};
    let currentSolution = "";   // "IL GATTO"
    let currentRevealed = [];   // [0, 1, 3]
    let inputMode = null;       // 'letter', 'vowel', 'solve'
    let isSpinning = false;

    // Navigazione Tabellone
    let navWordIdx = 0;
    let navCharIdx = 0;
    let parsedBoard = []; // Struttura: [{ word: "IL", chars: [{char:'I', vis:true}, ...] }]

    // --- ACCESSIBILITÀ ---
    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = '';
        setTimeout(() => el.textContent = text, 50);
    }
    function play(id) { document.getElementById(id).play().catch(()=>{}); }

    // --- PARSER TABELLONE (Cuore della navigazione) ---
    function parseBoardData() {
        parsedBoard = [];
        if (!currentSolution) return;

        const rawWords = currentSolution.split(' ');
        let globalIndex = 0;

        rawWords.forEach((w) => {
            let wordObj = { wordStr: w, chars: [] };
            for (let i = 0; i < w.length; i++) {
                const char = w[i];
                const isRevealed = currentRevealed.includes(globalIndex);
                wordObj.chars.push({
                    realChar: char,
                    displayChar: isRevealed ? char : '_',
                    isRevealed: isRevealed,
                    globalIdx: globalIndex
                });
                globalIndex++;
            }
            parsedBoard.push(wordObj);
            globalIndex++; // Salta lo spazio
        });
        
        // Aggiorna il testo visibile nel navigatore per chi vede o per il focus iniziale
        updateNavigatorVisual();
    }

    function updateNavigatorVisual() {
        const navDiv = document.getElementById('board-navigator');
        if(parsedBoard.length === 0) {
            navDiv.textContent = "(Tabellone vuoto)";
            return;
        }
        let text = parsedBoard.map(w => w.chars.map(c => c.displayChar).join(' ')).join('   /   ');
        navDiv.textContent = text;
    }

    // --- MODALITÀ 1: ISPETTORE (CTRL+I) ---
    function openInspector() {
        const overlay = document.getElementById('inspector-overlay');
        const content = document.getElementById('inspector-text');
        
        // Costruisci HTML puro
        let html = `<p>Categoria: ${document.getElementById('category-display').textContent}</p>`;
        
        if (parsedBoard.length === 0) {
            html += "<p>Nessuna frase caricata.</p>";
        } else {
            parsedBoard.forEach((w, idx) => {
                let wStr = "";
                w.chars.forEach(c => {
                    wStr += c.isRevealed ? c.realChar : " trattino ";
                });
                html += `<p>Parola ${idx + 1}: ${wStr}</p>`;
            });
        }

        content.innerHTML = html;
        overlay.classList.remove('hidden');
        content.focus(); // Focus sul container, non intercettato
    }

    function closeInspector() {
        document.getElementById('inspector-overlay').classList.add('hidden');
        document.getElementById('board-navigator').focus();
    }

    // --- MODALITÀ 2: NAVIGAZIONE FOCUS ---
    document.getElementById('board-navigator').addEventListener('keydown', (e) => {
        if (parsedBoard.length === 0) return;

        // Logica richiesta:
        // Frecce SU/GIÙ: Navigazione Lettera (Simulazione "No focus" request)
        // CTRL+SU/GIÙ (o solo SU/GIÙ se focus mode): Navigazione Parola

        let handled = false;

        // 1. NAVIGAZIONE LETTERA (SU/GIÙ o DESTRA/SINISTRA)
        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
            // Vai avanti
            if(e.ctrlKey) return; // Lascia gestire al blocco parole
            moveNextChar();
            handled = true;
        } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
            // Vai indietro
            if(e.ctrlKey) return;
            movePrevChar();
            handled = true;
        }
        // 2. NAVIGAZIONE PAROLA (CTRL + FRECCE)
        else if ((e.ctrlKey && e.key === 'ArrowDown') || e.key === 'PageDown') {
            moveNextWord();
            handled = true;
        } else if ((e.ctrlKey && e.key === 'ArrowUp') || e.key === 'PageUp') {
            movePrevWord();
            handled = true;
        }

        if (handled) {
            e.preventDefault();
            announceCurrentPosition();
        }
    });

    function moveNextChar() {
        navCharIdx++;
        let currentWordLen = parsedBoard[navWordIdx].chars.length;
        
        if (navCharIdx >= currentWordLen) {
            // Fine parola, passa alla prossima
            if (navWordIdx < parsedBoard.length - 1) {
                navWordIdx++;
                navCharIdx = 0;
            } else {
                navCharIdx = currentWordLen - 1; // Fermo alla fine
                speak("Fine tabellone");
                return;
            }
        }
    }

    function movePrevChar() {
        navCharIdx--;
        if (navCharIdx < 0) {
            // Inizio parola, vai alla precedente
            if (navWordIdx > 0) {
                navWordIdx--;
                navCharIdx = parsedBoard[navWordIdx].chars.length - 1;
            } else {
                navCharIdx = 0; // Fermo all'inizio
                speak("Inizio tabellone");
                return;
            }
        }
    }

    function moveNextWord() {
        if (navWordIdx < parsedBoard.length - 1) {
            navWordIdx++;
            navCharIdx = 0;
        } else {
            speak("Ultima parola");
        }
    }

    function movePrevWord() {
        if (navWordIdx > 0) {
            navWordIdx--;
            navCharIdx = 0;
        } else {
            speak("Prima parola");
        }
    }

    function announceCurrentPosition() {
        const w = parsedBoard[navWordIdx];
        const c = w.chars[navCharIdx];
        
        // Costruzione frase: "Parola 2, A, 1 di 4"
        let msg = "";
        
        // Se siamo all'inizio della parola, annuncia numero parola
        if (navCharIdx === 0) {
            msg += `Parola ${navWordIdx + 1}. `;
        }

        // Lettera
        let letterAudio = c.isRevealed ? c.realChar : "Nascosta";
        msg += `${letterAudio}, ${navCharIdx + 1} di ${w.chars.length}`;

        speak(msg);
    }

    // --- GESTIONE TASTI GLOBALI ---
    document.addEventListener('keydown', (e) => {
        // CTRL+I -> Inspector
        if (e.ctrlKey && (e.key === 'i' || e.key === 'I')) {
            e.preventDefault();
            openInspector();
            return;
        }
        // ESC -> Chiudi tutto
        if (e.key === 'Escape') {
            closeInspector();
            closeInput();
            return;
        }
        
        // Se siamo nell'input o inspector, non attivare comandi gioco
        if (!document.getElementById('input-area').classList.contains('hidden')) return;
        if (!document.getElementById('inspector-overlay').classList.contains('hidden')) return;

        // Comandi Gioco
        if (roomState.id_giocatore_corrente === myIndex && roomState.stato === 'gioco') {
            if (e.ctrlKey && (e.key === 'g' || e.key === 'G')) { e.preventDefault(); doSpin(); }
            if (e.ctrlKey && (e.key === 'v' || e.key === 'V')) { e.preventDefault(); openInput('vowel'); }
            if (e.ctrlKey && (e.key === 's' || e.key === 'S')) { e.preventDefault(); openInput('solve'); }
        }
    });

    // --- LOGICA CONNESSIONE E SUPABASE (Standard) ---
    async function joinGame(create) {
        const name = document.getElementById('inp-name').value.trim().toUpperCase();
        const code = document.getElementById('inp-code').value.trim().toUpperCase();
        if (!name || !code) return speak("Inserisci dati");

        let rData;
        if (create) {
            const { data, error } = await supabase.from('stanze').insert({ codice: code, stato: 'attesa' }).select().single();
            if (error) return speak("Codice usato");
            rData = data; isHost = true;
        } else {
            const { data } = await supabase.from('stanze').select('*').eq('codice', code).maybeSingle();
            if (!data) return speak("Stanza inesistente");
            rData = data;
        }

        myRoomId = rData.id;
        
        // Gestione Player
        const { data: exist } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).eq('nome', name).maybeSingle();
        if (exist) {
            myId = exist.id; myIndex = exist.indice; isHost = exist.is_host;
            speak("Bentornato");
        } else {
            const { count } = await supabase.from('giocatori').select('*', { count: 'exact', head: true }).eq('stanza_id', myRoomId);
            const { data: neu } = await supabase.from('giocatori').insert({ stanza_id: myRoomId, nome: name, indice: count||0, is_host: isHost }).select().single();
            myId = neu.id; myIndex = neu.indice;
            speak("Entrato");
        }

        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('game-panel').classList.remove('hidden');
        if (isHost) document.getElementById('host-controls').classList.remove('hidden');

        startSync();
    }

    function startSync() {
        supabase.channel('room').on('postgres_changes', { event: '*', schema: 'public', table: 'stanze', filter: `id=eq.${myRoomId}` }, p => updateRoom(p.new)).subscribe();
        supabase.channel('players').on('postgres_changes', { event: '*', schema: 'public', table: 'giocatori', filter: `stanza_id=eq.${myRoomId}` }, updatePlayers).subscribe();
        
        supabase.from('stanze').select('*').eq('id', myRoomId).single().then(r => updateRoom(r.data));
        updatePlayers();
    }

    async function updateRoom(data) {
        roomState = data;
        
        // Turno
        const isMyTurn = (data.id_giocatore_corrente === myIndex);
        const tInd = document.getElementById('turn-indicator');
        tInd.textContent = isMyTurn ? "È IL TUO TURNO" : `Turno di Giocatore ${data.id_giocatore_corrente}`;
        tInd.className = isMyTurn ? 'turn-active' : '';

        ['btn-spin', 'btn-vowel', 'btn-solve'].forEach(id => document.getElementById(id).disabled = !isMyTurn);

        // Ruota
        const wText = data.montepremi_round > 0 ? `Valore: €${data.montepremi_round}` : "Gira la ruota";
        document.getElementById('wheel-status').textContent = wText;

        // Frase
        if (data.frase_corrente_id) {
            // Fetch se serve
            if (!currentSolution || data.stato === 'attesa') {
                const { data: f } = await supabase.from('frasi').select('*').eq('id', data.frase_corrente_id).single();
                currentSolution = f.soluzione.toUpperCase();
                document.getElementById('category-display').textContent = "Categoria: " + f.categoria;
            }
            currentRevealed = data.lettere_rivelate || [];
            parseBoardData(); // Ricalcola struttura per navigazione
        }
        
        // Auto-apertura input lettera consonante
        if (isMyTurn && data.montepremi_round > 0 && !inputMode && !isSpinning) {
            openInput('letter');
        }
    }

    async function updatePlayers() {
        const { data } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
        const ul = document.getElementById('player-list');
        ul.innerHTML = '';
        data.forEach(p => {
            const li = document.createElement('li');
            li.textContent = `${p.nome}: €${p.punteggio_totale}`;
            if (p.id === myId) document.getElementById('my-score').textContent = `Tu: €${p.punteggio_totale}`;
            if (p.indice === roomState.id_giocatore_corrente) li.style.color = '#00ff00';
            ul.appendChild(li);
        });
    }

    // --- AZIONI GIOCO ---
    function doSpin() {
        if (isSpinning) return;
        isSpinning = true;
        play('snd-spin');
        speak("Gira...");
        document.getElementById('wheel-status').textContent = "GIRANDO...";
        
        setTimeout(async () => {
            isSpinning = false;
            const val = WHEEL_VALUES[Math.floor(Math.random() * WHEEL_VALUES.length)];
            
            if (val === 'BANCAROTTA') {
                speak("Bancarotta");
                await supabase.from('giocatori').update({ punteggio_totale: 0 }).eq('id', myId);
                nextTurn();
            } else if (val === 'PASSA') {
                speak("Passa");
                nextTurn();
            } else if (val === 'MISTERO') {
                speak("Mistero: Jolly"); // Semplificato
                // Logica jolly qui
                nextTurn(); 
            } else {
                speak(val + " euro");
                await supabase.from('stanze').update({ montepremi_round: val }).eq('id', myRoomId);
                // Input si apre da updateRoom
            }
        }, 3000);
    }

    function openInput(mode) {
        inputMode = mode;
        const div = document.getElementById('input-area');
        const lbl = document.getElementById('input-label');
        const inp = document.getElementById('game-input');
        div.classList.remove('hidden');
        inp.value = '';
        inp.focus();
        
        if (mode === 'letter') lbl.textContent = `Consonante per €${roomState.montepremi_round}:`;
        if (mode === 'vowel') lbl.textContent = "Vocale (€500):";
        if (mode === 'solve') lbl.textContent = "Soluzione:";
    }

    function closeInput() {
        document.getElementById('input-area').classList.add('hidden');
        inputMode = null;
        document.getElementById('board-navigator').focus(); // Torna al tabellone
    }

    async function submitInput() {
        const val = document.getElementById('game-input').value.toUpperCase().trim();
        if (!val) return;
        closeInput();

        // RISOLVI
        if (inputMode === 'solve') {
            const cleanSol = currentSolution.replace(/[^A-Z]/g, '');
            const cleanVal = val.replace(/[^A-Z]/g, '');
            if (cleanSol === cleanVal) {
                play('snd-hit'); speak("Esatto! Vittoria!");
                await supabase.from('stanze').update({ stato: 'attesa', montepremi_round: 0 }).eq('id', myRoomId);
            } else {
                play('snd-miss'); speak("Errato.");
                nextTurn();
            }
            return;
        }

        // LETTERA
        const char = val.charAt(0);
        const isVowel = "AEIOU".includes(char);
        
        if (inputMode === 'letter' && isVowel) { speak("Serve consonante"); return; }
        if (inputMode === 'vowel' && !isVowel) { speak("Serve vocale"); return; }
        
        if (inputMode === 'vowel') {
            // Sottrai soldi (semplificato)
            const { data: me } = await supabase.from('giocatori').select('punteggio_totale').eq('id', myId).single();
            await supabase.from('giocatori').update({ punteggio_totale: me.punteggio_totale - 500 }).eq('id', myId);
        }

        // Controlla presenza
        let indices = [];
        let cleanSol = currentSolution.replace(/[ÀÁ]/g,'A').replace(/[ÈÉ]/g,'E').replace(/[ÌÍ]/g,'I').replace(/[ÒÓ]/g,'O').replace(/[ÙÚ]/g,'U');
        
        for(let i=0; i<cleanSol.length; i++) {
            if (cleanSol[i] === char) indices.push(i);
        }

        if (indices.length > 0) {
            play('snd-hit');
            speak(`Ci sono ${indices.length} ${char}`);
            
            let newRev = [...new Set([...(roomState.lettere_rivelate||[]), ...indices])];
            
            if (inputMode === 'letter') {
                const { data: me } = await supabase.from('giocatori').select('punteggio_totale').eq('id', myId).single();
                const win = roomState.montepremi_round * indices.length;
                await supabase.from('giocatori').update({ punteggio_totale: me.punteggio_totale + win }).eq('id', myId);
            }
            
            await supabase.from('stanze').update({ lettere_rivelate: newRev }).eq('id', myRoomId);
        } else {
            play('snd-miss');
            speak("Nessuna " + char);
            nextTurn();
        }
    }

    async function nextTurn() {
        const { data: pl } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
        const nxt = (myIndex + 1) % pl.length;
        await supabase.from('stanze').update({ id_giocatore_corrente: nxt, montepremi_round: 0 }).eq('id', myRoomId);
    }

    async function startNewRound() {
        const { data: frasi } = await supabase.from('frasi').select('*');
        const f = frasi[Math.floor(Math.random() * frasi.length)];
        await supabase.from('stanze').update({ stato: 'gioco', frase_corrente_id: f.id, lettere_rivelate: [], montepremi_round: 0 }).eq('id', myRoomId);
    }

</script>
</body>
</html>