<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Ruota - Bulletproof Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- STILI BASE E ALTO CONTRASTO --- */
        :root {
            --bg-body: #111;
            --col-text: #fff;
            --col-focus: #ffd700;
            --bg-panel: #222;
            --bg-tile-revealed: #fff;
            --col-tile-text: #000;
        }

        body.high-contrast {
            --bg-body: #000;
            --col-text: #fff;
            --col-focus: #00ffff;
            --bg-panel: #000;
            border: 2px solid yellow;
        }

        body {
            background: var(--bg-body); color: var(--col-text); 
            font-family: 'Verdana', sans-serif;
            margin: 0; padding: 10px; text-align: center; 
            padding-bottom: 120px; /* Spazio per i controlli touch */
        }

        /* Accessibilità Focus */
        *:focus { outline: 4px solid var(--col-focus) !important; box-shadow: 0 0 15px var(--col-focus); }
        .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); }
        .hidden { display: none !important; }

        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
        
        #game-panel, #setup-panel, #end-panel, #round-over-panel { 
            border: 2px solid #555; padding: 15px; margin-top: 15px; 
            background: var(--bg-panel); border-radius: 10px; width: 95%;
        }

        /* --- TABELLONE --- */
        #board-container {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            background: #053305; border: 4px solid #fff; padding: 20px; margin: 20px 0;
            min-height: 150px;
        }
        .board-row { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        
        .tile {
            width: 45px; height: 65px; 
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 2.2em; color: #000;
            background: #fff; border: 2px solid #000;
        }
        .tile.empty { background: #004400; border: 1px dashed #006600; color: transparent; }
        
        /* Cursore Navigazione */
        .tile.cursor-char { border: 5px solid var(--col-focus); transform: scale(1.1); z-index: 10; }
        .board-row.cursor-word { outline: 3px solid var(--col-focus); background: rgba(255, 255, 0, 0.2); }

        /* --- CONTROLLI SMARTPHONE (Tasti Grandi in Basso) --- */
        #tactile-nav {
            display: flex; justify-content: center; gap: 10px; padding: 10px;
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #000; border-top: 2px solid var(--col-focus); z-index: 2000;
        }
        .nav-btn {
            background: #333; color: #fff; border: 2px solid #555;
            width: 55px; height: 55px; border-radius: 50%; 
            font-size: 1.8em; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:active { background: var(--col-focus); color: #000; }
        .nav-btn.btn-read { border-color: var(--col-focus); color: var(--col-focus); }

        /* --- PULSANTI AZIONE --- */
        button.action-btn { 
            padding: 15px 30px; margin: 10px; cursor: pointer; 
            font-weight: 900; font-size: 1.2em; text-transform: uppercase;
            border: 3px solid #fff; border-radius: 10px;
        }
        .btn-primary { background: #ffd700; color: #000; }
        .btn-secondary { background: #00ffff; color: #000; }
        .btn-danger { background: #ff4444; color: #fff; }
        .disabled-btn { background: #444 !important; color: #888 !important; cursor: not-allowed; }

        /* --- RUOTA --- */
        #wheel-visual {
            width: 150px; height: 150px; margin: 10px auto; border-radius: 50%; 
            border: 5px solid #fff;
            background: conic-gradient(#f00, #ff0, #0f0, #00f, #f0f, orange);
            transition: transform 3.5s cubic-bezier(0.1, 0.9, 0.1, 1);
        }
        #wheel-pointer { 
            width: 0; height: 0; border-left: 15px solid transparent; 
            border-right: 15px solid transparent; border-top: 30px solid #fff; 
            margin: 0 auto -20px auto; position: relative; z-index: 20; 
        }

        /* --- INPUT OVERLAY --- */
        #input-area, #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        input { 
            font-size: 2.5em; padding: 15px; text-align: center; 
            width: 80%; background: #222; color: #fff; 
            border: 3px solid var(--col-focus); border-radius: 10px; 
        }

        /* Media Queries per PC */
        @media (min-width: 769px) {
            #tactile-nav { position: relative; background: transparent; border: none; padding: 20px; }
            .tile { width: 50px; height: 75px; font-size: 2.5em; }
        }
    </style>
</head>
<body>

    <div id="sr-announcer" class="sr-only" aria-live="assertive"></div>
    
    <button id="contrast-toggle-btn" onclick="toggleContrast()" style="margin-bottom:10px;">
        Cambia Contrasto (C)
    </button>

    <audio id="snd-spin" src="ruota.wav"></audio>
    <audio id="snd-hit" src="lettera presente.wav"></audio>
    <audio id="snd-miss" src="lettera assente.wav"></audio>

    <div id="setup-panel" class="container">
        <h1 style="color:#ffd700;">LA RUOTA</h1>
        <input id="inp-name" type="text" placeholder="IL TUO NOME"><br><br>
        <input id="inp-code" type="text" value="STANZA1"><br><br>
        <button onclick="joinGame(true)" class="action-btn btn-primary">CREA STANZA</button>
        <button onclick="joinGame(false)" class="action-btn btn-secondary">ENTRA</button>
    </div>

    <div id="game-panel" class="container hidden">
        <div id="timer-box" style="font-size:2em; color:red; border:2px solid red; padding:5px 15px; border-radius:20px; display:inline-block;">120</div>
        
        <div class="info-bar" style="width:100%; display:flex; justify-content:space-between; padding:10px;">
            <div style="text-align:left;">
                <span id="round-indicator" style="color:#aaa;">Round 1/10</span><br>
                <span id="turn-indicator" style="font-size:1.2em; font-weight:bold;">...</span>
            </div>
            <div style="text-align:right;">
                <span style="color:#00ff00;">€</span> <span id="score-round" style="color:#00ff00; font-weight:bold; font-size:1.4em;">0</span><br>
                <span style="color:#ffd700;">Tot: €</span> <span id="score-total" style="color:#ffd700;">0</span>
            </div>
        </div>

        <h2 id="live-category" style="color:#00ffff; margin: 10px 0;">...</h2>
        <h3 id="round-hint" style="color:#ffd700; margin-bottom: 15px;"></h3>

        <div id="board-container" aria-hidden="true"></div>

        <div id="tactile-nav">
            <button class="nav-btn" onclick="moveWordNav(-1)" aria-label="Parola Precedente"><span>&#171;</span></button>
            <button class="nav-btn" onclick="moveNav(-1)" aria-label="Lettera Precedente"><span>&#8249;</span></button>
            <button class="nav-btn btn-read" onclick="readFullBoard()" aria-label="Leggi Tutto"><span>&#9679;</span></button>
            <button class="nav-btn" onclick="moveNav(1)" aria-label="Lettera Successiva"><span>&#8250;</span></button>
            <button class="nav-btn" onclick="moveWordNav(1)" aria-label="Parola Successiva"><span>&#187;</span></button>
        </div>
        
        <div id="wheel-pointer"></div>
        <div id="wheel-visual"></div>
        <div id="wheel-status-text" style="font-size: 1.5em; font-weight: bold; color: #00ff00; margin: 10px; min-height: 1.5em;"></div>

        <div id="controls">
            <button id="btn-spin" class="action-btn btn-primary" onclick="doSpin()">GIRA (G)</button>
            <button id="btn-vowel" class="action-btn btn-secondary" onclick="openInput('vowel')">VOCALE (V)</button>
            <button id="btn-solve" class="action-btn btn-danger" onclick="openInput('solve')">RISOLVI (S)</button>
            <button id="btn-manual-cons" class="action-btn hidden" onclick="openInput('letter')" style="background: #00ff00; color: #000;">DI UNA CONSONANTE</button>
        </div>
        
        <div class="sr-only">
            <p>Comandi rapidi: CTRL+L legge lettere scoperte. A legge ultime azioni. G gira. V vocale. S risolvi.</p>
        </div>
    </div>

    <div id="round-over-panel" class="container hidden">
        <h2 id="round-title" style="color: #00ff00;">ROUND COMPLETATO!</h2>
        <p id="round-winner-msg" style="font-size: 1.5em;">...</p>
        <p id="solution-msg" style="color: #ffd700; font-size: 1.5em; font-weight:bold;">...</p>
        <button id="btn-next-round" onclick="startNewRound()" class="action-btn btn-primary">PROSSIMO ROUND (INVIO)</button>
    </div>

    <div id="end-panel" class="container hidden">
        <h2 style="color: #ffd700;">FINE PARTITA</h2>
        <ul id="ranking-list" style="list-style: none; padding: 0; font-size: 1.5em;"></ul>
        <button onclick="location.reload()" class="action-btn btn-secondary">TORNA AL MENU</button>
    </div>

    <div id="input-area" class="hidden">
        <h2 id="input-title" style="color:#ffd700;">...</h2>
        <input id="game-input" type="text" autocomplete="off" placeholder="Scrivi qui...">
        <div style="margin-top: 30px;">
            <button onclick="submitInput()" class="action-btn btn-primary">OK</button>
            <button onclick="closeInput()" class="action-btn btn-secondary">ANNULLA</button>
        </div>
    </div>

    <div id="inspector-overlay" class="hidden" role="dialog" aria-label="Ispettore">
        <div id="inspector-content" style="background:#222; border:2px solid #ffd700; padding:20px; width:90%; max-height:80%; overflow-y:auto; color:#fff; font-size: 1.4em;" tabindex="-1"></div>
        <button onclick="closeInspector()" class="action-btn btn-secondary" style="margin-top:20px;">CHIUDI</button>
    </div>

    <script>
        // --- FUNZIONI DI SUPPORTO ---
        function playAudio(id) { const a=document.getElementById(id); if(a){a.pause();a.currentTime=0;a.play().catch(e=>{});} }
        function playMultiHit(n) { let i=0; function l(){if(i<n){playAudio('snd-hit');i++;setTimeout(l,250)}} l(); }
        
        // --- SOLO SCREEN READER (NO VOCE ESTERNA) ---
        function speak(t) { 
            const e = document.getElementById('sr-announcer'); 
            e.textContent = ''; 
            setTimeout(() => { e.textContent = t; }, 50); 
        }

        function toggleContrast() { 
            document.body.classList.toggle('high-contrast'); 
            const isHigh = document.body.classList.contains('high-contrast');
            localStorage.setItem('highContrast', isHigh);
            speak(isHigh ? "Alto contrasto attivato" : "Contrasto normale"); 
        }
        if(localStorage.getItem('highContrast') === 'true') { document.body.classList.add('high-contrast'); }

        function setBtnState(id,d) { 
            const b=document.getElementById(id); if(!b)return; 
            if(d){b.classList.add('disabled-btn');b.setAttribute('aria-disabled','true');b.disabled=true;}
            else{b.classList.remove('disabled-btn');b.setAttribute('aria-disabled','false');b.disabled=false;} 
        }
        function isBtnDisabled(id) { return document.getElementById(id).getAttribute('aria-disabled')==='true'; }

        // --- DATABASE ---
        const SUPABASE_URL = 'https://azcwkpdjbysnivknnino.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const NATO = {'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','À':'A accentata','È':'E aperta','É':'E chiusa','Ì':'I accentata','Ò':'O accentata','Ù':'U accentata'};
        const WHEEL_VALUES = [100,200,300,400,500,600,700,800,900,1000,2000,3000,'MISTERO','PASSA','BANCAROTTA'];
        const VOWELS_LIST = ['A','E','I','O','U','À','È','É','Ì','Ò','Ù'];

        let myId, myIndex, roomId, isHost=false, currentFrase=null, currentStanza=null, currentPuzzleText="", currentHintText="", fullSolutionText="", lastTimestamp="", isSpinning=false, inputMode=null, wheelAngle=0, parsedBoard=[], navWordIdx=0, navCharIdx=0, pollingInterval=null, timerInterval=null, actionLog=[], isFetching=false, isProcessingInput=false;
        const TURN_LIMIT_SEC=120; 

        function cleanStr(s) { return s?s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,""):""; }
        
        async function joinGame(cr) {
            const nm=document.getElementById('inp-name').value.trim().toUpperCase(), cd=document.getElementById('inp-code').value.trim().toUpperCase();
            if(!nm) return speak("Nome mancante");
            try {
                let st;
                if(cr){
                    const {data:fr}=await supabase.from('frasi').select('id');
                    
                    // FIX HARDENING: Se non ci sono frasi, evita il crash
                    if (!fr || fr.length === 0) {
                        speak("Nessuna frase nel database!");
                        return;
                    }

                    const rid=fr[Math.floor(Math.random()*fr.length)].id;
                    const {data:old}=await supabase.from('stanze').select('id').eq('codice',cd).maybeSingle();
                    if(old){await supabase.from('giocatori').delete().eq('stanza_id',old.id);await supabase.from('stanze').delete().eq('id',old.id);}
                    const {data,error}=await supabase.from('stanze').insert({codice:cd,stato:'attesa',frase_corrente_id:rid,lettere_chiamate:[],lettere_rivelate:[],round_giocati:1, azione_timestamp:new Date().toISOString()}).select().maybeSingle();
                    st=error?(await supabase.from('stanze').select('*').eq('codice',cd).maybeSingle()).data:data;
                } else {
                    const {data}=await supabase.from('stanze').select('*').eq('codice',cd).maybeSingle();
                    if(!data)return speak("Stanza non trovata");
                    st=data;
                }
                roomId=st.id;
                await supabase.from('giocatori').delete().eq('stanza_id',roomId).eq('nome',nm);
                const {count}=await supabase.from('giocatori').select('*',{count:'exact',head:true}).eq('stanza_id',roomId);
                myIndex=count||0; isHost=(myIndex===0);
                const {data:pl}=await supabase.from('giocatori').insert({stanza_id:roomId,nome:nm,indice:myIndex,is_host:isHost,punteggio_totale:0,punteggio_round:0}).select().maybeSingle();
                myId=pl.id;
                document.getElementById('setup-panel').classList.add('hidden'); document.getElementById('game-panel').classList.remove('hidden');
                speak("Benvenuto. In attesa dell'avvio.");
                supabase.channel('game').on('postgres_changes',{event:'UPDATE',schema:'public',table:'stanze',filter:`id=eq.${roomId}`},()=>{fetchFullState()}).subscribe();
                fetchFullState();
                if(pollingInterval)clearInterval(pollingInterval); pollingInterval=setInterval(fetchFullState,4000);
                if(timerInterval)clearInterval(timerInterval); timerInterval=setInterval(checkTurnTimer,1000);
            } catch(e){console.error(e);speak("Errore connessione");}
        }

        async function fetchFullState() {
            if(isFetching)return; isFetching=true;
            const {data:s}=await supabase.from('stanze').select('*,frasi(*),giocatori(*)').eq('id',roomId).maybeSingle();
            isFetching=false; if(s)updateUI(s);
        }

        function checkTurnTimer() {
            if(!currentStanza||currentStanza.stato!=='gioco')return;
            const baseT = currentStanza.azione_timestamp || currentStanza.created_at;
            if(!baseT) return; 
            const svTime=new Date(baseT).getTime();
            const left=Math.max(0,(TURN_LIMIT_SEC+(inputMode==='solve'?30:0))-Math.floor((new Date().getTime()-svTime)/1000));
            document.getElementById('timer-box').textContent=left;
            if(left===60)playAudio('snd-hit');
            if(currentStanza.id_giocatore_corrente===myIndex&&left===0&&!isSpinning){ if(inputMode)closeInput(); handleTimeout(); }
        }

        async function handleTimeout() {
            speak("Tempo scaduto!");
            await supabase.from('stanze').update({id_giocatore_corrente:(myIndex+1)%currentStanza.giocatori.length,ultima_azione:'timeout',ultimo_messaggio:'Tempo scaduto',montepremi_round:0,azione_timestamp:new Date().toISOString()}).eq('id',roomId);
            fetchFullState();
        }

        function updateUI(s) {
            currentStanza=s;
            // FIX SICUREZZA: Assicuro che giocatori sia array
            s.giocatori = Array.isArray(s.giocatori) ? s.giocatori : [];
            s.giocatori.sort((a,b)=>a.indice-b.indice);
            
            if(s.stato==='attesa'){
                document.getElementById('game-panel').classList.add('hidden'); 
                document.getElementById('round-over-panel').classList.remove('hidden');
                document.getElementById('round-title').textContent = "PARTITA PRONTA";
                document.getElementById('round-winner-msg').textContent = "Codice: " + s.codice;
                document.getElementById('solution-msg').textContent = "Attesa Host...";
                document.getElementById('btn-next-round').textContent = "AVVIA (INVIO)";
                if(s.azione_timestamp !== lastTimestamp) { lastTimestamp = s.azione_timestamp; speak("Partita pronta."); }
                return;
            }

            if(s.stato==='finito'){
                document.getElementById('game-panel').classList.add('hidden'); document.getElementById('round-over-panel').classList.remove('hidden');
                document.getElementById('round-title').textContent = "ROUND COMPLETATO";
                document.getElementById('round-winner-msg').textContent=s.ultimo_messaggio; document.getElementById('solution-msg').textContent=fullSolutionText;
                document.getElementById('btn-next-round').textContent = "PROSSIMO ROUND";
                playMultiHit(3); speak("Fine Round. "+s.ultimo_messaggio); return;
            }
            if(s.stato==='terminata'){
                document.getElementById('game-panel').classList.add('hidden'); document.getElementById('end-panel').classList.remove('hidden');
                const l=document.getElementById('ranking-list'); l.innerHTML="";
                [...s.giocatori].sort((a,b)=>b.punteggio_totale-a.punteggio_totale).forEach((p,i)=>{l.innerHTML+=`<li>${i+1}. ${p.nome}: €${p.punteggio_totale}</li>`});
                speak("Partita terminata. Visualizzo la classifica.");
                return;
            }
            document.getElementById('round-over-panel').classList.add('hidden'); document.getElementById('game-panel').classList.remove('hidden');
            
            // FIX SICUREZZA: Controllo esistenza frase in relazione
            if (!s.frasi) {
                speak("Errore: Frase mancante. Controllare database.");
                return;
            }

            if(!currentFrase||currentFrase.id!==s.frasi.id){
                currentFrase=s.frasi; navWordIdx=0; navCharIdx=0;
                fullSolutionText=currentFrase.soluzione;
                if(fullSolutionText.includes(" - ")){
                    const p=fullSolutionText.split(" - ");
                    currentHintText=p[0].trim(); currentPuzzleText=p[1].trim();
                    if(currentFrase.categoria==='MUSICA' && currentHintText.includes(": ")) currentHintText=currentHintText.split(": ")[0].trim();
                } else {currentHintText="";currentPuzzleText=fullSolutionText;}
                speak(`Categoria: ${currentFrase.categoria}. ${currentHintText}`);
            }
            document.getElementById('round-indicator').textContent=`R ${s.round_giocati}/10`;
            
            if(s.azione_timestamp&&s.azione_timestamp!==lastTimestamp){
                lastTimestamp=s.azione_timestamp;
                if(s.ultimo_messaggio) { actionLog.unshift(s.ultimo_messaggio); if(actionLog.length>5)actionLog.pop(); }
                if(s.ultima_azione==='timeout'){speak(s.ultimo_messaggio);playAudio('snd-miss')}
                else if(s.ultima_azione==='chiama_lettera'){
                    speak(s.ultimo_messaggio);
                    if(s.ultimo_messaggio.includes("Trovate"))playMultiHit(2); else if(s.ultimo_messaggio.includes("non")||s.ultimo_messaggio.includes("già"))playAudio('snd-miss');
                }
                else if(s.ultima_azione==='errore'){speak(s.ultimo_messaggio);playAudio('snd-miss')}
                else if(s.ultimo_messaggio)speak(s.ultimo_messaggio);
            }
            document.getElementById('live-category').textContent=currentFrase.categoria; document.getElementById('round-hint').textContent=currentHintText;
            document.getElementById('wheel-status-text').textContent=s.montepremi_round>0?`IN PALIO: €${s.montepremi_round}`:"";
            
            parseAndRenderBoard(currentPuzzleText, s.lettere_rivelate);
            
            const isMe=(s.id_giocatore_corrente===myIndex), me=s.giocatori.find(p=>p.indice===myIndex);
            document.getElementById('turn-indicator').textContent=isMe?"TOCCA A TE":`Turno di ${s.giocatori.find(p=>p.indice===s.id_giocatore_corrente)?.nome||"..."}`;
            document.getElementById('turn-indicator').style.color=isMe?"#0f0":"#fff";
            if(me){document.getElementById('score-round').textContent=me.punteggio_round;document.getElementById('score-total').textContent=me.punteggio_totale;}
            
            const canSp=isMe&&!isSpinning&&!inputMode&&s.montepremi_round===0; setBtnState('btn-spin',!canSp);
            setBtnState('btn-solve',!(isMe&&!isSpinning));
            setBtnState('btn-vowel',!(isMe&&!isSpinning&&!inputMode&&me.punteggio_round>=500));
            if(isMe&&s.montepremi_round>0&&!inputMode&&!isSpinning) document.getElementById('btn-manual-cons').classList.remove('hidden'); else document.getElementById('btn-manual-cons').classList.add('hidden');
        }

        function parseAndRenderBoard(text, rev) {
            // FIX SICUREZZA: Evita crash se rev è null
            rev = Array.isArray(rev) ? rev : [];
            
            const c=document.getElementById('board-container'); c.innerHTML=''; parsedBoard=[];
            let gI=0; text.toUpperCase().split(' ').forEach(wS=>{
                let wO={str:wS,chars:[]}; const r=document.createElement('div'); r.className='board-row';
                for(let j=0;j<wS.length;j++){
                    const ch=wS[j], isL=ch.match(/[A-ZÀ-Ù]/), isR=!isL||rev.includes(gI);
                    wO.chars.push({char:ch,isRevealed:isR,isLetter:!!isL});
                    const d=document.createElement('div');
                    d.className='tile'+(isL&&isR?' revealed':(isL?' empty':''));
                    d.textContent = (isL && !isR) ? '' : ch;
                    d.id=`tile-${parsedBoard.length}-${j}`; r.appendChild(d); if(isL)gI++;
                }
                r.id=`row-${parsedBoard.length}`; c.appendChild(r); parsedBoard.push(wO);
            });
            highlightNav();
        }

        function moveNav(d) {
            if(!parsedBoard.length)return;
            let n=navCharIdx+d, wL=parsedBoard[navWordIdx].chars.length;
            if(n<0)n=0; if(n>=wL)n=wL-1;
            navCharIdx=n; highlightNav(); readSingleChar();
        }
        function moveWordNav(d) {
            if(!parsedBoard.length)return;
            let n=navWordIdx+d; if(n<0)n=0; if(n>=parsedBoard.length)n=parsedBoard.length-1;
            navWordIdx=n; navCharIdx=0; highlightNav(true); readWholeWord();
        }
        function highlightNav(wd=false) {
            document.querySelectorAll('.cursor-char').forEach(e=>e.classList.remove('cursor-char')); document.querySelectorAll('.cursor-word').forEach(e=>e.classList.remove('cursor-word'));
            if(wd){const r=document.getElementById(`row-${navWordIdx}`);if(r)r.classList.add('cursor-word')}
            else{const e=document.getElementById(`tile-${navWordIdx}-${navCharIdx}`);if(e)e.classList.add('cursor-char')}
        }
        function readSingleChar() {
            const c=parsedBoard[navWordIdx].chars[navCharIdx], p=navCharIdx+1;
            speak(!c.isLetter?`${p}. ${c.char}`:(c.isRevealed?`${p}. ${c.char}, ${NATO[c.char]||c.char}.`:`${p}. Nascosta.`));
        }
        function readWholeWord() {
            let s=""; parsedBoard[navWordIdx].chars.forEach(c=>s+=(c.isLetter&&!c.isRevealed)?"_":c.char);
            speak(`Parola ${navWordIdx+1}: ${s}`);
        }
        function readFullBoard() {
             // FIX SICUREZZA: Evita crash se tabellone non pronto
             if (!currentFrase || !parsedBoard.length) return speak("Tabellone non pronto.");
             
             let f=`Cat: ${currentFrase.categoria}. `; if(currentHintText)f+=`Indizio: ${currentHintText}. `;
             parsedBoard.forEach((w,i)=>{let s="";w.chars.forEach(c=>s+=c.isRevealed?c.char:" vuota ");f+=` P${i+1}: ${s}. `});
             speak(f);
        }

        async function doSpin() {
            if(isBtnDisabled('btn-spin')) return;
            // Check di sicurezza se i dati non sono ancora pronti
            if(!currentStanza || !currentStanza.giocatori) return speak("Attendere...");

            speak("Gira..."); playAudio('snd-spin'); isSpinning=true;
            
            // Disabilita tasti
            setBtnState('btn-spin', true); setBtnState('btn-solve', true); setBtnState('btn-vowel', true);

            wheelAngle+=(1000+Math.random()*500); document.getElementById('wheel-visual').style.transform=`rotate(${wheelAngle}deg)`;
            await new Promise(r=>setTimeout(r,3500));
            let v=WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
            
            if(v==='MISTERO'){
                v=['BANCAROTTA','PASSA','RADDOPPIA','JOLLY'][Math.floor(Math.random()*4)];
                
                if(v==='RADDOPPIA'){
                    const me = currentStanza.giocatori.find(p=>p.id===myId);
                    if(me){
                        await supabase.from('giocatori').update({punteggio_round:(me.punteggio_round||0)*2}).eq('id',myId);
                    }
                    speak("Raddoppia! Gira di nuovo!");
                    fetchFullState(); // Aggiorno subito per far vedere il punteggio doppio
                    isSpinning=false;
                    setBtnState('btn-spin', false); // Riabilita per girare
                    return; 
                }
                else if(v==='JOLLY'){
                    try {
                        const { error } = await supabase.rpc('incrementa_jolly', { id_giocatore: myId });
                        if(error) throw error;
                    } catch(e){console.error("Jolly err:", e);}
                    speak("Hai vinto un JOLLY! Gira di nuovo!");
                    fetchFullState(); // Aggiorno per mostrare il Jolly se servisse
                    isSpinning=false;
                    setBtnState('btn-spin', false); // Riabilita per girare
                    return; 
                }
            }
            
            isSpinning=false;
            await supabase.from('stanze').update({montepremi_round:(typeof v==='number'?v:0),ultima_azione:'gira_ruota',ultimo_messaggio:`${document.getElementById('inp-name').value} gira: ${v}`,azione_timestamp:new Date().toISOString()}).eq('id',roomId);
            
            if(typeof v==='number'&&v>0){
                fetchFullState();
                setTimeout(()=>openInput('letter'), 500); // Apre input in automatico
            }
            else if(v!==0){
                if(v==='BANCAROTTA')await supabase.from('giocatori').update({punteggio_round:0, punteggio_totale:0}).eq('id',myId);
                const nextPlayerIdx = (myIndex+1)%currentStanza.giocatori.length;
                await supabase.from('stanze').update({id_giocatore_corrente:nextPlayerIdx,montepremi_round:0}).eq('id',roomId);
                fetchFullState();
            }
        }

        function openInput(m) {
            if(m==='vowel') {
                // FIX HARDENING: Check di esistenza giocatore
                const me = currentStanza?.giocatori?.find(p => p.id === myId);
                if (!me) return speak("Giocatore non trovato, attendi.");
                if((me.punteggio_round||0)<500) return speak("Ti servono 500 euro!");
            }
            inputMode=m; const t={'letter':'INSERISCI CONSONANTE','vowel':'INSERISCI VOCALE','solve':'SCRIVI LA SOLUZIONE'};
            document.getElementById('input-title').textContent=t[m]; document.getElementById('input-area').classList.remove('hidden');
            const inp = document.getElementById('game-input');
            inp.value=''; 
            
            speak(t[m]);
            setTimeout(() => { inp.focus(); }, 100);
        }
        function closeInput(){document.getElementById('input-area').classList.add('hidden');inputMode=null;}

        async function submitInput() {
            if(isProcessingInput)return; isProcessingInput=true;
            const t=document.getElementById('game-input').value.trim().toUpperCase(); if(!t){isProcessingInput=false;return}
            const m=inputMode, c=t.charAt(0), isV=VOWELS_LIST.includes(c);
            if(m==='letter'&&isV){speak("Serve consonante");isProcessingInput=false;return} if(m==='vowel'&&!isV){speak("Serve vocale");isProcessingInput=false;return}
            closeInput(); const n=(myIndex+1)%currentStanza.giocatori.length;
            if(m==='solve'){
                if(cleanStr(t)===cleanStr(currentPuzzleText)){
                    const me=currentStanza.giocatori.find(p=>p.id===myId);
                    await supabase.from('giocatori').update({punteggio_totale:(me.punteggio_totale||0)+(me.punteggio_round||0),punteggio_round:0}).eq('id',myId);
                    const sol=currentPuzzleText.toUpperCase(); let allIdx=[], gIdx=0;
                    for(let i=0;i<sol.length;i++){if(sol[i].match(/[A-ZÀ-Ù]/)){allIdx.push(gIdx);gIdx++;}}
                    await supabase.from('stanze').update({stato:'finito',ultima_azione:'vittoria',ultimo_messaggio:`Ha vinto ${me.nome}`,montepremi_round:0,lettere_rivelate:allIdx}).eq('id',roomId);
                } else await supabase.from('stanze').update({id_giocatore_corrente:n,ultima_azione:'errore',ultimo_messaggio:`Errata: ${t}`,montepremi_round:0}).eq('id',roomId);
            } else {
                const sol=currentPuzzleText.toUpperCase(); let fd=[], gI=0;
                for(let i=0;i<sol.length;i++){if(sol[i].match(/[A-ZÀ-Ù]/)){if(cleanStr(sol[i])===cleanStr(c))fd.push(gI);gI++}}
                const oc=currentStanza.lettere_chiamate||[];
                if(oc.some(k=>cleanStr(k)===cleanStr(c))) await supabase.from('stanze').update({id_giocatore_corrente:n,ultima_azione:'chiama_lettera',ultimo_messaggio:`${c} già detta`,montepremi_round:0}).eq('id',roomId);
                else {
                    const nc=[...new Set([...oc,c])], me=currentStanza.giocatori.find(p=>p.id===myId);
                    if(m==='vowel')await supabase.from('giocatori').update({punteggio_round:(me.punteggio_round||0)-500}).eq('id',myId);
                    if(fd.length>0){
                        if(m==='letter')await supabase.from('giocatori').update({punteggio_round:(me.punteggio_round||0)+(currentStanza.montepremi_round*fd.length)}).eq('id',myId);
                        const newRev=[...new Set([...(currentStanza.lettere_rivelate||[]),...fd])];
                        await supabase.from('stanze').update({lettere_rivelate:newRev,lettere_chiamate:nc,ultima_azione:'chiama_lettera',ultimo_messaggio:`Trovate ${fd.length}`,montepremi_round:0,azione_timestamp:new Date().toISOString()}).eq('id',roomId);
                    } else await supabase.from('stanze').update({lettere_chiamate:nc,id_giocatore_corrente:n,ultima_azione:'chiama_lettera',ultimo_messaggio:`La ${c} non c'è`,montepremi_round:0,azione_timestamp:new Date().toISOString()}).eq('id',roomId);
                }
            }
            isProcessingInput=false; fetchFullState();
        }

        function openInspector(){
            // FIX SICUREZZA: Evita crash se tabellone vuoto
            if(!currentFrase) return speak("Nessuna frase caricata.");
            
            const d=document.getElementById('inspector-content'); let h=`<h2>${currentFrase.categoria}</h2>`;
            parsedBoard.forEach((w,i)=>{let s="";w.chars.forEach(c=>{s+=c.isRevealed?c.char:"_"});h+=`<p>P${i+1}: ${s}</p>`});
            d.innerHTML=h; document.getElementById('inspector-overlay').classList.remove('hidden'); speak("Ispettore Aperto");
        }
        function closeInspector(){document.getElementById('inspector-overlay').classList.add('hidden');}
        
        function readRevealedLetters(){
            if(!currentStanza) return;
            const calls=currentStanza.lettere_chiamate||[];
            const sol = cleanStr(currentPuzzleText).toUpperCase();
            const h = calls.filter(c => sol.includes(cleanStr(c).toUpperCase())).sort();
            if(h.length > 0) speak("Lettere presenti: " + h.map(c => `${c}, ${NATO[c]||c}`).join(". "));
            else speak("Nessuna lettera presente rivelata.");
        }
        
        function readHistory(){
            speak(actionLog.length > 0 ? "Ultime azioni: " + actionLog.join(". ") : "Nessuna azione.");
        }

        async function startNewRound(){
            if(!isHost) return speak("Solo l'host può avviare il round");
            const nr=(currentStanza.round_giocati||1) + (currentStanza.stato==='attesa'?0:1);
            if(nr>10){await supabase.from('stanze').update({stato:'terminata'}).eq('id',roomId);return}
            const {data:fr}=await supabase.from('frasi').select('id');
            
            // FIX HARDENING: Controllo frasi vuote
            if (!fr || fr.length === 0) {
                speak("Nessuna frase nel database!");
                return;
            }

            const rid=fr[Math.floor(Math.random()*fr.length)].id;
            if(currentStanza.stato!=='attesa') await supabase.from('giocatori').update({punteggio_round:0}).eq('stanza_id',roomId);
            await supabase.from('stanze').update({frase_corrente_id:rid,stato:'gioco',lettere_rivelate:[],lettere_chiamate:[],montepremi_round:0,round_giocati:nr,ultima_azione:'nuovo',ultimo_messaggio:`Round ${nr}`,azione_timestamp:new Date().toISOString()}).eq('id',roomId);
            fetchFullState();
        }

        document.addEventListener('keydown',e=>{
            // GESTIONE INPUT DI TESTO
            if(document.activeElement.tagName==='INPUT'){
                if(e.key==='Enter')submitInput();
                return;
            }
            if(!document.getElementById('round-over-panel').classList.contains('hidden')&&e.key==='Enter'){startNewRound();return}

            // TASTI RAPIDI
            const key = e.key.toLowerCase();
            
            // CTRL+L: Leggi lettere presenti
            if(e.ctrlKey && key === 'l'){
                e.preventDefault(); 
                readRevealedLetters();
                return;
            }
            // CTRL+I: Ispettore
            if(e.ctrlKey && key === 'i'){ e.preventDefault(); openInspector(); return; }

            // TASTO A: Leggi storia (solo se non si preme Ctrl/Alt)
            if(key === 'a' && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                readHistory();
                return;
            }

            if(e.key==='Escape'){if(inputMode)closeInput();else closeInspector()}

            if(!inputMode){
                if(key==='g') doSpin(); 
                if(key==='v') openInput('vowel');
                if(key==='s') openInput('solve'); 
                if(key==='c') toggleContrast();
            }

            // Navigazione tastiera (Pc)
            if(e.key==='ArrowRight'){e.preventDefault();e.ctrlKey?moveWordNav(1):moveNav(1)}
            if(e.key==='ArrowLeft'){e.preventDefault();e.ctrlKey?moveWordNav(-1):moveNav(-1)}
            if(e.key==='ArrowDown'){e.preventDefault();moveWordNav(1)} if(e.key==='ArrowUp'){e.preventDefault();moveWordNav(-1)}
        });
    </script>
</body>
</html>