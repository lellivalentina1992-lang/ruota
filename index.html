<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ruota Multiplayer – Test turni, punteggi e ruota</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #002b4e;
      color: #f5f5f5;
    }
    main {
      max-width: 960px;
      margin: 0 auto;
    }
    h1, h2, h3 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 0.5rem;
      background: rgba(0,0,0,0.25);
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input {
      width: 100%;
      max-width: 280px;
      padding: 0.4rem;
      margin-top: 0.2rem;
      border-radius: 0.3rem;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 0.8rem;
      margin-right: 0.5rem;
      padding: 0.5rem 0.9rem;
      border-radius: 0.4rem;
      border: none;
      cursor: pointer;
      background: #f3922b;
      color: #002b4e;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    ul {
      padding-left: 1.2rem;
    }
    .small {
      font-size: 0.9rem;
      opacity: 0.85;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <main>
    <h1>Ruota Multiplayer – Test turni, punteggi e ruota</h1>
    <p>
      Questa pagina è SOLO un test del multiplayer: giocatori, turni, punteggi e una
      <strong>ruota di prova</strong> condivisa via Supabase. Niente grafica, solo logica.
    </p>

    <section aria-labelledby="sec-conn">
      <h2 id="sec-conn">1. Dati del giocatore e stanza</h2>

      <label for="playerName">Il tuo nome (come comparirà agli altri):</label>
      <input id="playerName" type="text" autocomplete="off" />

      <label for="roomCode">Codice stanza (es. ABC123):</label>
      <input id="roomCode" type="text" autocomplete="off" />

      <button id="createRoomBtn">Crea nuova stanza</button>
      <button id="joinRoomBtn">Entra in stanza esistente</button>

      <p class="small">
        Per provare: apri questa pagina da due dispositivi, usa lo stesso codice stanza
        e verifica che turni, punteggi e ruota siano uguali per tutti.
      </p>

      <div id="status" aria-live="polite"></div>

      <!-- Area annunci SOLO per screen reader -->
      <div
        id="sr-updates"
        class="sr-only"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      ></div>
    </section>

    <section aria-labelledby="sec-room">
      <h2 id="sec-room">2. Stanza corrente</h2>
      <p id="currentRoomLabel">Nessuna stanza ancora collegata.</p>

      <h3>Giocatori collegati</h3>
      <ul id="playersList"></ul>

      <h3>Turno corrente</h3>
      <p>Sta giocando: <strong id="currentTurnLabel">–</strong></p>

      <h3>Tabellone punteggi (test)</h3>
      <ul id="scoresList"></ul>

      <h3>Ultima casella ruota (test)</h3>
      <p id="lastSpinLabel">–</p>

      <h3>Azioni di prova</h3>
      <button id="spinWheelBtn" disabled>Gira la ruota (test)</button>
      <button id="addPointsBtn" disabled>Aggiungi 100 punti a me (test)</button>
      <button id="nextTurnBtn" disabled>Passa il turno al prossimo giocatore</button>

      <h3>Log eventi (test)</h3>
      <ul id="logList"></ul>

      <p class="small">
        Se questo test funziona, qui poi metteremo la logica completa della Ruota
        (consonanti, vocali, frase, ecc.) usando lo stesso stato condiviso.
      </p>
    </section>
  </main>

  <script>
    // === CONFIGURAZIONE SUPABASE ===
    const SUPABASE_URL = "https://azcwkpdjbysnivknnino.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === RIFERIMENTI DOM ===
    const playerNameInput = document.getElementById("playerName");
    const roomCodeInput = document.getElementById("roomCode");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const joinRoomBtn = document.getElementById("joinRoomBtn");
    const statusEl = document.getElementById("status");
    const srUpdatesEl = document.getElementById("sr-updates");
    const currentRoomLabel = document.getElementById("currentRoomLabel");
    const playersList = document.getElementById("playersList");
    const currentTurnLabel = document.getElementById("currentTurnLabel");
    const scoresList = document.getElementById("scoresList");
    const lastSpinLabel = document.getElementById("lastSpinLabel");
    const logList = document.getElementById("logList");
    const spinWheelBtn = document.getElementById("spinWheelBtn");
    const addPointsBtn = document.getElementById("addPointsBtn");
    const nextTurnBtn = document.getElementById("nextTurnBtn");

    let currentRoomId = null;
    let currentPlayerName = null;
    let currentState = null;
    let realtimeChannel = null;

    // Ruota di TEST
    const TEST_WHEEL_SEGMENTS = [
      { type: "money", value: 100, label: "+100 punti" },
      { type: "money", value: 200, label: "+200 punti" },
      { type: "money", value: 300, label: "+300 punti" },
      { type: "bankrupt", label: "Perdi tutto, punteggio azzerato" },
      { type: "loseTurn", label: "Perdi il turno, passa al prossimo" }
    ];

    function setStatus(text) {
      console.log(text);
      statusEl.textContent = text;
    }

    function announceForScreenReader(text) {
      // forza un cambio per far reagire NVDA
      srUpdatesEl.textContent = "";
      setTimeout(() => {
        srUpdatesEl.textContent = text;
      }, 10);
    }

    function normalizzaCodiceRoom(raw) {
      return (raw || "").trim().toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 8);
    }

    function generaCodiceRoom() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for (let i = 0; i < 6; i++) {
        out += chars[Math.floor(Math.random() * chars.length)];
      }
      return out;
    }

    function ensureStateShape(state) {
      if (!state || typeof state !== "object") state = {};
      if (!Array.isArray(state.players)) state.players = [];
      if (typeof state.currentPlayerIndex !== "number") state.currentPlayerIndex = 0;
      if (!state.scores || typeof state.scores !== "object") state.scores = {};
      if (typeof state.lastSpin !== "string") state.lastSpin = "Nessuna";
      if (!Array.isArray(state.log)) state.log = [];

      state.players.forEach((name) => {
        if (typeof state.scores[name] !== "number") {
          state.scores[name] = 0;
        }
      });

      if (state.players.length === 0) {
        state.currentPlayerIndex = 0;
      } else if (
        state.currentPlayerIndex < 0 ||
        state.currentPlayerIndex >= state.players.length
      ) {
        state.currentPlayerIndex = 0;
      }

      return state;
    }

    function appendLogEntry(state, text) {
      state.log.push(text);
      if (state.log.length > 20) {
        state.log = state.log.slice(state.log.length - 20);
      }
    }

    function renderState() {
      if (!currentState) {
        currentRoomLabel.textContent = "Nessuna stanza ancora collegata.";
        playersList.innerHTML = "";
        scoresList.innerHTML = "";
        currentTurnLabel.textContent = "–";
        lastSpinLabel.textContent = "–";
        logList.innerHTML = "";
        spinWheelBtn.disabled = true;
        addPointsBtn.disabled = true;
        nextTurnBtn.disabled = true;
        return;
      }

      currentState = ensureStateShape(currentState);

      currentRoomLabel.textContent =
        "Stanza " + currentRoomId + " – giocatore: " + currentPlayerName;

      // Giocatori
      playersList.innerHTML = "";
      currentState.players.forEach((name) => {
        const li = document.createElement("li");
        li.textContent = name;
        playersList.appendChild(li);
      });

      // Turno
      let currentTurnName = "–";
      if (
        currentState.players.length > 0 &&
        typeof currentState.currentPlayerIndex === "number" &&
        currentState.currentPlayerIndex >= 0 &&
        currentState.currentPlayerIndex < currentState.players.length
      ) {
        currentTurnName = currentState.players[currentState.currentPlayerIndex];
      }
      currentTurnLabel.textContent = currentTurnName;

      // Punteggi
      scoresList.innerHTML = "";
      currentState.players.forEach((name) => {
        const li = document.createElement("li");
        const score =
          typeof currentState.scores[name] === "number"
            ? currentState.scores[name]
            : 0;
        li.textContent = name + ": " + score + " punti";
        scoresList.appendChild(li);
      });

      // Ultima casella
      lastSpinLabel.textContent = currentState.lastSpin || "Nessuna";

      // Log visivo
      logList.innerHTML = "";
      currentState.log.forEach((entry) => {
        const li = document.createElement("li");
        li.textContent = entry;
        logList.appendChild(li);
      });

      const inRoom = !!currentRoomId && !!currentPlayerName;
      const hasPlayers = currentState.players.length > 0;

      spinWheelBtn.disabled = !inRoom || !hasPlayers;
      addPointsBtn.disabled = !inRoom;
      nextTurnBtn.disabled = !inRoom || !hasPlayers;
    }

    async function caricaStanza(roomId) {
      const { data, error } = await supabase
        .from("rooms")
        .select("id, state")
        .eq("id", roomId)
        .maybeSingle();

      if (error) {
        console.error(error);
        setStatus("Errore nel leggere la stanza: " + error.message);
        return null;
      }
      if (!data) {
        setStatus("Nessuna stanza trovata con codice " + roomId);
        return null;
      }
      return data;
    }

    async function salvaStato(roomId, newState) {
      newState = ensureStateShape(newState);

      const { error } = await supabase
        .from("rooms")
        .update({
          state: newState,
          updated_at: new Date().toISOString(),
        })
        .eq("id", roomId);

      if (error) {
        console.error(error);
        setStatus("Errore nel salvare lo stato: " + error.message);
        return false;
      }

      if (realtimeChannel) {
        realtimeChannel.send({
          type: "broadcast",
          event: "state",
          payload: {}
        });
      }

      return true;
    }

    async function creaNuovaStanza() {
      const rawName = playerNameInput.value.trim();
      if (!rawName) {
        setStatus("Scrivi prima il tuo nome.");
        playerNameInput.focus();
        return;
      }
      currentPlayerName = rawName;
      const roomId =
        normalizzaCodiceRoom(roomCodeInput.value) || generaCodiceRoom();

      const initialState = {
        createdAt: new Date().toISOString(),
        players: [currentPlayerName],
        currentPlayerIndex: 0,
        scores: { [currentPlayerName]: 0 },
        lastSpin: "Nessuna",
        log: ["Stanza creata da " + currentPlayerName],
      };

      const { error } = await supabase.from("rooms").insert({
        id: roomId,
        state: initialState,
      });

      if (error) {
        if (error.code === "23505") {
          setStatus(
            "Esiste già una stanza con questo codice. Usa 'Entra in stanza'."
          );
        } else {
          console.error(error);
          setStatus("Errore nel creare la stanza: " + error.message);
        }
        return;
      }

      currentRoomId = roomId;
      currentState = initialState;
      attivaRealtimePerStanza(roomId);

      setStatus("Stanza " + roomId + " creata. Ora sei collegata.");
      announceForScreenReader("Stanza " + roomId + " creata. Sei il primo giocatore.");
      roomCodeInput.value = roomId;
      renderState();
    }

    async function entraInStanzaEsistente() {
      const rawName = playerNameInput.value.trim();
      if (!rawName) {
        setStatus("Scrivi prima il tuo nome.");
        playerNameInput.focus();
        return;
      }
      const roomId = normalizzaCodiceRoom(roomCodeInput.value);
      if (!roomId) {
        setStatus("Scrivi un codice stanza valido (es. ABC123).");
        roomCodeInput.focus();
        return;
      }
      currentPlayerName = rawName;

      const data = await caricaStanza(roomId);
      if (!data) return;

      currentRoomId = roomId;
      let state = data.state || {};
      state = ensureStateShape(state);

      let joinedNow = false;
      if (!state.players.includes(currentPlayerName)) {
        state.players.push(currentPlayerName);
        appendLogEntry(state, currentPlayerName + " è entrato nella stanza.");
        joinedNow = true;
      }
      if (typeof state.scores[currentPlayerName] !== "number") {
        state.scores[currentPlayerName] = 0;
      }

      const ok = await salvaStato(roomId, state);
      if (!ok) return;

      currentState = state;
      attivaRealtimePerStanza(roomId);

      setStatus("Sei entrata nella stanza " + roomId + ".");
      if (joinedNow) {
        announceForScreenReader(
          "Sei entrata nella stanza " + roomId + " con altri giocatori già presenti."
        );
      } else {
        announceForScreenReader("Sei rientrata nella stanza " + roomId + ".");
      }
      renderState();
    }

    function descriviDifferenze(oldState, newState) {
      if (!newState) return "";

      oldState = ensureStateShape(oldState || {});
      newState = ensureStateShape(newState);

      let parti = [];

      // Cambio turno
      const oldTurnName =
        oldState.players && oldState.players.length > 0
          ? oldState.players[oldState.currentPlayerIndex] || null
          : null;
      const newTurnName =
        newState.players && newState.players.length > 0
          ? newState.players[newState.currentPlayerIndex] || null
          : null;

      if (newTurnName && newTurnName !== oldTurnName) {
        parti.push("Ora è il turno di " + newTurnName + ".");
      }

      // Cambi punteggio
      newState.players.forEach((name) => {
        const oldScore =
          typeof oldState.scores[name] === "number" ? oldState.scores[name] : 0;
        const newScore =
          typeof newState.scores[name] === "number" ? newState.scores[name] : 0;
        if (newScore !== oldScore) {
          parti.push(name + " ora ha " + newScore + " punti.");
        }
      });

      // Nuovo giocatore
      newState.players.forEach((name) => {
        if (!oldState.players.includes(name)) {
          parti.push(name + " è entrato nella stanza.");
        }
      });

      // Ultima casella ruota
      if (newState.lastSpin && newState.lastSpin !== oldState.lastSpin) {
        parti.push("Ultimo risultato ruota: " + newState.lastSpin + ".");
      }

      return parti.join(" ");
    }

    function attivaRealtimePerStanza(roomId) {
      if (realtimeChannel) {
        realtimeChannel.unsubscribe();
        realtimeChannel = null;
      }

      realtimeChannel = supabase
        .channel("room-" + roomId, {
          config: {
            broadcast: {
              self: false, // NON inviare gli eventi a chi li ha originati
            },
          },
        })
        .on("broadcast", { event: "state" }, async (_payload) => {
          if (!currentRoomId) return;

          const oldState = currentState
            ? JSON.parse(JSON.stringify(currentState))
            : null;

          const data = await caricaStanza(currentRoomId);
          if (data && data.state) {
            const newState = ensureStateShape(data.state);
            const messaggio = descriviDifferenze(oldState, newState);

            currentState = newState;
            renderState();

            setStatus(
              "Stato aggiornato in tempo reale dalla stanza " + currentRoomId + "."
            );

            if (messaggio) {
              announceForScreenReader(messaggio);
            }
          }
        })
        .subscribe((status) => {
          console.log("Stato canale realtime:", status);
        });
    }

    async function aggiungiPuntiAlGiocatoreCorrente() {
      if (!currentRoomId || !currentPlayerName || !currentState) return;
      currentState = ensureStateShape(currentState);
      if (typeof currentState.scores[currentPlayerName] !== "number") {
        currentState.scores[currentPlayerName] = 0;
      }
      currentState.scores[currentPlayerName] += 100;
      appendLogEntry(
        currentState,
        currentPlayerName + " riceve +100 punti (test manuale)."
      );
      currentState.lastSpin = "Bonus manuale +100 punti a " + currentPlayerName;
      const ok = await salvaStato(currentRoomId, currentState);
      if (!ok) return;
      // ANNUNCIO locale immediato
      announceForScreenReader(
        currentPlayerName + " ora ha " + currentState.scores[currentPlayerName] + " punti."
      );
      renderState();
    }

    async function passaAlProssimoTurno() {
      if (!currentRoomId || !currentState) return;
      currentState = ensureStateShape(currentState);
      if (currentState.players.length === 0) return;
      const prevName =
        currentState.players[currentState.currentPlayerIndex] ||
        "Giocatore sconosciuto";
      currentState.currentPlayerIndex =
        (currentState.currentPlayerIndex + 1) % currentState.players.length;
      const newName =
        currentState.players[currentState.currentPlayerIndex] ||
        "Giocatore sconosciuto";
      appendLogEntry(
        currentState,
        "Il turno passa da " + prevName + " a " + newName + "."
      );
      const ok = await salvaStato(currentRoomId, currentState);
      if (!ok) return;
      // ANNUNCIO locale immediato
      announceForScreenReader("Ora è il turno di " + newName + ".");
      renderState();
    }

    async function giraRuotaTest() {
      if (!currentRoomId || !currentState) return;
      currentState = ensureStateShape(currentState);
      if (currentState.players.length === 0) return;

      const currentName =
        currentState.players[currentState.currentPlayerIndex] ||
        currentPlayerName ||
        "Giocatore";

      const seg =
        TEST_WHEEL_SEGMENTS[
          Math.floor(Math.random() * TEST_WHEEL_SEGMENTS.length)
        ];

      let logEntry = currentName + " gira la ruota: " + seg.label + ".";

      if (seg.type === "money") {
        if (typeof currentState.scores[currentName] !== "number") {
          currentState.scores[currentName] = 0;
        }
        currentState.scores[currentName] += seg.value;
        logEntry +=
          " Nuovo punteggio: " + currentState.scores[currentName] + " punti.";
        announceForScreenReader(
          currentName +
            " ottiene " +
            seg.value +
            " punti. Totale " +
            currentState.scores[currentName] +
            " punti."
        );
      } else if (seg.type === "bankrupt") {
        currentState.scores[currentName] = 0;
        logEntry += " Il punteggio di " + currentName + " torna a 0.";
        announceForScreenReader(
          seg.label + ". Il punteggio di " + currentName + " torna a zero."
        );
      } else if (seg.type === "loseTurn") {
        currentState.currentPlayerIndex =
          (currentState.currentPlayerIndex + 1) % currentState.players.length;
        const newName =
          currentState.players[currentState.currentPlayerIndex] ||
          "Giocatore sconosciuto";
        logEntry += " Il turno passa a " + newName + ".";
        announceForScreenReader(
          seg.label + ". Ora è il turno di " + newName + "."
        );
      } else {
        announceForScreenReader(seg.label);
      }

      currentState.lastSpin = seg.label;
      appendLogEntry(currentState, logEntry);

      const ok = await salvaStato(currentRoomId, currentState);
      if (!ok) return;
      renderState();
    }

    // === EVENTI UI ===
    createRoomBtn.addEventListener("click", () => {
      creaNuovaStanza();
    });

    joinRoomBtn.addEventListener("click", () => {
      entraInStanzaEsistente();
    });

    addPointsBtn.addEventListener("click", () => {
      aggiungiPuntiAlGiocatoreCorrente();
    });

    nextTurnBtn.addEventListener("click", () => {
      passaAlProssimoTurno();
    });

    spinWheelBtn.addEventListener("click", () => {
      giraRuotaTest();
    });

    setStatus("Inserisci il tuo nome e un codice stanza per iniziare.");
  </script>
</body>
</html>
