<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - Accessibile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Stile ad alto contrasto e pulito per ipovisione/cecità */
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: left;
        }
        h1 { color: #ffd700; font-size: 1.5em; }
        h2 { color: #4caf50; font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Box che sostituisce la ruota grafica */
        #wheel-status {
            border: 2px solid #ffd700;
            background: #222;
            padding: 15px;
            margin: 15px 0;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }

        /* Il tabellone in formato testo chiaro */
        #board-text {
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            letter-spacing: 3px;
            background: #000;
            padding: 15px;
            border: 1px solid #555;
            margin: 10px 0;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .status-bar {
            background: #333;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        input, button {
            font-size: 1.1em;
            padding: 10px;
            margin: 5px 0;
        }
        input { width: 100%; box-sizing: border-box; }
        
        button {
            background-color: #ffd700;
            color: #000;
            border: none;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        button:disabled { background-color: #555; color: #aaa; }

        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<div class="container">
    <h1>LA RUOTA - Modalità Semplificata</h1>

    <div id="setup-panel">
        <label for="inp-name">Tuo Nome:</label>
        <input id="inp-name" type="text" placeholder="Nome">
        
        <label for="inp-code">Codice Stanza:</label>
        <input id="inp-code" type="text" placeholder="Es. CASA">
        
        <button onclick="joinGame(true)">Crea Nuova Stanza</button>
        <button onclick="joinGame(false)">Entra in Stanza</button>
        <p id="connection-msg" role="alert"></p>
    </div>

    <div id="game-panel" style="display:none;">
        
        <div class="status-bar">
            <div id="turn-indicator" aria-live="polite">In attesa...</div>
            <div id="my-score">Il tuo punteggio: €0</div>
        </div>

        <h2>TABELLONE (F3 per rileggere)</h2>
        <div id="category-info">Categoria: ...</div>
        <div id="board-text" aria-label="Tabellone">_ _ _ _</div>

        <h2>RUOTA E AZIONI</h2>
        <div id="wheel-status" role="status">Ruota ferma.</div>

        <div id="controls-main">
            <button id="btn-spin" onclick="doSpin()">GIRA RUOTA (Ctrl+G)</button>
            <button id="btn-vowel" onclick="askInput('vowel')">COMPRA VOCALE €500 (Ctrl+V)</button>
            <button id="btn-solve" onclick="askInput('solve')">RISOLVI (Ctrl+S)</button>
        </div>

        <div id="input-area" style="display:none; background:#330000; padding:15px; margin-top:10px;">
            <label id="input-label" for="game-input">Inserisci:</label>
            <input id="game-input" type="text" autocomplete="off">
            <button onclick="submitInput()">CONFERMA (Invio)</button>
            <button onclick="cancelInput()">ANNULLA (Esc)</button>
        </div>

        <div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
            <h3>Giocatori:</h3>
            <ul id="player-list" style="list-style:none; padding:0;"></ul>
        </div>

        <div id="host-controls" style="display:none; margin-top:20px;">
            <button style="background:#444; color:white;" onclick="newRound()">[HOST] Nuovo Round</button>
        </div>
    </div>
</div>

<audio id="audio-spin" src="ruota.wav"></audio>
<audio id="audio-hit" src="lettera presente.wav"></audio>
<audio id="audio-miss" src="lettera assente.wav"></audio>

<script>
    // --- CONFIGURAZIONE ---
    const SUPABASE_URL = 'https://azcwkpdjbysnivknnino.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Valori ruota
    const WHEEL_VALUES = [100, 200, 300, 400, 500, 1000, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO'];
    
    // Stato Globale
    let myId = null;
    let myRoomId = null;
    let myIndex = null;
    let amIHost = false;
    let roomState = {};
    let curSol = ""; 
    let curSolDisplay = "";
    let inputMode = null; // 'letter', 'vowel', 'solve'
    let isSpinning = false;

    // --- ACCESSIBILITÀ E UI ---
    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = '';
        setTimeout(() => { el.textContent = text; }, 50);
    }

    function play(id) {
        const audio = document.getElementById(id);
        if(audio) { audio.currentTime=0; audio.play().catch(()=>{}); }
    }

    // --- LOGICA DI GIOCO ---

    async function joinGame(create) {
        const name = document.getElementById('inp-name').value.trim().toUpperCase();
        const code = document.getElementById('inp-code').value.trim().toUpperCase();
        if(!name || !code) { speak("Inserisci nome e codice."); return; }

        let rId;
        
        if (create) {
            const { data, error } = await supabase.from('stanze').insert({ codice: code, stato: 'attesa' }).select().single();
            if(error) { speak("Errore o codice esistente."); return; }
            rId = data.id;
            amIHost = true;
        } else {
            const { data, error } = await supabase.from('stanze').select('*').eq('codice', code).maybeSingle();
            if(!data) { speak("Stanza non trovata."); return; }
            rId = data.id;
        }

        // Gestione Giocatore (nuovo o riconnessione)
        const { data: existing } = await supabase.from('giocatori').select('*').eq('stanza_id', rId).eq('nome', name).maybeSingle();
        
        let pData;
        if(existing) {
            pData = existing;
            speak("Bentornato " + name);
        } else {
            const { count } = await supabase.from('giocatori').select('*', { count: 'exact', head: true }).eq('stanza_id', rId);
            const idx = count || 0;
            const { data: created } = await supabase.from('giocatori').insert({
                stanza_id: rId, nome: name, indice: idx, is_host: amIHost
            }).select().single();
            pData = created;
            speak("Connesso alla stanza " + code);
        }

        myId = pData.id;
        myRoomId = rId;
        myIndex = pData.indice;
        amIHost = pData.is_host;

        // Switch UI
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('game-panel').style.display = 'block';
        if(amIHost) document.getElementById('host-controls').style.display = 'block';

        startSync();
    }

    function startSync() {
        const ch = supabase.channel('room-'+myRoomId)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'stanze', filter: 'id=eq.'+myRoomId }, 
                payload => updateRoom(payload.new))
            .on('postgres_changes', { event: '*', schema: 'public', table: 'giocatori', filter: 'stanza_id=eq.'+myRoomId }, 
                () => updatePlayers())
            .subscribe();
        
        // Primo fetch
        supabase.from('stanze').select('*').eq('id', myRoomId).single().then(res => updateRoom(res.data));
        updatePlayers();
    }

    async function updateRoom(data) {
        if(!data) return;
        roomState = data;

        // Aggiorna Frase
        if(data.frase_corrente_id) {
            if(!curSol || data.stato === 'attesa') {
                 const { data: f } = await supabase.from('frasi').select('*').eq('id', data.frase_corrente_id).single();
                 if(f) {
                     curSol = f.soluzione.toUpperCase();
                     document.getElementById('category-info').textContent = "Categoria: " + f.categoria;
                 }
            }
        }
        
        // Calcola Display Tabellone
        if(curSol) {
            let disp = "";
            let revealed = data.lettere_rivelate || [];
            // Normalizzazione semplice per confronto
            const cleanSol = curSol.replace(/[ÀÁ]/g,'A').replace(/[ÈÉ]/g,'E').replace(/[ÌÍ]/g,'I').replace(/[ÒÓ]/g,'O').replace(/[ÙÚ]/g,'U');
            
            for(let i=0; i<curSol.length; i++) {
                let char = curSol[i];
                if(/[^A-ZÀ-Ù]/.test(char)) {
                    disp += char; // Spazi o simboli
                } else {
                    if(revealed.includes(i)) disp += char;
                    else disp += "_";
                }
                disp += " "; // Spaziatura per lettura migliore
            }
            curSolDisplay = disp;
            document.getElementById('board-text').textContent = disp;
        }

        // Info Turno
        const isMyTurn = (roomState.id_giocatore_corrente === myIndex);
        const turnDiv = document.getElementById('turn-indicator');
        
        if(isMyTurn) {
            turnDiv.textContent = "È IL TUO TURNO!";
            turnDiv.style.color = "#00ff00";
            document.getElementById('btn-spin').disabled = false;
            document.getElementById('btn-vowel').disabled = false;
            document.getElementById('btn-solve').disabled = false;
            
            // Se c'è un valore attivo e non ho ancora chiamato la lettera
            if(data.montepremi_round > 0 && inputMode === null && !isSpinning) {
                 // Automatismo: se il valore è numerico, chiedi consonante
                 askInput('letter');
            }
        } else {
            turnDiv.textContent = "Turno del giocatore " + roomState.id_giocatore_corrente;
            turnDiv.style.color = "#ffffff";
            document.getElementById('btn-spin').disabled = true;
            document.getElementById('btn-vowel').disabled = true;
            document.getElementById('btn-solve').disabled = true;
            if(inputMode !== null) cancelInput(); // Chiudi input se perdo turno
        }

        // Status Ruota
        const wStat = document.getElementById('wheel-status');
        if(data.montepremi_round > 0) wStat.textContent = "Valore Attivo: €" + data.montepremi_round;
        else wStat.textContent = "Ruota ferma.";
    }

    async function updatePlayers() {
        const { data } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        data.forEach(p => {
            const li = document.createElement('li');
            li.textContent = `${p.nome}: €${p.punteggio_totale} (Jolly: ${p.jolly})`;
            if(p.indice === roomState.id_giocatore_corrente) li.style.color = "#00ff00";
            list.appendChild(li);

            if(p.id === myId) {
                document.getElementById('my-score').textContent = "Il tuo punteggio: €" + p.punteggio_totale;
            }
        });
    }

    // --- AZIONI ---

    function doSpin() {
        if(isSpinning) return;
        isSpinning = true;
        play('audio-spin');
        speak("La ruota gira...");
        document.getElementById('wheel-status').textContent = "GIRANDO...";

        setTimeout(async () => {
            isSpinning = false;
            const val = WHEEL_VALUES[Math.floor(Math.random() * WHEEL_VALUES.length)];
            
            if(val === 'BANCAROTTA') {
                speak("Bancarotta. Punti azzerati.");
                await supabase.from('giocatori').update({ punteggio_totale: 0 }).eq('id', myId);
                passTurn();
            } else if (val === 'PASSA') {
                speak("Passa la mano.");
                passTurn();
            } else if (val === 'MISTERO') {
                speak("Mistero! Guadagni un Jolly."); // Semplificato
                await supabase.rpc('increment_jolly', { row_id: myId }); // Richiede RPC su DB, o logica lato client:
                // Fallback client se RPC non c'è:
                const { data: me } = await supabase.from('giocatori').select('jolly').eq('id', myId).single();
                await supabase.from('giocatori').update({ jolly: me.jolly+1 }).eq('id', myId);
            } else {
                speak("Valore: " + val + " euro. Inserisci consonante.");
                await supabase.from('stanze').update({ montepremi_round: val }).eq('id', myRoomId);
                // Input si apre automaticamente grazie a updateRoom
            }
        }, 3000);
    }

    function askInput(mode) {
        inputMode = mode;
        const area = document.getElementById('input-area');
        const label = document.getElementById('input-label');
        const inp = document.getElementById('game-input');
        
        area.style.display = 'block';
        inp.value = '';
        inp.focus();

        if(mode === 'letter') label.textContent = "Consonante (Valore: €"+roomState.montepremi_round+"):";
        if(mode === 'vowel') label.textContent = "Vocale (Costo €500):";
        if(mode === 'solve') label.textContent = "Soluzione Completa:";
    }

    function cancelInput() {
        document.getElementById('input-area').style.display = 'none';
        inputMode = null;
    }

    async function submitInput() {
        const txt = document.getElementById('game-input').value.toUpperCase().trim();
        if(!txt) return;
        cancelInput();

        // LOGICA RISOLVI
        if(inputMode === 'solve') {
            const normSol = curSol.replace(/[^A-Z]/g,''); // Solo lettere
            const normInp = txt.replace(/[^A-Z]/g,'');
            if(normSol === normInp) {
                play('audio-hit');
                speak("Esatto! Hai vinto il round.");
                // Bonus vittoria semplificato
                await supabase.from('stanze').update({ stato: 'attesa', montepremi_round: 0 }).eq('id', myRoomId);
            } else {
                play('audio-miss');
                speak("Sbagliato. Passi il turno.");
                passTurn();
            }
            return;
        }

        // LOGICA LETTERA/VOCALE
        const char = txt.charAt(0);
        const isVowel = "AEIOU".includes(char);
        
        if(inputMode === 'letter' && isVowel) { speak("Devi dire una consonante."); return; }
        if(inputMode === 'vowel' && !isVowel) { speak("Devi dire una vocale."); return; }
        
        if(inputMode === 'vowel') {
            // Paga vocale (codice semplificato, in prod controlla saldo)
            const { data: me } = await supabase.from('giocatori').select('punteggio_totale').eq('id', myId).single();
            await supabase.from('giocatori').update({ punteggio_totale: me.punteggio_totale - 500 }).eq('id', myId);
        }

        // Cerca nel testo
        let count = 0;
        let indices = [];
        const normSol = curSol.replace(/[ÀÁ]/g,'A').replace(/[ÈÉ]/g,'E').replace(/[ÌÍ]/g,'I').replace(/[ÒÓ]/g,'O').replace(/[ÙÚ]/g,'U');
        
        for(let i=0; i<normSol.length; i++) {
            if(normSol[i] === char) {
                count++;
                indices.push(i);
            }
        }

        if(count > 0) {
            play('audio-hit');
            speak("Ci sono " + count + " " + char);
            
            // Aggiorna rivelate
            let oldRev = roomState.lettere_rivelate || [];
            let newRev = [...new Set([...oldRev, ...indices])];
            
            let money = 0;
            if(inputMode === 'letter') {
                const { data: me } = await supabase.from('giocatori').select('punteggio_totale').eq('id', myId).single();
                money = roomState.montepremi_round * count;
                await supabase.from('giocatori').update({ punteggio_totale: me.punteggio_totale + money }).eq('id', myId);
            }
            
            await supabase.from('stanze').update({ lettere_rivelate: newRev }).eq('id', myRoomId);
            // NON passo il turno se indovino
        } else {
            play('audio-miss');
            speak("Nessuna " + char);
            passTurn();
        }
    }

    async function passTurn() {
        const { data: players } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
        const nextIdx = (myIndex + 1) % players.length;
        await supabase.from('stanze').update({ id_giocatore_corrente: nextIdx, montepremi_round: 0 }).eq('id', myRoomId);
    }

    async function newRound() {
        // Scegli frase a caso (ID hardcoded per test se DB vuoto, idealmente fetch)
        const { data: frasi } = await supabase.from('frasi').select('*');
        const f = frasi[Math.floor(Math.random()*frasi.length)];
        await supabase.from('stanze').update({
            stato: 'gioco',
            frase_corrente_id: f.id,
            lettere_rivelate: [],
            montepremi_round: 0
        }).eq('id', myRoomId);
    }

    // Scorciatoie Tastiera
    document.addEventListener('keydown', e => {
        if(e.key === 'F3') { e.preventDefault(); speak("Tabellone: " + curSolDisplay.replace(/_/g,'vuoto')); }
        if(amIHost && e.key === 'F2') { /* Info stato */ }
        
        if(inputMode) {
            if(e.key === 'Escape') cancelInput();
            if(e.key === 'Enter') submitInput();
            return;
        }

        // Comandi gioco
        if(roomState.id_giocatore_corrente === myIndex) {
            if(e.ctrlKey && e.key.toLowerCase() === 'g') { e.preventDefault(); doSpin(); }
            if(e.ctrlKey && e.key.toLowerCase() === 'v') { e.preventDefault(); askInput('vowel'); }
            if(e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); askInput('solve'); }
        }
    });

</script>
</body>
</html>