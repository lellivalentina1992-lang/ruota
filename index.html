<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - Audio Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* STILI BASE */
        :root { --bg: #02203C; --box: #004a91; --gold: #FFD700; --focus: #FF00FF; }
        body { margin: 0; padding: 10px; font-family: Arial, sans-serif; background-color: var(--bg); color: white; text-align: center; }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

        /* UI SETUP */
        #setup-overlay { max-width: 600px; margin: 0 auto; }
        .panel { background: var(--box); padding: 20px; border-radius: 10px; border: 2px solid var(--gold); margin-bottom: 20px; text-align: left; }
        input, button { width: 100%; padding: 12px; margin: 5px 0; font-size: 1.1em; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--gold); border: none; cursor: pointer; color: black; font-weight: bold; }
        button:disabled { background: #555; color: #999; cursor: not-allowed; }

        /* ISPETTORE TESTUALE */
        #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #inspector-box {
            background: #fff; color: #000; padding: 30px; border-radius: 5px;
            width: 90%; max-width: 800px; text-align: left;
            max-height: 90vh; overflow-y: auto;
        }
        .insp-line { font-size: 1.4em; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; display: block; }

        /* GIOCO & TABELLONE */
        #game-board { display: flex; flex-wrap: wrap; justify-content: center; margin: 20px 0; outline: none; }
        .word { display: flex; margin-right: 25px; margin-bottom: 20px; }
        .letter-box { 
            width: 45px; height: 65px; border: 2px solid #fff; margin: 2px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2em; font-weight: bold; background: #003366; color: white;
        }
        .letter-box.revealed { background: white; color: black; }
        .letter-box.punct { background: white; color: black; border: none; }
        .letter-box:focus { outline: 6px solid var(--focus); z-index: 100; transform: scale(1.2); box-shadow: 0 0 15px var(--focus); }
        
        /* GIOCATORI */
        #player-scores { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .player-box { background: var(--box); border: 1px solid #888; padding: 10px; min-width: 120px; opacity: 0.7; }
        .player-box.active { border: 3px solid var(--gold); background: #005bb5; opacity: 1; transform: scale(1.05); }

        /* RUOTA */
        #wheel-container { width: 250px; height: 250px; border-radius: 50%; border: 4px solid white; margin: 0 auto; background: #333; position: relative; overflow: hidden; transition: transform 5.5s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .wheel-wedge { position: absolute; top: 0; right: 0; width: 50%; height: 50%; transform-origin: 0% 100%; border: 1px solid rgba(0,0,0,0.1); }
        
        #status-message { font-size: 1.4em; color: var(--gold); margin: 15px 0; font-weight: bold; min-height: 1.5em; }
        #connection-alert { background: red; color: white; padding: 5px; display: none; }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>

<div id="connection-alert">CONNESSIONE PERSA...</div>

<div id="inspector-overlay" class="hidden" role="dialog" aria-label="Mappa Frase">
    <div id="inspector-box">
        <h2 style="text-align:center; margin-top:0;">MAPPA FRASE</h2>
        <div id="inspector-content" tabindex="0" role="document"></div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="closeInspector()" style="width:auto;">CHIUDI (ESC)</button>
        </div>
    </div>
</div>

<div id="setup-overlay">
    <h1>LA RUOTA ONLINE</h1>
    <div class="panel">
        <label>1. IL TUO NOME:</label>
        <input id="player-name-input" type="text" placeholder="Es: Mario">
    </div>
    <div class="panel">
        <h2>LISTA STANZE</h2>
        <button onclick="fetchRooms()">Aggiorna Lista</button>
        <ul id="rooms-list" style="padding-left:20px; list-style:none;"><li>Caricamento...</li></ul>
    </div>
    <div class="panel">
        <h2>CREA STANZA</h2>
        <input id="create-room-name" type="text" placeholder="Nome Stanza">
        <div style="margin:10px 0;"><input id="is-private-check" type="checkbox" style="width:auto;"> <label>Privata</label></div>
        <button onclick="createRoom()">CREA NUOVA</button>
    </div>
    <div class="panel">
        <h2>ENTRA CON CODICE</h2>
        <input id="private-room-code" type="text" placeholder="Codice Stanza">
        <button onclick="joinPrivate()">ENTRA</button>
    </div>
</div>

<div id="game-container" class="hidden">
    <div style="display:flex; justify-content:space-between; padding:10px; background:#000;">
        <span>Stanza: <span id="room-code-display" style="color:yellow">---</span></span>
        <button id="btn-close-room" class="hidden" onclick="closeRoom()" style="width:auto; background:red; padding:5px;">TERMINA</button>
    </div>
    
    <div id="category-display" style="font-size:2em; color:var(--gold); font-weight:bold; margin-top:10px;">---</div>
    <div id="word-count-display" style="font-size:1.3em; color:white; margin-bottom:15px; font-weight:bold;">---</div>
    
    <div id="game-board" tabindex="-1"></div>
    <div id="used-letters-display" style="color:#ccc; margin-bottom:10px;"></div>
    <div id="player-scores"></div>

    <div style="position:relative; width:250px; margin:10px auto;">
        <div style="position:absolute; top:-15px; left:50%; transform:translate(-50%); border-left:15px solid transparent; border-right:15px solid transparent; border-top:25px solid white; z-index:50;"></div>
        <div id="wheel-container"></div>
    </div>

    <div id="status-message" aria-hidden="true">In attesa...</div>

    <div id="controls-panel" style="width:100%; max-width:500px; margin:0 auto;">
        <div id="main-actions">
            <button id="btn-spin" onclick="spin()">Gira (CTRL+G)</button>
            <button id="btn-buy-vowel" onclick="setControls('vowel')">Vocale €500 (CTRL+V)</button>
            <button id="btn-solve" onclick="setControls('solve')">Soluzione (CTRL+S)</button>
            <button onclick="readRevealedLetters()">Lettere Presenti (CTRL+L)</button>
            <button onclick="checkTurn()">Di chi è il turno? (CTRL+U)</button>
            <button onclick="openInspector()">Mappa Frase (CTRL+I)</button>
        </div>
        <div id="letter-input-area" class="hidden">
            <input id="letter-input" type="text" maxlength="1" placeholder="Lettera">
            <button id="btn-confirm-letter" onclick="confirmLetter()">CONFERMA</button>
        </div>
        <div id="solve-input-area" class="hidden">
            <input id="solve-input" type="text" placeholder="Scrivi la frase...">
            <button id="btn-confirm-solve" onclick="solve()">CONFERMA</button>
            <button onclick="setControls('main')">ANNULLA</button>
        </div>
        <div id="extra-decision-area" class="hidden">
            <button onclick="useJolly()">USA JOLLY</button>
            <button onclick="pass()">NON USARE</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://azcwkpdjbysnivknnino.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const wheelValues = [100, 200, 300, 400, 500, 1000, 1500, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO', 500];
    const nato = {'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','À':'A accentata','È':'E accentata','Ì':'I accentata','Ò':'O accentata','Ù':'U accentata'};
    
    let myId, myRoomId, myIndex, myName, roomState = {}, curSol = "", curSolDisp = "";
    let knownPlayers = []; let allPlayersList = [];

    // --- FUNZIONI BASE (Messe qui per evitare errori di caricamento) ---
    function normalize(s) {
        if(!s) return "";
        return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
    }

    async function ensurePhrases() {
        const {count} = await supabase.from('frasi').select('*', {count:'exact', head:true});
        if(count === 0) await supabase.from('frasi').insert([{categoria:'TEST',soluzione:'PROVA'}]);
    }

    function speak(text) {
        const el = document.getElementById('sr-announcer'); 
        el.textContent = ''; 
        setTimeout(() => { el.textContent = text; }, 50);
        document.getElementById('status-message').textContent = text;
    }
    
    function playSound(id, times=1) {
        stopSound('snd-spin');
        const audio = document.getElementById(id); 
        if(!audio) { console.warn("Audio non trovato:", id); return; }
        
        let c=0; 
        function loop(){ 
            if(c<times){ 
                audio.currentTime=0; 
                audio.play().catch(e => console.log("Err Audio", e)); 
                c++; 
                setTimeout(loop, 500); 
            } 
        } 
        loop();
    }
    
    function stopSound(id) {
        const audio = document.getElementById(id); 
        if(audio) { audio.pause(); audio.currentTime = 0; }
    }

    // --- ISPETTORE (CTRL+I) ---
    window.openInspector = () => {
        const words = curSolDisp.split(' ');
        let absIndex = 0;
        let html = "";
        words.forEach((w, i) => {
            let wordStr = "";
            for(let char of w) {
                if(char.match(/[A-ZÀ-Ù]/)) {
                    if((roomState.lettere_rivelate||[]).includes(absIndex)) wordStr += char + " ";
                    else wordStr += "- ";
                    absIndex++;
                } else { wordStr += char + " "; }
            }
            html += `<div class="insp-line"><strong>${i+1}, ${w.length} lettere:</strong> ${wordStr}</div>`;
        });
        document.getElementById('inspector-content').innerHTML = html;
        document.getElementById('inspector-overlay').classList.remove('hidden');
        setTimeout(() => document.getElementById('inspector-content').focus(), 100);
        speak("Mappa frase aperta.");
    };
    window.closeInspector = () => {
        document.getElementById('inspector-overlay').classList.add('hidden');
        document.getElementById('btn-spin').focus();
        speak("Chiuso.");
    };

    // --- UTILS LETTURA ---
    window.readRevealedLetters = () => {
        const rev = roomState.lettere_rivelate || [];
        if (!rev.length) return speak("Nessuna lettera presente.");
        let s = new Set(); rev.forEach(i => { let char = curSolDisp.replace(/ /g,'')[i]; s.add(char); });
        let sorted = Array.from(s).sort();
        let msg = "Lettere presenti: ";
        sorted.forEach(c => { let spelling = nato[c] ? `di ${nato[c]}` : c; msg += `${c}, ${spelling}. ... `; });
        speak(msg);
    };

    window.checkTurn = () => {
        if (!roomState || allPlayersList.length === 0) return speak("Dati turno non disponibili.");
        const currentPlayer = allPlayersList.find(p => p.indice === roomState.id_giocatore_corrente);
        if (currentPlayer) {
            const name = currentPlayer.id === myId ? "TE" : currentPlayer.nome.toUpperCase();
            speak(`TOCCA A ${name}.`);
        } else { speak("Errore turno."); }
    };

    function isMyTurn() { return roomState && roomState.id_giocatore_corrente === myIndex; }

    // --- LOBBY ---
    async function getOrCreatePlayer(roomId, name, isHost=false) {
        const { data: existing } = await supabase.from('giocatori').select('*').eq('stanza_id', roomId).ilike('nome', name).single();
        if(existing) { speak("Bentornato " + existing.nome); return existing; }
        const { count } = await supabase.from('giocatori').select('*', { count: 'exact', head: true }).eq('stanza_id', roomId);
        if(count >= 3) return null;
        const { data: newPlayer } = await supabase.from('giocatori').insert([{ stanza_id: roomId, nome: name, indice: count, is_host: isHost }]).select().single();
        return newPlayer;
    }

    async function fetchRooms() {
        const list = document.getElementById('rooms-list'); list.innerHTML = '<li>Caricamento...</li>';
        const { data: rooms } = await supabase.from('stanze').select('*, giocatori(count)').eq('stato', 'attesa').eq('is_private', false);
        list.innerHTML = '';
        if(rooms && rooms.length > 0) {
            rooms.forEach(r => {
                list.innerHTML += `<li style="margin-bottom:5px;"><b>${r.codice}</b> (${r.giocatori[0].count}/3) <button style="width:auto; padding:5px;" onclick="joinSpecificRoom('${r.codice}')">ENTRA</button></li>`;
            });
            speak("Lista aggiornata.");
        } else { list.innerHTML = '<li>Nessuna stanza pubblica.</li>'; }
    }
    fetchRooms();

    async function createRoom() {
        const name = document.getElementById('player-name-input').value.trim();
        const code = document.getElementById('create-room-name').value.trim().toUpperCase();
        const isPriv = document.getElementById('is-private-check').checked;
        if(!name || !code) return speak("Dati mancanti.");
        
        const { data: ex } = await supabase.from('stanze').select('id').eq('codice', code).single();
        if(ex) {
            const p = await getOrCreatePlayer(ex.id, name, true);
            if(p) return enterGameWithRecovery(ex.id, p);
            return speak("Nome occupato.");
        }

        await ensurePhrases();
        const { data: f } = await supabase.from('frasi').select('*');
        const rF = f[Math.floor(Math.random()*f.length)];
        const { data: room } = await supabase.from('stanze').insert([{ codice: code, stato: 'attesa', is_private: isPriv, frase_corrente_id: rF.id }]).select().single();
        const p = await getOrCreatePlayer(room.id, name, true);
        enterGame(room.id, p, 0);
    }

    async function joinSpecificRoom(code) {
        const name = document.getElementById('player-name-input').value.trim();
        if(!name) return speak("Inserisci nome.");
        const { data: room } = await supabase.from('stanze').select('id').eq('codice', code).single();
        if(!room) return speak("Stanza non trovata.");
        const p = await getOrCreatePlayer(room.id, name, false);
        if(!p) return speak("Stanza piena.");
        enterGameWithRecovery(room.id, p);
    }
    async function joinPrivate() { joinSpecificRoom(document.getElementById('private-room-code').value.toUpperCase()); }

    async function enterGameWithRecovery(roomId, player) {
        let { data: room } = await supabase.from('stanze').select('*, frasi(*)').eq('id', roomId).single();
        
        if(!room.frasi) {
            await ensurePhrases();
            const { data: f } = await supabase.from('frasi').select('*');
            const newF = f[Math.floor(Math.random()*f.length)];
            await supabase.from('stanze').update({ frase_corrente_id: newF.id }).eq('id', roomId);
            const res = await supabase.from('stanze').select('*, frasi(*)').eq('id', roomId).single();
            room = res.data;
        }
        enterGame(room.id, player, player.indice, room.frasi);
    }

    function enterGame(roomId, player, idx, frase) {
        // Recupera la frase se non passata (es. primo caricamento)
        if(!frase) {
             // logica gestita da handleUpdate
        } else {
            curSolDisp = frase.soluzione.toUpperCase(); curSol = normalize(frase.soluzione);
            document.getElementById('category-display').textContent = frase.categoria;
        }

        myRoomId = roomId; myId = player.id; myIndex = idx; myName = player.nome;
        document.getElementById('setup-overlay').classList.add('hidden');
        document.getElementById('game-container').classList.remove('hidden');
        
        // Show host button
        if(player.is_host) document.getElementById('btn-close-room').classList.remove('hidden');
        
        knownPlayers = [player.nome];
        buildWheel(); setupRealtime(); handleUpdate({frase_corrente_id: frase ? frase.id : null}); refreshPlayers();
    }

    // --- ENGINE ---
    async function broadcast(action, msg, updates = {}) {
        await supabase.from('stanze').update({ ...updates, ultima_azione: action, ultimo_messaggio: msg, azione_timestamp: Date.now().toString() }).eq('id', myRoomId);
    }

    function spin() {
        if(!isMyTurn()) return speak("Non tocca a te.");
        setControls('none');
        const v = wheelValues[Math.floor(Math.random()*wheelValues.length)];
        doVisualSpin(v);
        broadcast('spin_start', '', {}); 

        setTimeout(async () => {
            if(typeof v === 'number') {
                sessionStorage.setItem('sv', v);
                await broadcast('spin_result', `${myName} ottiene ${v}.`, {});
                if(isMyTurn()) setControls('consonant');
            } else if (v === 'BANCAROTTA') {
                bankrupt();
            } else if (v === 'PASSA') {
                await broadcast('miss', `${myName} passa.`, {}); pass();
            } else if (v === 'MISTERO') {
                mystery();
            }
        }, 5500);
    }

    async function mystery() {
        if(!isMyTurn()) return;
        speak("Mistero...");
        setTimeout(async()=>{
            if(Math.random() < 0.5) { await broadcast('miss', "Mistero: BANCAROTTA!", {montepremi_round:0}); setTimeout(pass, 1500); }
            else { 
                const {data:me}=await supabase.from('giocatori').select('jolly').eq('id',myId).single();
                await supabase.from('giocatori').update({jolly:(me.jolly||0)+1}).eq('id',myId);
                await broadcast('hit-1', "Mistero: Jolly!", {}); setControls('main'); 
            }
        }, 1500);
    }

    async function confirmLetter() {
        if(!isMyTurn()) return speak("Non tocca a te.");
        const l = document.getElementById('letter-input').value.toUpperCase().trim();
        document.getElementById('letter-input').value='';
        if(!l.match(/[A-Z]/)) return speak("Non valido.");
        if((roomState.lettere_chiamate||[]).includes(l)) {
            await broadcast('miss', `${myName} chiama ${l}: già uscita!`, {});
            setTimeout(pass, 1500);
            return;
        }

        let count=0, rev=[...(roomState.lettere_rivelate||[])];
        let clean = curSol.replace(/ /g, ''); 
        let rawIndex = 0;
        for(let i=0; i<curSolDisp.length; i++) {
            if(curSolDisp[i] === ' ') continue; 
            if(clean[rawIndex] === l) { count++; if(!rev.includes(rawIndex)) rev.push(rawIndex); }
            rawIndex++;
        }

        let sv = parseInt(sessionStorage.getItem('sv')||0);
        let isV = ['A','E','I','O','U'].includes(l);
        if(isV && (roomState.montepremi_round||0) < 500) return speak("Soldi insufficienti.");

        let money = (roomState.montepremi_round||0) + (isV ? -500 : (sv*count));

        if(count > 0) {
            // USA snd-hit (lettera presente.wav)
            await broadcast(`hit-${count}`, `${myName}: ${count} ${l}.`, { lettere_chiamate:[...(roomState.lettere_chiamate||[]),l], lettere_rivelate:rev, montepremi_round:money });
            setControls('main');
        } else {
            // USA snd-miss (lettera assente.wav)
            await broadcast('miss', `${myName}: ${l} non c'è.`, { lettere_chiamate:[...(roomState.lettere_chiamate||[]),l] });
            setTimeout(pass, 1500);
        }
    }

    async function solve() {
        if(!isMyTurn()) return speak("Non tocca a te.");
        const txt = document.getElementById('solve-input').value.toUpperCase().trim();
        setControls('main'); 

        if(normalize(txt) === curSol) {
            const w = (roomState.montepremi_round||0)+1000;
            const {data:me}=await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
            await supabase.from('giocatori').update({punteggio_totale:(me.punteggio_totale||0)+w}).eq('id',myId);
            let allIndices = []; let c = 0; for(let char of curSolDisp) if(char !== ' ') { allIndices.push(c); c++; }
            
            // USA snd-hit (o ding se preferisci vittoria diversa, ma hit va bene)
            await broadcast('ding', `VITTORIA! ${myName} indovina: ${curSolDisp}`, {lettere_rivelate: allIndices});
            
            setTimeout(() => { startNewRound(); }, 8000); 
        } else {
            await broadcast('miss', `${myName} sbaglia soluzione.`); setTimeout(pass, 1500);
        }
    }

    async function startNewRound() {
        if(myIndex !== roomState.id_giocatore_corrente) return; 
        
        const prevWinnerIdx = roomState.vincitore_precedente_idx;
        const consec = roomState.vittorie_consecutive || 0;
        let newConsec = 1;
        let nextStarter = myIndex;

        if(prevWinnerIdx === myIndex) {
            newConsec = consec + 1;
            if(newConsec >= 2) {
                const { count } = await supabase.from('giocatori').select('*', { count: 'exact', head: true }).eq('stanza_id', myRoomId);
                nextStarter = (myIndex + 1) % count;
                newConsec = 0;
            }
        }

        await broadcast('spin_start', "Caricamento nuovo round...", {}); 
        const { data: f } = await supabase.from('frasi').select('*');
        const newFrase = f[Math.floor(Math.random()*f.length)];
        await supabase.from('stanze').update({
            frase_corrente_id: newFrase.id,
            id_giocatore_corrente: nextStarter, 
            vincitore_precedente_idx: myIndex,  
            vittorie_consecutive: newConsec,    
            lettere_chiamate: [], lettere_rivelate: [], montepremi_round: 0,
            ultimo_messaggio: `Nuovo Round! Categoria: ${newFrase.categoria}`,
            ultima_azione: 'ding', azione_timestamp: Date.now().toString()
        }).eq('id', myRoomId);
    }

    async function pass() {
        const { data: players } = await supabase.from('giocatori').select('indice').eq('stanza_id', myRoomId).order('indice');
        let currArrIdx = players.findIndex(p => p.indice === myIndex);
        let nextArrIdx = (currArrIdx + 1) % players.length;
        await supabase.from('stanze').update({id_giocatore_corrente: players[nextArrIdx].indice}).eq('id', myRoomId);
    }

    async function bankrupt() {
        if(!isMyTurn()) return;
        const {data:me}=await supabase.from('giocatori').select('jolly').eq('id',myId).single();
        if(me.jolly>0) {
             speak("Hai Jolly. Usalo?");
             document.getElementById('extra-decision-area').classList.remove('hidden');
             document.getElementById('btn-use-jolly').focus();
        } else {
             await broadcast('miss', "Bancarotta!", {montepremi_round:0}); setTimeout(pass, 1500);
        }
    }
    async function useJolly() {
        if(!isMyTurn()) return;
        const{data:me}=await supabase.from('giocatori').select('jolly').eq('id',myId).single();
        if(me.jolly>0){await supabase.from('giocatori').update({jolly:me.jolly-1}).eq('id',myId); setControls('main');}
    }

    // --- REALTIME ---
    let lastTs = "";
    function setupRealtime() {
        supabase.channel(`room:${myRoomId}`)
        .on('postgres_changes', {event:'UPDATE', schema:'public', table:'stanze', filter:`id=eq.${myRoomId}`}, p=>handleUpdate(p.new))
        .on('postgres_changes', {event:'*', schema:'public', table:'giocatori', filter:`stanza_id=eq.${myRoomId}`}, ()=>refreshPlayers())
        .subscribe((status) => {
            if(status === 'SUBSCRIBED') document.getElementById('connection-alert').style.display = 'none';
            if(status === 'CLOSED' || status === 'CHANNEL_ERROR') document.getElementById('connection-alert').style.display = 'block';
        });
    }
    
    async function handleUpdate(s) {
        // SE LA FRASE È CAMBIATA, RICARICALA
        if(s.frase_corrente_id && (!roomState.frase_corrente_id || s.frase_corrente_id !== roomState.frase_corrente_id)) {
            const {data:f} = await supabase.from('frasi').select('*').eq('id', s.frase_corrente_id).single();
            if(f) {
                curSolDisp = f.soluzione.toUpperCase(); curSol = normalize(f.soluzione);
                document.getElementById('category-display').textContent = f.categoria;
                document.getElementById('room-code-display').textContent = s.codice;
            }
        }
        
        roomState = s; renderBoard();
        
        if(s.stato === 'chiusa') { alert("Partita chiusa."); location.reload(); return; }
        
        if(s.azione_timestamp !== lastTs) {
            lastTs = s.azione_timestamp;
            if(s.ultima_azione === 'spin_start') {
                const a = document.getElementById('snd-spin'); a.currentTime=0; a.play().catch(()=>{});
            }
            else if(s.ultima_azione === 'spin_result') {
                stopSound('snd-spin'); speak(s.ultimo_messaggio);
            }
            else if(s.ultima_azione === 'miss') {
                stopSound('snd-spin'); playSound('snd-miss'); speak(s.ultimo_messaggio);
            }
            else if(s.ultima_azione && s.ultima_azione.startsWith('hit-')) {
                stopSound('snd-spin'); playSound('snd-hit', parseInt(s.ultima_azione.split('-')[1])); speak(s.ultimo_messaggio);
            }
            else if(s.ultima_azione === 'ding') {
                stopSound('snd-spin'); playSound('snd-ding'); speak(s.ultimo_messaggio);
            }
        }
        
        const myTurn = s.id_giocatore_corrente === myIndex;
        document.querySelectorAll('.player-box').forEach(el => el.classList.remove('active'));
        const activeBox = document.querySelector(`.player-box[data-idx="${s.id_giocatore_corrente}"]`);
        if(activeBox) activeBox.classList.add('active');
        
        if(myTurn) {
            const menus = ['letter-input-area','solve-input-area','extra-decision-area'];
            const open = menus.some(id => !document.getElementById(id).classList.contains('hidden'));
            document.querySelectorAll('#main-actions button').forEach(b => b.disabled = false);
            if(!open) setControls('main');
        } else { 
            document.querySelectorAll('#main-actions button').forEach(b => b.disabled = true);
            setControls('none'); 
        }
        
        let used = (s.lettere_chiamate||[]); used.sort();
        document.getElementById('used-letters-display').textContent = "Uscite: " + used.join("-");
        
        refreshPlayers();
    }

    async function refreshPlayers() {
        const { data: ps } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
        allPlayersList = ps; 

        if(knownPlayers.length > 0 && ps.length > knownPlayers.length) {
            const newP = ps.find(p => !knownPlayers.includes(p.nome));
            if(newP) {
                speak(`ATTENZIONE: È ENTRATO ${newP.nome.toUpperCase()}!`);
                playSound('snd-ding');
            }
        }
        knownPlayers = ps.map(p => p.nome);
        const div = document.getElementById('player-scores'); div.innerHTML = '';
        ps.forEach(p => {
            const isMe = p.id === myId;
            const el = document.createElement('div');
            el.className = `player-box ${isMe?'me':''}`; el.dataset.idx = p.indice;
            
            let currentMoney = p.punteggio_totale;
            let roundMoney = 0;
            if(p.indice === roomState.id_giocatore_corrente) {
                roundMoney = (roomState.montepremi_round || 0);
            }

            el.innerHTML = `
                <div class="p-name" style="font-weight:bold; border-bottom:1px solid #aaa;">${p.nome}</div>
                <div>Tot: €${p.punteggio_totale}</div>
                ${roundMoney > 0 ? `<div style="color:#0f0; font-size:0.9em;">+€${roundMoney} nel round</div>` : ''}
                <div style="color:gold;">JOLLY: ${p.jolly}</div>
            `;
            
            let txt = `${p.nome}: ${p.punteggio_totale} euro totali.`;
            if(roundMoney > 0) txt += ` Più ${roundMoney} euro in questo round.`;
            txt += ` ${p.jolly} jolly.`;
            if(roomState.id_giocatore_corrente === p.indice) txt += " È il suo turno.";
            
            el.setAttribute('aria-label', txt); el.setAttribute('role', 'region'); el.tabIndex = 0;
            div.appendChild(el);
        });
    }

    function renderBoard() {
        const b = document.getElementById('game-board'); b.innerHTML='';
        let abs=0;
        let words = curSolDisp.split(' ');
        document.getElementById('word-count-display').textContent = `${words.length} PAROLE`;

        words.forEach((w, wIdx) => {
            const wd=document.createElement('div'); wd.className='word';
            wd.dataset.wordIdx = wIdx + 1;
            for(let i=0; i<w.length; i++) {
                let c = w[i];
                const bx=document.createElement('div');
                bx.className='letter-box'; bx.tabIndex = -1; 
                bx.dataset.wordIdx = wIdx + 1;
                
                let ariaText = "";
                if(c.match(/[A-ZÀ-Ù]/)) {
                    if((roomState.lettere_rivelate||[]).includes(abs)) {
                        bx.classList.add('revealed'); 
                        bx.innerHTML = `<span aria-hidden="true">${c}</span>`; 
                        ariaText = `${c}, ${i+1} su ${w.length}`; 
                    } else {
                        bx.textContent=''; 
                        ariaText = `Vuota, ${i+1} su ${w.length}`;
                    }
                    abs++;
                } else {
                    bx.className='letter-box punct'; 
                    bx.innerHTML = `<span aria-hidden="true">${c}</span>`;
                    ariaText = `${c}`;
                }
                bx.setAttribute('aria-label', ariaText);
                wd.appendChild(bx);
            }
            b.appendChild(wd);
        });
    }

    document.getElementById('game-board').addEventListener('keydown', (e) => {
        const boxes = Array.from(document.querySelectorAll('#game-board .letter-box'));
        const current = document.activeElement;
        let idx = boxes.indexOf(current);
        if(idx === -1) idx = 0;

        if(e.key === 'ArrowRight') {
            e.preventDefault();
            if(e.ctrlKey) {
                let currWordIdx = parseInt(current.dataset.wordIdx || 0);
                let nextWordBox = boxes.find(b => parseInt(b.dataset.wordIdx) > currWordIdx);
                if(nextWordBox) nextWordBox.focus();
            } else {
                if(idx < boxes.length - 1) boxes[idx+1].focus();
                else speak("Fine tabellone");
            }
        }
        else if(e.key === 'ArrowLeft') {
            e.preventDefault();
            if(e.ctrlKey) {
                let currWordIdx = parseInt(current.dataset.wordIdx || 99);
                let prevWordBoxes = boxes.filter(b => parseInt(b.dataset.wordIdx) < currWordIdx);
                if(prevWordBoxes.length > 0) {
                    let targetBox = boxes.find(b => b.dataset.wordIdx === prevWordBoxes[prevWordBoxes.length-1].dataset.wordIdx);
                    if(targetBox) targetBox.focus();
                }
            } else {
                if(idx > 0) boxes[idx-1].focus();
                else speak("Inizio tabellone");
            }
        }
    });

    window.addEventListener('keydown', e => {
        if(e.key === 'Enter') {
             if(document.activeElement.id==='letter-input') confirmLetter();
             if(document.activeElement.id==='solve-input') solve();
        }
        if(e.key === 'Escape') { 
            e.preventDefault();
            if(!document.getElementById('inspector-overlay').classList.contains('hidden')) {
                window.closeInspector();
                return;
            }
            setControls('main');
            document.getElementById('letter-input').value = '';
            document.getElementById('solve-input').value = '';
        }
        if(document.activeElement.tagName==='INPUT') return;
        if(e.ctrlKey) {
            if(e.key.toLowerCase()==='g') { e.preventDefault(); document.getElementById('btn-spin').click(); }
            if(e.key.toLowerCase()==='v') { e.preventDefault(); document.getElementById('btn-buy-vowel').click(); }
            if(e.key.toLowerCase()==='s') { e.preventDefault(); document.getElementById('btn-solve').click(); }
            if(e.key.toLowerCase()==='l') { e.preventDefault(); window.readRevealedLetters(); }
            if(e.key.toLowerCase()==='i') { e.preventDefault(); window.openInspector(); }
            if(e.key.toLowerCase()==='u') { e.preventDefault(); window.checkTurn(); }
        }
    });
</script>
</body>
</html>