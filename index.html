<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Ruota - TV Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- VARIABILI GRAFICHE (TEMA TV DEFAULT) --- */
        :root {
            --bg-body: linear-gradient(135deg, #0f2027, #203a43, #2c5364); /* Blu studio TV */
            --font-main: 'Verdana', sans-serif;
            --col-text: #ffffff;
            --col-border: #ffffff; 
            --col-focus: #ffd700;
            --bg-panel: rgba(0, 0, 0, 0.6); /* Pannelli semi-trasparenti */
            --bg-tile-empty: #004d00;
            --bg-tile-revealed: #ffffff;
            --col-tile-text: #000000;
            --shadow-card: 0 8px 16px rgba(0,0,0,0.5); /* Ombre 3D */
            --border-radius: 15px;
            --border-width: 2px;
            --wheel-border: #ddd;
            --transition-speed: 0.3s;
        }

        /* --- TEMA ALTO CONTRASTO (PER IPOVEDENTI) --- */
        body.high-contrast {
            --bg-body: #000000; /* Nero puro */
            --col-text: #ffffff;
            --col-border: #ffd700; /* Giallo acceso */
            --col-focus: #00ffff;
            --bg-panel: #1e1e1e;
            --bg-tile-empty: #006600;
            --bg-tile-revealed: #ffffff;
            --col-tile-text: #000000;
            --shadow-card: none; /* Niente ombre */
            --border-radius: 0px; /* Spigoli vivi */
            --border-width: 3px;
            --wheel-border: #ffffff;
            --transition-speed: 0s;
        }

        /* --- STILI BASE --- */
        body {
            background: var(--bg-body);
            color: var(--col-text);
            font-family: var(--font-main);
            margin: 0; padding: 10px;
            text-align: center;
            overflow-x: hidden;
            min-height: 100vh;
            transition: background 0.5s;
        }

        /* Accessibilità */
        *:focus { outline: 4px solid var(--col-focus) !important; box-shadow: 0 0 15px var(--col-focus); }
        .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); }
        .hidden { display: none !important; }

        /* Pulsante Switch Tema (Visibile in alto) */
        #contrast-toggle-btn {
            display: block; width: 100%; max-width: 300px; margin: 0 auto 10px auto;
            padding: 10px; background: #000; color: #ffd700; border: 2px solid #fff;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
        }
        body.high-contrast #contrast-toggle-btn { background: #ffd700; color: #000; border: 4px solid #fff; }

        /* Layout */
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Pannelli */
        #setup-panel, #game-panel, #end-panel, #round-over-panel { 
            border: var(--border-width) solid var(--col-border); 
            padding: 20px; margin-top: 20px; 
            background: var(--bg-panel); 
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            backdrop-filter: blur(5px); /* Effetto vetro nel tema TV */
        }
        body.high-contrast #setup-panel { backdrop-filter: none; }
        
        /* Tabellone */
        #board-container {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            background: #053305; border: 5px solid #fff; padding: 25px; margin: 20px 0;
            border-radius: 10px; min-height: 150px;
            box-shadow: inset 0 0 30px #000;
        }
        .board-row { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
        
        /* Caselle con Effetto Flip 3D */
        .tile {
            width: 45px; height: 65px; 
            background: var(--bg-tile-revealed); color: var(--col-tile-text);
            font-weight: 900; font-size: 2.2em; display: flex; align-items: center; justify-content: center;
            border: 2px solid #333;
            transition: transform 0.6s, background-color 0.3s;
            transform-style: preserve-3d;
        }
        
        /* Stato vuoto */
        .tile.empty { 
            background: var(--bg-tile-empty); 
            color: transparent; 
            border: 1px solid rgba(255,255,255,0.3); 
            transform: rotateY(0deg); /* Lato dorso */
        }
        /* Stato rivelato */
        .tile:not(.empty) {
            transform: rotateY(360deg); /* Animazione capriola */
        }
        /* Disabilita animazione in alto contrasto */
        body.high-contrast .tile { transition: none !important; transform: none !important; }

        /* Cursori Navigazione */
        .tile.cursor-char { border: 4px solid #00ffff; z-index: 10; transform: scale(1.1) rotateY(360deg); }
        body.high-contrast .tile.cursor-char { transform: scale(1.2); } /* No rotazione in HC */
        .board-row.cursor-word { border: 3px solid #ffd700; padding: 4px; border-radius: 5px; }

        /* Ruota Visiva */
        #wheel-visual {
            width: 220px; height: 220px; margin: 20px auto;
            border-radius: 50%; border: 8px solid var(--wheel-border);
            background: conic-gradient(#ff0000, #ffa500, #ffff00, #008000, #0000ff, #4b0082, #ee82ee);
            transition: transform 3.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: var(--shadow-card);
        }
        #wheel-pointer { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #fff; margin: 0 auto -20px auto; position: relative; z-index: 10; filter: drop-shadow(0 2px 2px #000); }

        /* Pulsanti */
        button { padding: 12px 20px; font-size: 1.1em; cursor: pointer; font-weight: bold; margin: 5px; border-radius: 8px; border: 2px solid #fff; text-transform: uppercase; box-shadow: 0 4px 0 #000; transition: transform 0.1s; }
        button:active { transform: translateY(4px); box-shadow: none; }
        .btn-primary { background: #ffcc00; color: #000; }
        .btn-secondary { background: #00ccff; color: #000; }
        .btn-danger { background: #ff0000; color: #fff; }
        
        .disabled-btn { background: #444 !important; color: #888 !important; border-color: #666 !important; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .btn-blink { animation: blinker 1.5s linear infinite; background: #00ff00; color: #000; border-color: #fff; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        
        /* Overlay Input */
        #input-area, #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #inspector-content { background: #222; border: 2px solid #ffd700; padding: 20px; width: 85%; max-height: 80%; overflow-y: auto; text-align: left; color: #fff; font-size: 1.4em; line-height: 1.6; }
        input { font-size: 1.8em; padding: 10px; text-align: center; width: 80%; max-width: 400px; background: #333; color: white; border: 2px solid #ffd700; }
        
        .score-display { display: inline-block; padding: 5px 15px; border: 1px solid #555; border-radius: 5px; margin: 0 5px; background: #000; }
        
        /* Timer */
        #timer-box { 
            display: inline-block; position: relative;
            margin: 0 auto 15px auto; font-size: 2.5em; 
            color: #ff0000; font-weight: bold; 
            border: 3px solid #ff0000; padding: 10px 20px; 
            border-radius: 50px; background: #000; 
            box-shadow: 0 0 15px #ff0000;
        }
    </style>
</head>
<body>

    <div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

    <button id="contrast-toggle-btn" onclick="toggleContrast()">
        Attiva Modalità Alto Contrasto (C)
    </button>

    <audio id="snd-spin" src="ruota.wav"></audio>
    <audio id="snd-hit" src="lettera presente.wav"></audio>
    <audio id="snd-miss" src="lettera assente.wav"></audio>
    <audio id="snd-win" src="lettera presente.wav"></audio>

    <h1 style="color:#ffd700; text-shadow: 2px 2px 0 #000;">LA RUOTA</h1>

    <div id="setup-panel" class="container">
        <h2>BENVENUTO</h2>
        <input id="inp-name" type="text" placeholder="IL TUO NOME"><br><br>
        <input id="inp-code" type="text" value="STANZA1"><br><br>
        <button onclick="joinGame(true)" class="btn-primary">CREA STANZA (RESET)</button>
        <button onclick="joinGame(false)" class="btn-secondary">ENTRA</button>
    </div>

    <div id="game-panel" class="container hidden">
        
        <div id="timer-box">120</div>

        <div style="background:rgba(0,0,0,0.8); padding:15px; border-radius:5px; border-bottom: 1px solid #333;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                <div style="text-align: left;">
                    <span id="round-indicator" style="color:#aaa; font-size: 0.9em;">ROUND 1/10</span><br>
                    <span id="turn-indicator" style="font-size:1.3em; font-weight:bold;">...</span>
                </div>
                <div style="text-align: right;">
                    <div class="score-display">
                        <small style="color:#aaa;">PARZIALE</small><br>
                        <span id="score-round" style="color:#00ff00; font-weight:bold; font-size:1.4em;">€0</span>
                    </div>
                    <div class="score-display" style="border-color:#ffd700;">
                        <small style="color:#aaa;">TOTALE</small><br>
                        <span id="score-total" style="color:#ffd700; font-weight:bold; font-size:1.4em;">€0</span>
                    </div>
                </div>
            </div>
        </div>

        <h2 id="live-category" style="color:#00ffff; font-size: 1.8em; margin: 15px 0 5px 0; text-shadow: 1px 1px 2px black;">...</h2>
        <h3 id="round-hint" style="color:#ffd700; font-size: 1.4em; margin: 0 0 15px 0; min-height: 1.5em; text-shadow: 1px 1px 2px black;"></h3>

        <div id="board-container" aria-hidden="true" tabindex="-1"></div>
        
        <div id="wheel-pointer"></div>
        <div id="wheel-visual"></div>
        <div id="wheel-status-text" style="font-size: 1.5em; font-weight: bold; color: lime; margin: 10px; text-shadow: 1px 1px #000;">PREMI G</div>

        <div id="controls">
            <button id="btn-spin" class="btn-primary" onclick="doSpin()">1. GIRA (G)</button>
            <button id="btn-vowel" class="btn-secondary" onclick="openInput('vowel')">2. VOCALE (V)</button>
            <button id="btn-solve" class="btn-danger" onclick="openInput('solve')">3. RISOLVI (S)</button>
            
            <br>
            <button id="btn-manual-cons" class="btn-blink hidden" onclick="openInput('letter')" style="margin-top:15px; width: 80%;">
                INSERISCI CONSONANTE (INVIO)
            </button>
            <br>

            <div style="color:#fff; margin-top:10px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;">
                <strong>Frecce:</strong> Naviga | <strong>Ctrl+Frecce:</strong> Parola<br>
                <strong>Ctrl+I:</strong> Ispettore | <strong>Ctrl+L:</strong> Lettere presenti
            </div>
        </div>
    </div>

    <div id="round-over-panel" class="container hidden">
        <h2 style="color: #00ff00; font-size: 2em;">ROUND COMPLETATO!</h2>
        <p id="round-winner-msg" style="font-size: 1.5em;">...</p>
        <p id="solution-msg" style="color: #ffd700; font-size: 1.3em;">...</p>
        <br>
        <button id="btn-next-round" onclick="startNewRound()" class="btn-primary" style="font-size: 1.5em; padding: 20px;">
            VAI AL PROSSIMO ROUND (INVIO)
        </button>
        <p style="color:#aaa; margin-top:20px;">Attendete che tutti siano pronti.</p>
    </div>

    <div id="end-panel" class="container hidden">
        <h2 style="color: #ffd700; font-size: 3em;">PARTITA TERMINATA</h2>
        <h3>CLASSIFICA FINALE</h3>
        <ul id="ranking-list" style="list-style: none; padding: 0; font-size: 1.5em;"></ul>
        <button onclick="location.reload()" class="btn-secondary">TORNA AL MENU</button>
    </div>

    <div id="input-area" class="hidden">
        <h2 id="input-title" style="color:#ffd700">...</h2>
        <input id="game-input" type="text" autocomplete="off" placeholder="Scrivi qui...">
        <div style="margin-top: 20px;">
            <button onclick="submitInput()" class="btn-primary">CONFERMA</button>
            <button onclick="closeInput()" class="btn-secondary">ANNULLA</button>
        </div>
    </div>

    <div id="inspector-overlay" class="hidden" role="dialog" aria-label="Ispettore">
        <div id="inspector-content" tabindex="-1"></div>
        <button onclick="closeInspector()" class="btn-secondary" style="margin-top:20px;">CHIUDI (ESC)</button>
    </div>

    <script>
        // --- UTILITA' ---
        function playAudio(id) {
            const aud = document.getElementById(id);
            if(aud) { 
                aud.pause();
                aud.currentTime = 0; 
                aud.play().catch(e => console.log("Audio error:", e)); 
            }
        }

        function playMultiHit(count) {
            let i = 0;
            function loop() {
                if(i < count) { playAudio('snd-hit'); i++; setTimeout(loop, 250); }
            }
            loop();
        }

        function speak(text) { 
            const el = document.getElementById('sr-announcer');
            el.textContent = ''; 
            setTimeout(() => el.textContent = text, 50); 
        }

        // --- GESTIONE TEMA (NUOVO) ---
        function toggleContrast() {
            const body = document.body;
            const btn = document.getElementById('contrast-toggle-btn');
            body.classList.toggle('high-contrast');
            
            const isHigh = body.classList.contains('high-contrast');
            localStorage.setItem('highContrast', isHigh);
            
            if(isHigh) {
                btn.textContent = "DISATTIVA ALTO CONTRASTO (C)";
                speak("Modalità Alto Contrasto Attivata.");
            } else {
                btn.textContent = "ATTIVA ALTO CONTRASTO (C)";
                speak("Modalità Standard TV Attivata.");
            }
        }

        // Carica preferenza
        if(localStorage.getItem('highContrast') === 'true') {
            document.body.classList.add('high-contrast');
            document.getElementById('contrast-toggle-btn').textContent = "DISATTIVA ALTO CONTRASTO (C)";
        }

        // --- GESTIONE BOTTONI ACCESSIBILE ---
        function setBtnState(id, isDisabled) {
            const btn = document.getElementById(id);
            if(!btn) return;
            if(isDisabled) {
                btn.classList.add('disabled-btn');
                btn.setAttribute('aria-disabled', 'true');
            } else {
                btn.classList.remove('disabled-btn');
                btn.setAttribute('aria-disabled', 'false');
            }
        }

        function isBtnDisabled(id) {
            return document.getElementById(id).getAttribute('aria-disabled') === 'true';
        }

        // --- SUPABASE ---
        const SUPABASE_URL = 'https://azcwkpdjbysnivknnino.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- DATI ---
        const NATO = {
            'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze',
            'G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano',
            'N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona',
            'T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara'
        };
        const WHEEL_VALUES = [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 2000, 3000, 'MISTERO', 'PASSA', 'BANCAROTTA'];
        let myId, myIndex, roomId, isHost = false;
        let currentFrase = null, currentStanza = null;
        let currentPuzzleText = "";
        let currentHintText = "";
        let fullSolutionText = ""; 
        let lastTimestamp = ""; 
        let isSpinning = false, inputMode = null;
        let wheelAngle = 0;
        let parsedBoard = [], navWordIdx = 0, navCharIdx = 0;
        let pollingInterval = null;
        let timerInterval = null;
        
        const TURN_LIMIT_SEC = 120; 

        let isFetching = false;
        let isProcessingInput = false;

        function cleanStr(str) { 
            if(!str) return "";
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");     
        }
        
        // --- LOGICA DI GIOCO ---
        async function joinGame(create) {
            const name = document.getElementById('inp-name').value.trim().toUpperCase();
            const code = document.getElementById('inp-code').value.trim().toUpperCase();
            if(!name) return speak("Manca il nome");

            let stanza;
            try {
                if (create) {
                    const { data: frasi } = await supabase.from('frasi').select('id');
                    const rid = frasi[Math.floor(Math.random()*frasi.length)].id;
                    
                    const { data: oldRoom } = await supabase.from('stanze').select('id').eq('codice',code).maybeSingle();
                    if(oldRoom) {
                         await supabase.from('giocatori').delete().eq('stanza_id', oldRoom.id);
                         await supabase.from('stanze').delete().eq('id', oldRoom.id);
                    }

                    const { data, error } = await supabase.from('stanze').insert({
                        codice:code, stato:'attesa', frase_corrente_id:rid, lettere_chiamate:[], lettere_rivelate:[], round_giocati: 1
                    }).select().maybeSingle();
                    stanza = error ? (await supabase.from('stanze').select('*').eq('codice',code).maybeSingle()).data : data;
                } else {
                    const { data } = await supabase.from('stanze').select('*').eq('codice',code).maybeSingle();
                    if(!data) return speak("Stanza non trovata");
                    stanza = data;
                }
                roomId = stanza.id;
                
                await supabase.from('giocatori').delete().eq('stanza_id', roomId).eq('nome', name);
                
                const { count } = await supabase.from('giocatori').select('*', { count: 'exact', head: true }).eq('stanza_id', roomId);
                myIndex = count || 0;
                isHost = (myIndex === 0);
                const { data: player } = await supabase.from('giocatori').insert({
                    stanza_id: roomId, nome: name, indice: myIndex, is_host: isHost, punteggio_totale: 0, punteggio_round: 0
                }).select().maybeSingle();
                myId = player.id;

                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('game-panel').classList.remove('hidden');
                
                speak(`Benvenuto ${name}. Round 1 di 10.`);
                setupRealtime(); 
                fetchFullState();
                
                if(pollingInterval) clearInterval(pollingInterval);
                pollingInterval = setInterval(fetchFullState, 4000);

                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(checkTurnTimer, 1000);

            } catch(e) {
                console.error("Errore join:", e);
                speak("Errore di connessione. Riprova.");
            }
        }

        function setupRealtime() {
            supabase.channel('game').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'stanze', filter: `id=eq.${roomId}` }, 
                () => { fetchFullState(); }).subscribe();
        }

        async function fetchFullState() {
            if(isFetching) return;
            isFetching = true;
            const { data: stanza, error } = await supabase.from('stanze').select('*, frasi(*), giocatori(*)').eq('id', roomId).maybeSingle();
            isFetching = false;
            if(stanza) updateUI(stanza);
        }

        async function checkTurnTimer() {
            if(!currentStanza || currentStanza.stato !== 'gioco') return;
            
            const lastAction = new Date(currentStanza.azione_timestamp || currentStanza.created_at).getTime();
            const now = new Date().getTime();
            const secondsPassed = Math.floor((now - lastAction) / 1000);
            
            let currentLimit = TURN_LIMIT_SEC;
            if (inputMode === 'solve') {
                currentLimit += 30;
            }

            const secondsLeft = currentLimit - secondsPassed;

            const timerBox = document.getElementById('timer-box');
            timerBox.textContent = secondsLeft > 0 ? secondsLeft : 0;
            
            if (secondsLeft === 60) {
                playAudio('snd-hit');
            }

            if(currentStanza.id_giocatore_corrente === myIndex && secondsLeft <= 0 && !isSpinning) {
                if(inputMode) {
                    closeInput();
                    speak("Tempo scaduto! Finestra chiusa.");
                }

                const numPlayers = currentStanza.giocatori.length;
                const nextPlayerIdx = (myIndex + 1) % numPlayers;
                
                speak("Tempo scaduto! Passo il turno.");
                
                await supabase.from('stanze').update({
                    id_giocatore_corrente: nextPlayerIdx,
                    ultima_azione: 'timeout',
                    ultimo_messaggio: `Tempo scaduto per ${document.getElementById('inp-name').value}!`,
                    montepremi_round: 0,
                    azione_timestamp: new Date().toISOString()
                }).eq('id', roomId);
                fetchFullState();
            }
        }

        function updateUI(stanza) {
            currentStanza = stanza;
            currentStanza.giocatori.sort((a,b) => a.indice - b.indice);

            if(stanza.stato === 'finito') {
                document.getElementById('game-panel').classList.add('hidden');
                document.getElementById('input-area').classList.add('hidden');
                document.getElementById('end-panel').classList.add('hidden');
                
                const panel = document.getElementById('round-over-panel');
                if(panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    document.getElementById('round-winner-msg').textContent = stanza.ultimo_messaggio; 
                    document.getElementById('solution-msg').textContent = "Soluzione Completa: " + fullSolutionText;
                    playMultiHit(5); 
                    speak("Round finito. " + stanza.ultimo_messaggio + ". Premi Invio per il prossimo round.");
                    setTimeout(() => document.getElementById('btn-next-round').focus(), 500);
                }
                return;
            }

            if(stanza.stato === 'terminata') {
                document.getElementById('game-panel').classList.add('hidden');
                document.getElementById('round-over-panel').classList.add('hidden');
                document.getElementById('end-panel').classList.remove('hidden');
                
                const list = document.getElementById('ranking-list');
                list.innerHTML = "";
                const sorted = [...stanza.giocatori].sort((a,b) => (b.punteggio_totale||0) - (a.punteggio_totale||0));
                sorted.forEach((p, i) => {
                    const li = document.createElement('li');
                    li.textContent = `${i+1}. ${p.nome}: €${p.punteggio_totale}`;
                    list.appendChild(li);
                });
                return;
            }

            document.getElementById('round-over-panel').classList.add('hidden');
            document.getElementById('game-panel').classList.remove('hidden');
            
            if (!currentFrase || currentFrase.id !== stanza.frasi.id) {
                currentFrase = stanza.frasi;
                navWordIdx = 0; navCharIdx = 0;
                
                fullSolutionText = currentFrase.soluzione;
                let displayHint = "";
                let puzzle = "";

                if (fullSolutionText.includes(" - ")) {
                    const parts = fullSolutionText.split(" - ");
                    const leftSide = parts[0]; 
                    const rightSide = parts[1]; 
                    
                    puzzle = rightSide.trim();

                    if (currentFrase.categoria === 'MUSICA' && leftSide.includes(": ")) {
                        displayHint = leftSide.split(": ")[0].trim();
                    } else {
                        displayHint = leftSide.trim();
                    }
                } else {
                    displayHint = "";
                    puzzle = fullSolutionText;
                }

                currentHintText = displayHint;
                currentPuzzleText = puzzle;

                let speakText = `Round ${stanza.round_giocati} di 10. Categoria: ${currentFrase.categoria}`;
                if(currentHintText) speakText += ". Indizio: " + currentHintText;
                speak(speakText);
            }

            document.getElementById('round-indicator').textContent = `ROUND ${stanza.round_giocati || 1} / 10`;

            if (stanza.azione_timestamp && stanza.azione_timestamp !== lastTimestamp) {
                const isFirstLoad = (lastTimestamp === "");
                lastTimestamp = stanza.azione_timestamp;
                
                if(!isFirstLoad) {
                    if(stanza.ultima_azione === 'vittoria') { /* ... */ } 
                    else if(stanza.ultima_azione === 'timeout') {
                        speak(stanza.ultimo_messaggio);
                        playAudio('snd-miss');
                    }
                    else if(stanza.ultima_azione === 'chiama_lettera') {
                        speak(stanza.ultimo_messaggio);
                        const match = stanza.ultimo_messaggio.match(/Trovate (\d+)/i);
                        if(match) { playMultiHit(parseInt(match[1])); }
                        else if(stanza.ultimo_messaggio.toLowerCase().includes("non c'è") || stanza.ultimo_messaggio.toLowerCase().includes("già chiamata")) {
                            playAudio('snd-miss');
                        }
                    }
                    else if(stanza.ultima_azione === 'errore') {
                        speak(stanza.ultimo_messaggio);
                        playAudio('snd-miss');
                    } else {
                        if(stanza.ultimo_messaggio) speak(stanza.ultimo_messaggio);
                    }
                }
            }

            document.getElementById('live-category').textContent = currentFrase.categoria;
            document.getElementById('round-hint').textContent = currentHintText; 
            document.getElementById('wheel-status-text').textContent = stanza.montepremi_round > 0 ? `IN PALIO: €${stanza.montepremi_round}` : "GIRA";
            
            parseAndRenderBoard(currentPuzzleText, stanza.lettere_rivelate);
            
            const currentPlayerName = stanza.giocatori.find(p => p.indice === stanza.id_giocatore_corrente)?.nome || "Sconosciuto";
            const isMyTurn = (stanza.id_giocatore_corrente === myIndex);
            
            document.getElementById('turn-indicator').textContent = isMyTurn ? "È IL TUO TURNO" : `Turno di ${currentPlayerName}`;
            document.getElementById('turn-indicator').style.color = isMyTurn ? "#00ff00" : "#fff";

            const me = stanza.giocatori.find(p => p.indice === myIndex);
            if(me) {
                document.getElementById('score-round').textContent = `€${me.punteggio_round || 0}`;
                document.getElementById('score-total').textContent = `€${me.punteggio_totale || 0}`;
            }

            const haveMoney = stanza.montepremi_round > 0;
            const btnManual = document.getElementById('btn-manual-cons');
            const busy = isSpinning || inputMode;

            setBtnState('btn-spin', !isMyTurn || busy || haveMoney);
            setBtnState('btn-solve', isSpinning);
            
            const canBuyVowel = isMyTurn && !busy && (me.punteggio_round >= 500);
            setBtnState('btn-vowel', !canBuyVowel);

            if (isMyTurn && haveMoney && !inputMode && !isSpinning) {
                btnManual.classList.remove('hidden');
                if(!inputMode) document.getElementById('wheel-status-text').textContent += " - CONSONANTE!";
            } else {
                btnManual.classList.add('hidden');
            }
        }

        // --- TABELLONE ---
        function parseAndRenderBoard(text, revealed) {
            const container = document.getElementById('board-container');
            container.innerHTML = '';
            parsedBoard = [];
            const words = text.toUpperCase().split(' ');
            let globalIdx = 0;
            
            words.forEach((wStr, i) => {
                let wordObj = { wordStr: wStr, chars: [] };
                const row = document.createElement('div'); row.className = 'board-row';
                
                for (let j = 0; j < wStr.length; j++) {
                    const ch = wStr[j];
                    const isLetter = ch.match(/[A-ZÀ-Ù]/); 
                    const isRevealed = !isLetter || revealed.includes(globalIdx);
                    
                    wordObj.chars.push({ char: ch, isRevealed: isRevealed, isLetter: !!isLetter });
                    
                    const div = document.createElement('div');
                    // GESTIONE CLASSI PER STILE
                    div.className = 'tile' + (isLetter && !isRevealed ? ' empty' : ' revealed');
                    div.textContent = (isLetter && !isRevealed) ? '' : ch;
                    div.id = `tile-${parsedBoard.length}-${j}`;
                    
                    row.appendChild(div);
                    if(isLetter) globalIdx++;
                }
                row.id = `row-${parsedBoard.length}`;
                container.appendChild(row);
                parsedBoard.push(wordObj);
            });
            highlightNav();
        }

        function moveNav(dChar) {
            if (parsedBoard.length === 0) return;
            document.querySelectorAll('.cursor-word').forEach(el => el.classList.remove('cursor-word'));
            let newC = navCharIdx + dChar;
            const wLen = parsedBoard[navWordIdx].chars.length;
            if (newC < 0) newC = 0;
            else if (newC >= wLen) newC = wLen - 1; 
            if(newC !== navCharIdx) { navCharIdx = newC; highlightNav(); readSingleChar(); }
        }

        function moveWordNav(dWord) {
            if (parsedBoard.length === 0) return;
            let newW = navWordIdx + dWord;
            if (newW < 0) newW = 0;
            if (newW >= parsedBoard.length) newW = parsedBoard.length - 1;
            navWordIdx = newW; navCharIdx = 0;
            highlightNav(true); readWholeWord();
        }

        function highlightNav(wholeWord = false) {
            document.querySelectorAll('.cursor-char').forEach(el => el.classList.remove('cursor-char'));
            document.querySelectorAll('.cursor-word').forEach(el => el.classList.remove('cursor-word'));
            if (wholeWord) { const row = document.getElementById(`row-${navWordIdx}`); if(row) row.classList.add('cursor-word'); } 
            else { const el = document.getElementById(`tile-${navWordIdx}-${navCharIdx}`); if(el) el.classList.add('cursor-char'); }
        }

        function readSingleChar() {
            const w = parsedBoard[navWordIdx];
            const c = w.chars[navCharIdx];
            const pos = (navCharIdx + 1) + " di " + w.chars.length;
            if (!c.isLetter) speak(pos + ". " + c.char); 
            else if (c.isRevealed) speak(`${pos}. ${c.char}, ${NATO[c.char]||''}.`);
            else speak(`${pos}. Nascosta.`);
        }

        function readWholeWord() {
            const w = parsedBoard[navWordIdx];
            let missing = 0;
            let reading = "";
            w.chars.forEach(c => { 
                if(c.isLetter && !c.isRevealed) missing++; 
                reading += (c.isLetter && !c.isRevealed) ? "_" : c.char;
            });
            if (missing === 0) speak(`Parola ${navWordIdx+1}: ${w.wordStr}`);
            else speak(`Parola ${navWordIdx+1}. Mancano ${missing} lettere. ${reading}`);
        }

        // --- GIOCO ---
        async function doSpin() {
            if(isBtnDisabled('btn-spin')) return;
            if(isSpinning) return speak("Aspetta.");
            
            speak("La ruota gira..."); 
            playAudio('snd-spin'); 
            isSpinning = true; 
            
            setBtnState('btn-spin', true);
            setBtnState('btn-solve', true);
            setBtnState('btn-vowel', true);
            wheelAngle += (1000 + Math.random()*500);
            document.getElementById('wheel-visual').style.transform = `rotate(${wheelAngle}deg)`;

            await new Promise(r => setTimeout(r, 3500));

            let val = WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
            let extra = "";

            if (val === 'MISTERO') {
                const opts = ['BANCAROTTA', 'PASSA', 'RADDOPPIA', 'JOLLY'];
                val = opts[Math.floor(Math.random()*opts.length)]; 
                extra = ". Svela... " + val + "!";
                if(val === 'RADDOPPIA') {
                    const me = currentStanza.giocatori.find(p=>p.id===myId);
                    await supabase.from('giocatori').update({punteggio_round: (me.punteggio_round || 0) * 2}).eq('id', myId);
                    val = 0; 
                }
            }

            const msg = `${document.getElementById('inp-name').value} ha girato: ${val}${extra}`;
            isSpinning = false;
            setBtnState('btn-solve', false);

            await supabase.from('stanze').update({
                montepremi_round: (typeof val==='number'?val:0), 
                ultima_azione: 'gira_ruota', 
                ultimo_messaggio: msg, 
                azione_timestamp: new Date().toISOString()
            }).eq('id', roomId);
            
            fetchFullState();

            if (typeof val === 'number' && val > 0) {
                setTimeout(() => {
                    if (!inputMode && currentStanza.id_giocatore_corrente === myIndex) {
                        if(document.getElementById('inspector-overlay').classList.contains('hidden')) {
                            openInput('letter');
                        } else {
                            inputMode = 'letter'; 
                        }
                    }
                }, 500);
            } else if(val !== 0) {
                const numPlayers = currentStanza.giocatori.length;
                const nextPlayerIdx = (myIndex + 1) % numPlayers;
                
                setTimeout(async()=>{
                    if(val==='BANCAROTTA') {
                        await supabase.from('giocatori').update({punteggio_totale:0, punteggio_round:0}).eq('id',myId);
                        await supabase.from('stanze').update({id_giocatore_corrente: nextPlayerIdx, montepremi_round:0}).eq('id',roomId);
                    }
                    else if(val==='JOLLY') {
                        const me = currentStanza.giocatori.find(p=>p.id===myId);
                        await supabase.from('giocatori').update({jolly: me.jolly+1}).eq('id',myId);
                        speak("Hai vinto un jolly! Gira di nuovo.");
                        setBtnState('btn-spin', false);
                    }
                    else if (val==='PASSA') {
                        await supabase.from('stanze').update({id_giocatore_corrente: nextPlayerIdx, montepremi_round:0}).eq('id',roomId);
                    }
                    fetchFullState();
                }, 1500);
            }
        }

        // --- GESTIONE INPUT ---
        function openInput(mode) {
            const me = currentStanza.giocatori.find(p=>p.id===myId);
            if(mode === 'vowel') {
                 if((me.punteggio_round || 0) < 500) return speak("Non hai 500€ nel parziale!");
                 if(isBtnDisabled('btn-vowel')) return;
            }
            if(mode === 'solve' && isBtnDisabled('btn-solve')) return;

            inputMode = mode; 
            const titles = {'letter':'CONSONANTE','vowel':'VOCALE','solve':'SOLUZIONE'};
            const titleText = titles[mode];
            document.getElementById('input-title').textContent = titleText;
            
            if(!document.getElementById('inspector-overlay').classList.contains('hidden')) {
                speak("È uscito " + titleText + ". Chiudi l'ispettore per scrivere.");
                return; 
            }

            const area = document.getElementById('input-area');
            const inp = document.getElementById('game-input');
            
            speak("Scrivi " + titleText);
            area.classList.remove('hidden');
            inp.value=''; 
            setTimeout(() => { inp.focus(); }, 100);
        }

        function closeInput() { 
            document.getElementById('input-area').classList.add('hidden');
            inputMode = null; 
            try {
                 const btnSpin = document.getElementById('btn-spin');
                 if(btnSpin && !isBtnDisabled('btn-spin')) btnSpin.focus();
                 else document.getElementById('board-container').focus();
            } catch(e) { console.log(e); }
        }

        async function submitInput() {
            if(isProcessingInput) return;
            isProcessingInput = true;

            try {
                const txt = document.getElementById('game-input').value.trim().toUpperCase();
                if(!txt) { isProcessingInput = false; return; }
                
                const mode = inputMode; 
                inputMode = null; 
                document.getElementById('input-area').classList.add('hidden'); 

                const numPlayers = currentStanza.giocatori.length;
                const nextPlayerIdx = (myIndex + 1) % numPlayers;

                if(mode === 'solve') {
                    if(cleanStr(txt) === cleanStr(currentPuzzleText)) {
                        const me = currentStanza.giocatori.find(p=>p.id===myId);
                        const winTotal = (me.punteggio_totale || 0) + (me.punteggio_round || 0);
                        
                        await supabase.from('giocatori').update({punteggio_totale: winTotal, punteggio_round: 0}).eq('id',myId);

                        await supabase.from('stanze').update({
                            stato:'finito', 
                            ultima_azione:'vittoria',
                            ultimo_messaggio:`Ha vinto ${me.nome}!`,
                            azione_timestamp:new Date().toISOString(),
                            lettere_rivelate:Array.from({length:currentPuzzleText.length},(_,i)=>i),
                            montepremi_round: 0
                        }).eq('id', roomId);
                    } else {
                        await supabase.from('stanze').update({
                            id_giocatore_corrente: nextPlayerIdx,
                            ultima_azione:'errore',
                            ultimo_messaggio:`Soluzione errata: ${txt}`,
                            azione_timestamp:new Date().toISOString(),
                            montepremi_round: 0
                        }).eq('id',roomId);
                    }
                    fetchFullState();
                }
                else {
                    const char = txt.charAt(0);
                    const sol = currentPuzzleText.toUpperCase();
                    let found = [], globalIdx = 0;
                    
                    for(let i=0; i<sol.length; i++) {
                        if(sol[i].match(/[A-ZÀ-Ù]/)) { 
                            if(cleanStr(sol[i]) === cleanStr(char)) found.push(globalIdx);
                            globalIdx++;
                        }
                    }

                    const oldCalls = currentStanza.lettere_chiamate || [];
                    if (oldCalls.some(c => cleanStr(c) === cleanStr(char))) {
                        await supabase.from('stanze').update({
                            id_giocatore_corrente: nextPlayerIdx,
                            ultima_azione: 'chiama_lettera',
                            ultimo_messaggio: `Lettera ${char} già chiamata!`,
                            azione_timestamp: new Date().toISOString(),
                            montepremi_round: 0
                        }).eq('id', roomId);
                    } else {
                        const newCalls = [...new Set([...oldCalls, char])];
                        const me = currentStanza.giocatori.find(p=>p.id===myId);
                        
                        if(mode==='vowel') {
                            await supabase.from('giocatori').update({punteggio_round: (me.punteggio_round || 0) - 500}).eq('id',myId);
                        }

                        const oldRev = currentStanza.lettere_rivelate || [];
                        const count = found.length;
                        let msg="", next=myIndex;
                        let resetSpinMoney = 0;

                        if (count > 0) {
                            msg = `Ne ho trovate ${count}`;
                            if(mode==='letter') {
                                const val = currentStanza.montepremi_round||0;
                                await supabase.from('giocatori').update({
                                    punteggio_round: (me.punteggio_round||0) + (val*count)
                                }).eq('id',myId);
                                resetSpinMoney = 0; 
                            }
                        } else {
                            msg = `La ${char} non c'è.`;
                            next = nextPlayerIdx; 
                            resetSpinMoney = 0;
                        }

                        const newRev = [...new Set([...oldRev, ...found])];
                        await supabase.from('stanze').update({
                            lettere_rivelate: newRev, 
                            lettere_chiamate: newCalls,
                            id_giocatore_corrente: next, 
                            ultima_azione: 'chiama_lettera', 
                            ultimo_messaggio: msg, 
                            montepremi_round: resetSpinMoney,
                            azione_timestamp: new Date().toISOString()
                        }).eq('id', roomId);
                    }
                    fetchFullState();
                }

            } catch(e) {
                console.error("Errore input", e);
                document.getElementById('input-area').classList.add('hidden'); 
            } finally {
                isProcessingInput = false;
            }
        }

        function openInspector() {
            const div = document.getElementById('inspector-content');
            const wordCount = parsedBoard.length;
            let html = `<h2 style="color:#ffd700;">${currentFrase.categoria} (${wordCount} PAROLE)</h2>`;
            if(currentHintText) html += `<p style="color:#00ffff;">Indizio: ${currentHintText}</p>`;
            
            parsedBoard.forEach((w, i) => {
                let s = "";
                w.chars.forEach(c => { s += c.isRevealed ? c.char : "_"; });
                html += `<p>${w.chars.length} lettere: ${s}</p>`;
            });
            div.innerHTML = html;
            document.getElementById('inspector-overlay').classList.remove('hidden');
            div.focus(); 
            
            let fullRead = `Categoria: ${currentFrase.categoria}. Ci sono ${wordCount} parole. `;
            if(currentHintText) fullRead += `Indizio: ${currentHintText}. `;
            fullRead += "Tabellone: ";
            parsedBoard.forEach(w => {
                w.chars.forEach(c => { fullRead += c.isRevealed ? c.char : " Vuota "; });
                fullRead += ". ";
            });
            speak("Ispettore aperto. " + fullRead);
        }
        
        function closeInspector() { 
            document.getElementById('inspector-overlay').classList.add('hidden');
            document.getElementById('inspector-content').innerHTML = ""; 
            speak("Ispettore chiuso."); 
            
            if(inputMode) {
                const area = document.getElementById('input-area');
                area.classList.remove('hidden');
                document.getElementById('game-input').focus();
            } else {
                if(!document.getElementById('btn-spin').disabled) {
                    document.getElementById('btn-spin').focus(); 
                } else {
                    document.getElementById('board-container').focus();
                }
            }
        }

        // --- FIX RICHIESTO: SOLO LETTERE PRESENTI ---
        function readRevealedLetters() {
            const calls = currentStanza.lettere_chiamate || [];
            const sol = cleanStr(currentPuzzleText).toUpperCase();
            
            // Filtra: tieni solo quelle che sono davvero nella soluzione
            const hits = calls.filter(c => sol.includes(c));

            if (hits.length === 0) return speak("Nessuna lettera presente scoperta.");

            hits.sort(); 
            const text = hits.map(c => `${c}, ${NATO[c] || c}`).join(". ");
            speak("Lettere presenti sul tabellone: " + text);
        }

        async function startNewRound() {
            const nextRound = (currentStanza.round_giocati || 1) + 1;
            
            if(nextRound > 10) {
                 await supabase.from('stanze').update({stato: 'terminata'}).eq('id', roomId);
                 return;
            }

            const { data: frasi } = await supabase.from('frasi').select('id');
            const rid = frasi[Math.floor(Math.random()*frasi.length)].id;
            
            await supabase.from('giocatori').update({punteggio_round:0}).eq('stanza_id',roomId);
            
            await supabase.from('stanze').update({
                frase_corrente_id:rid, 
                stato:'gioco', 
                lettere_rivelate:[], 
                lettere_chiamate:[],
                montepremi_round:0, 
                round_giocati: nextRound,
                ultima_azione:'nuovo_round', 
                ultimo_messaggio:`Round ${nextRound}!`,
                azione_timestamp:new Date().toISOString()
            }).eq('id', roomId);
            fetchFullState();
        }

        document.addEventListener('keydown', (e) => {
            if(!document.getElementById('round-over-panel').classList.contains('hidden') && e.key === 'Enter') {
                startNewRound();
                return;
            }

            if(e.ctrlKey) {
                const k = e.key.toLowerCase();
                if(k==='i') { e.preventDefault(); openInspector(); return; }
                if(k==='l') { e.preventDefault(); readRevealedLetters(); return; }
                if(k==='s') { e.preventDefault(); if(inputMode) closeInput(); openInput('solve'); return; }
                if(k==='g' && !inputMode) { e.preventDefault(); doSpin(); return; }
                if(k==='v' && !inputMode) { e.preventDefault(); openInput('vowel'); return; }
            }
            
            // Scorciatoia per cambio tema
            if(e.key.toLowerCase() === 'c' && !inputMode) {
                toggleContrast();
            }

            if(e.key === 'Escape') {
                if(!document.getElementById('inspector-overlay').classList.contains('hidden')) {
                    closeInspector();
                    return;
                }
                if(inputMode) {
                    closeInput();
                    return;
                }
            }

            if(inputMode && !document.getElementById('inspector-overlay').classList.contains('hidden')) {
               return; 
            }
            
            if(inputMode && e.key === 'Enter') {
                submitInput();
                return;
            }

            if(e.key==='ArrowRight') { e.preventDefault(); e.ctrlKey ? moveWordNav(1) : moveNav(1); }
            if(e.key==='ArrowLeft') { e.preventDefault(); e.ctrlKey ? moveWordNav(-1) : moveNav(-1); }
            if(e.key==='ArrowDown') { e.preventDefault(); moveWordNav(1); }
            if(e.key==='ArrowUp') { e.preventDefault(); moveWordNav(-1); }
        });
    </script>
</body>
</html>