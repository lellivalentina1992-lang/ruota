<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - Final Stable</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* STILI BASE */
        :root { --bg: #02203C; --box: #004a91; --gold: #FFD700; --focus: #FF00FF; }
        body { margin: 0; padding: 10px; font-family: Arial, sans-serif; background-color: var(--bg); color: white; text-align: center; }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

        /* UI SETUP */
        #setup-overlay { max-width: 600px; margin: 0 auto; }
        .panel { background: #03335f; border-radius: 8px; padding: 10px; margin-bottom: 10px; text-align: left; }
        .panel h2 { margin-top: 0; font-size: 1.1rem; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 6px; border-radius: 4px; border: none; margin-bottom: 8px; }
        button { padding: 8px 12px; margin: 4px; border-radius: 4px; border: none; cursor: pointer; background: var(--box); color: white; font-weight: bold; }
        button:focus { outline: 2px solid var(--focus); outline-offset: 2px; }
        #players-list { font-size: 0.9rem; }

        /* LAYOUT GIOCO */
        #game-container { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 8px; }
        #top-row { display: flex; flex-wrap: wrap; gap: 10px; }
        .col { flex: 1 1 300px; background: #03335f; border-radius: 8px; padding: 8px; }

        #category-display { font-size: 1.1rem; margin-bottom: 4px; color: var(--gold); }
        #board { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }

        .word-box { display: flex; margin: 2px; }
        .letter-box { width: 26px; height: 32px; border-radius: 4px; background: #011322; border: 1px solid #0a4c8a; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; }
        .letter-box.revealed { background: #0b7e3b; }
        .letter-box.space { background: transparent; border: none; width: 12px; }

        /* RUOTA */
        #wheel-container { position: relative; width: 230px; height: 230px; margin: 0 auto; border-radius: 50%; border: 4px solid #fff; overflow: hidden; transition: transform 4s cubic-bezier(0.2, 0.8, 0.1, 1); }
        .wheel-wedge { position: absolute; top: 0; right: 0; width: 50%; height: 50%; transform-origin: 0% 100%; border: 1px solid rgba(0,0,0,0.1); display:flex; align-items:flex-end; justify-content:center; font-size:0.8rem; padding-bottom:4px; }

        #status-message { font-size: 1.4em; color: var(--gold); margin: 15px 0; font-weight: bold; min-height: 1.5em; }
        #connection-alert { background: red; color: white; padding: 5px; display: none; }

        /* OVERLAY MAPPA FRASE */
        #inspector-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #inspector-box {
            background:#02203C; padding:20px; border-radius:10px; max-width:700px; max-height:80vh; overflow:auto;
        }
        #inspector-content { font-size:1rem; line-height:1.4; }

    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>
<audio id="snd-ding" src="ding.mp3"></audio>

<div id="connection-alert">CONNESSIONE PERSA...</div>

<div id="inspector-overlay" class="hidden" role="dialog" aria-label="Mappa Frase">
    <div id="inspector-box">
        <h2 style="text-align:center; margin-top:0;">MAPPA FRASE</h2>
        <div id="inspector-content" tabindex="0" role="document"></div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="closeInspector()" style="width:auto;">CHIUDI (ESC)</button>
        </div>
    </div>
</div>

<div id="setup-overlay">
    <h1>LA RUOTA ONLINE</h1>
    <div class="panel">
        <label>1. IL TUO NOME:</label>
        <input id="player-name" type="text" maxlength="20" placeholder="Es. Anna" />
    </div>
    <div class="panel">
        <h2>2. STANZA ONLINE REALTIME</h2>
        <label>Il codice stanza (es. ABC123):</label>
        <input id="room-code" type="text" maxlength="12" placeholder="Codice stanza" />
        <button id="btn-create-room">Crea nuova stanza</button>
        <button id="btn-join-room">Entra in stanza esistente</button>
        <p style="font-size:0.9rem; margin-top:6px;">
            Suggerimento: apri questa pagina da due dispositivi diversi,<br>
            usa lo stesso codice stanza e verifica che ruota, punteggi e frase cambiano per tutti.
        </p>
        <div id="players-list" aria-live="polite"></div>
    </div>
</div>

<div id="game-container" class="hidden" aria-live="polite">
    <div id="top-row">
        <div class="col" id="col-board">
            <div id="category-display"></div>
            <div id="board" aria-label="Tabellone frase" role="group"></div>
            <button id="btn-inspector" onclick="openInspector()" style="margin-top:5px; width:auto;">Mappa frase (CTRL+I)</button>
        </div>
        <div class="col" id="col-wheel">
            <div id="wheel-container" aria-label="Ruota dei premi" role="img"></div>
            <div id="status-message"></div>
        </div>
        <div class="col" id="col-players">
            <h2>Giocatori</h2>
            <div id="players-panel"></div>
            <button onclick="closeRoom()" id="btn-close-room">Chiudi partita</button>
        </div>
    </div>

    <div class="col">
        <div id="turn-info"></div>
        <div id="main-actions">
            <button id="btn-spin" onclick="spin()">Gira (CTRL+G)</button>
            <button id="btn-buy-vowel" onclick="setControls('vowel')">Vocale €500 (CTRL+V)</button>
            <button id="btn-solve" onclick="setControls('solve')">Risolvi (CTRL+S)</button>
        </div>
        <div id="letter-input-area" class="hidden">
            <label id="letter-label">Lettera:</label>
            <input id="letter-input" type="text" maxlength="1" />
            <button onclick="confirmLetter()">Conferma (INVIO)</button>
            <button onclick="setControls('main')">Annulla (ESC)</button>
        </div>
        <div id="solve-input-area" class="hidden">
            <label>Soluzione completa:</label>
            <input id="solve-input" type="text" />
            <button onclick="confirmSolve()">Conferma soluzione (INVIO)</button>
            <button onclick="setControls('main')">Annulla (ESC)</button>
        </div>
        <div id="jolly-decision-area" class="hidden">
            <button onclick="useJolly()">USA JOLLY</button>
            <button onclick="pass()">NON USARE</button>
        </div>
    </div>
</div>

<script>
    //
    // CONFIGURAZIONE SUPABASE
    //
    const SUPABASE_URL = '***METTI QUI LA TUA URL SUPABASE***';
    const SUPABASE_KEY = '***METTI QUI LA TUA ANON PUBLIC KEY***';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Valori ruota aggiornati: 100–1000, 2000, 3000 + speciali
    const wheelValues = [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 2000, 3000, 'BANCAROTTA', 'PASSA', 'MISTERO'];

    const nato = {'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','À':'A accentata','È':'E accentata','É':'E accentata','Ì':'I accentata','Ò':'O accentata','Ù':'U accentata'};

    let myId, myRoomId, myIndex, myName, roomState = {}, curSol = "", curSolDisp = "";
    let lastTs = null;

    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = text;
    }
    window.speak = speak;

    window.normalize = function (str) {
        if (!str) return "";
        return str
            .toUpperCase()
            .replace(/[ÁÀÂÃÄ]/g, "A")
            .replace(/[ÉÈÊË]/g, "E")
            .replace(/[ÍÌÎÏ]/g, "I")
            .replace(/[ÓÒÔÕÖ]/g, "O")
            .replace(/[ÚÙÛÜ]/g, "U")
            .replace(/[^A-ZÀ-Ù\s]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    };

    function renderWheel() {
        const c = document.getElementById('wheel-container'); 
        c.innerHTML = ''; 
        const arc = 360/wheelValues.length;
        wheelValues.forEach((v, i) => {
            const d = document.createElement('div'); 
            d.className = 'wheel-wedge';
            d.style.transform = `rotate(${i*arc}deg)`; 
            d.style.background = (i%2===0) ? '#0a74c4' : '#0c98b8';
            d.textContent = typeof v === 'number' ? v : v;
            c.appendChild(d);
        });
    }

    function doVisualSpin(val) {
        let idx = wheelValues.indexOf(val); 
        let rot = 1440 + (360 - (idx*(360/wheelValues.length)));
        document.getElementById('wheel-container').style.transform = `rotate(${rot}deg)`;
    }

    function renderBoard() {
        const b = document.getElementById('board');
        b.innerHTML = '';
        if (!curSolDisp) return;
        const words = curSolDisp.split(' ');
        let idx = 0;
        words.forEach((w, wi) => {
            const wDiv = document.createElement('div');
            wDiv.className = 'word-box';
            wDiv.dataset.wordIdx = wi;
            for (let c of w) {
                const box = document.createElement('div');
                box.className = 'letter-box';
                if (c === ' ') {
                    box.classList.add('space');
                    box.textContent = '';
                } else {
                    if ((roomState.lettere_rivelate || []).includes(idx)) {
                        box.classList.add('revealed');
                        box.textContent = c;
                    } else {
                        box.textContent = '';
                    }
                    box.dataset.globalIdx = idx;
                    box.dataset.wordIdx = wi;
                    idx++;
                }
                wDiv.appendChild(box);
            }
            b.appendChild(wDiv);
        });
    }

    function renderPlayers(players) {
        const panel = document.getElementById('players-panel');
        panel.innerHTML = '';
        players.forEach(p => {
            const div = document.createElement('div');
            div.style.marginBottom = '8px';
            const isTurn = roomState.id_giocatore_corrente === p.indice;
            div.innerHTML = `
                <div${isTurn ? ' style="color:yellow;font-weight:bold;"' : ''}>
                    ${p.nome} ${isTurn ? '(TURNO)' : ''}
                </div>
                <div>Totale: €${p.punteggio_totale}</div>
                <div>Jolly: ${p.jolly}</div>
            `;
            panel.appendChild(div);
        });
    }

    function isMyTurn() {
        return roomState.id_giocatore_corrente === myIndex;
    }

    async function broadcast(action, msg, extra = {}) {
        await supabase.from('stanze').update({
            ultima_azione: action,
            ultimo_messaggio: msg,
            azione_timestamp: Date.now().toString(),
            ...extra
        }).eq('id', myRoomId);
    }

    //
    // SETUP STANZA
    //
    async function createOrJoinRoom(isCreate) {
        myName = (document.getElementById('player-name').value || '').trim();
        const code = (document.getElementById('room-code').value || '').trim().toUpperCase();
        if (!myName || !code) {
            alert("Scrivi il tuo nome e il codice stanza."); return;
        }

        if (isCreate) {
            const { data: room } = await supabase.from('stanze').insert({
                codice: code,
                stato: 'attesa'
            }).select().single();
            myRoomId = room.id;
            const { data: player } = await supabase.from('giocatori').insert({
                stanza_id: myRoomId,
                nome: myName,
                indice: 0,
                is_host: true
            }).select().single();
            myId = player.id;
            myIndex = player.indice;
        } else {
            const { data: room } = await supabase.from('stanze').select('*').eq('codice', code).maybeSingle();
            if (!room) {
                alert("Stanza non trovata."); return;
            }
            myRoomId = room.id;
            const { data: players } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
            const newIndex = players.length;
            const { data: player } = await supabase.from('giocatori').insert({
                stanza_id: myRoomId,
                nome: myName,
                indice: newIndex,
                is_host: false
            }).select().single();
            myId = player.id;
            myIndex = player.indice;
        }

        document.getElementById('setup-overlay').classList.add('hidden');
        document.getElementById('game-container').classList.remove('hidden');
        renderWheel();
        subscribeRoom();
    }

    document.getElementById('btn-create-room').onclick = () => createOrJoinRoom(true);
    document.getElementById('btn-join-room').onclick = () => createOrJoinRoom(false);

    async function subscribeRoom() {
        const channel = supabase
            .channel('stanze-' + myRoomId)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'stanze', filter: 'id=eq.' + myRoomId }, payload => {
                handleRoomUpdate(payload.new);
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'giocatori', filter: 'stanza_id=eq.' + myRoomId }, payload => {
                refreshPlayers();
            })
            .subscribe();

        const { data: s } = await supabase.from('stanze').select('*').eq('id', myRoomId).single();
        handleRoomUpdate(s);
        await refreshPlayers();
    }

    async function refreshPlayers() {
        const { data: players } = await supabase.from('giocatori').select('*').eq('stanza_id', myRoomId).order('indice');
        renderPlayers(players || []);
    }

    async function handleRoomUpdate(s) {
        roomState = s;

        if (s.frase_corrente_id) {
            const { data: f } = await supabase.from('frasi').select('*').eq('id', s.frase_corrente_id).single();
            if (f) {
                curSolDisp = f.soluzione.toUpperCase(); 
                curSol = window.normalize(f.soluzione);
                document.getElementById('category-display').textContent = f.categoria;
            }
        }

        renderBoard();

        if (s.stato === 'chiusa') {
            alert("Partita chiusa.");
            location.reload();
            return;
        }

        if (s.azione_timestamp !== lastTs) {
            lastTs = s.azione_timestamp;
            if (s.ultima_azione === 'spin_start') {
                const a = document.getElementById('snd-spin'); 
                a.currentTime = 0; a.play().catch(()=>{});
            } else if (s.ultima_azione === 'hit-1' || s.ultima_azione === 'hit-2' || s.ultima_azione === 'hit-5') {
                const a = document.getElementById('snd-hit'); 
                a.currentTime = 0; a.play().catch(()=>{});
            } else if (s.ultima_azione === 'miss') {
                const a = document.getElementById('snd-miss'); 
                a.currentTime = 0; a.play().catch(()=>{});
            } else if (s.ultima_azione === 'ding') {
                const a = document.getElementById('snd-ding'); 
                a.currentTime = 0; a.play().catch(()=>{});
            }

            document.getElementById('status-message').textContent = s.ultimo_messaggio || '';
        }

        const myTurn = s.id_giocatore_corrente === myIndex;
        document.getElementById('turn-info').textContent = myTurn ? "È il tuo turno." : "Turno di un altro giocatore.";
        if (!myTurn) {
            setControls('none');
        } else {
            setControls('main');
        }
    }

    window.setControls = function(m) {
        ['main-actions','letter-input-area','solve-input-area','jolly-decision-area'].forEach(id => document.getElementById(id).classList.add('hidden'));

        if (m === 'main') { 
            document.getElementById('main-actions').classList.remove('hidden'); 
            document.getElementById('btn-spin').focus(); 
        }
        if (m === 'consonant' || m === 'vowel') { 
            document.getElementById('letter-input-area').classList.remove('hidden'); 
            const inp = document.getElementById('letter-input');
            document.getElementById('letter-label').textContent = m === 'vowel' ? "Vocale:" : "Consonante:";
            inp.value = '';
            inp.placeholder = m === 'vowel' ? "VOCALE" : "CONSONANTE";
            inp.focus(); 
        }
        if (m === 'solve') { 
            document.getElementById('solve-input-area').classList.remove('hidden'); 
            const si = document.getElementById('solve-input');
            si.value = '';
            si.focus(); 
        }
        if (m === 'none') {
            // tutto nascosto, nessun controllo attivo
        }
    };

    window.closeRoom = async function() {
        if(!confirm("Chiudere la partita?")) return;
        await supabase.from('stanze').update({stato:'chiusa'}).eq('id', myRoomId);
        await supabase.from('stanze').delete().eq('id', myRoomId);
        location.reload();
    };

    window.openInspector = function() {
        const words = curSolDisp.split(' ');
        let absIndex = 0;
        let html = "";
        words.forEach((w, i) => {
            let wordStr = "";
            for(let char of w) {
                if(char.match(/[A-ZÀ-Ù]/)) {
                    if((roomState.lettere_rivelate||[]).includes(absIndex)) wordStr += char + " ";
                    else wordStr += "- ";
                    absIndex++;
                } else {
                    wordStr += char + " ";
                }
            }
            html += `<div>Parola ${i+1}: ${wordStr}</div>`;
        });
        const box = document.getElementById('inspector-content');
        box.innerHTML = html;
        document.getElementById('inspector-overlay').classList.remove('hidden');
        box.focus();
    };

    window.closeInspector = function() {
        document.getElementById('inspector-overlay').classList.add('hidden');
    };

    window.spin = function() {
        if(!isMyTurn()) return window.speak("Non tocca a te.");
        window.setControls('none');
        const v = wheelValues[Math.floor(Math.random()*wheelValues.length)];
        doVisualSpin(v);
        broadcast('spin_start', '', {}); 

        setTimeout(async () => {
            if(typeof v === 'number') {
                sessionStorage.setItem('sv', v);
                await broadcast('spin_result', `${myName} ottiene ${v}.`, {});
                if(isMyTurn()) window.setControls('consonant');
            } else if (v === 'BANCAROTTA') {
                bankrupt();
            } else if (v === 'PASSA') {
                await broadcast('miss', `${myName} passa.`, {}); 
                pass();
            } else if (v === 'MISTERO') {
                mystery();
            }
        }, 5500);
    };

    async function mystery() {
        if(!isMyTurn()) return;
        window.speak("Mistero...");
        setTimeout(async()=>{
            if(Math.random() < 0.5) { 
                await broadcast('miss', "Mistero: BANCAROTTA!", {montepremi_round:0}); 
                setTimeout(pass, 1500); 
            } else { 
                const {data:me}=await supabase.from('giocatori').select('jolly').eq('id',myId).single();
                await supabase.from('giocatori').update({jolly:(me.jolly||0)+1}).eq('id',myId);
                await broadcast('hit-1', "Mistero: Jolly!", {}); 
                window.setControls('main'); 
            }
        }, 1500);
    }

    window.pass = async function() {
        const { data: players } = await supabase.from('giocatori').select('indice').eq('stanza_id', myRoomId).order('indice');
        let currArrIdx = players.findIndex(p => p.indice === myIndex);
        let nextArrIdx = (currArrIdx + 1) % players.length;
        await supabase.from('stanze').update({id_giocatore_corrente: players[nextArrIdx].indice}).eq('id', myRoomId);
    };

    async function bankrupt() {
        if(!isMyTurn()) return;
        const {data:me}=await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
        await supabase.from('giocatori').update({punteggio_totale:(me.punteggio_totale||0)}).eq('id',myId);
        await broadcast('miss', `${myName} finisce in BANCAROTTA e perde il montepremi del round.`, {montepremi_round:0});
        setControls('main');
        pass();
    }

    window.confirmLetter = async function() {
        if(!isMyTurn()) return;
        const inp = document.getElementById('letter-input');
        let ch = (inp.value || '').toUpperCase();
        if(!ch.match(/[A-ZÀ-Ù]/)) {
            alert("Inserisci una lettera valida.");
            inp.focus();
            return;
        }
        const isVowel = 'AEIOUÀÈÉÌÒÙ'.includes(ch);
        const mode = document.getElementById('letter-label').textContent.includes('Vocale') ? 'vowel' : 'consonant';
        if (isVowel && mode === 'consonant') {
            alert("Devi inserire una consonante."); inp.focus(); return;
        }
        if (!isVowel && mode === 'vowel') {
            alert("Devi inserire una vocale."); inp.focus(); return;
        }

        inp.value = '';
        if ((roomState.lettere_chiamate || []).includes(ch)) {
            alert("Lettera già chiamata."); 
            setControls('main'); 
            return;
        }

        if (isVowel) {
            const {data:me}=await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
            if ((me.punteggio_totale||0) < 500) {
                alert("Non hai abbastanza soldi per comprare una vocale.");
                setControls('main');
                return;
            }
            await supabase.from('giocatori').update({punteggio_totale:(me.punteggio_totale||0)-500}).eq('id',myId);
        }

        let hits = [];
        let idx = 0;
        for (let c of curSolDisp) {
            if (c === ' ') continue;
            if (c === ch) hits.push(idx);
            idx++;
        }

        const newLetters = [...(roomState.lettere_chiamate || []), ch];

        if (hits.length > 0) {
            const newRevealed = Array.from(new Set([...(roomState.lettere_rivelate || []), ...hits]));
            let addMoney = 0;
            if (!isVowel) {
                const v = parseInt(sessionStorage.getItem('sv') || '0',10);
                addMoney = v * hits.length;
            }
            const newRound = (roomState.montepremi_round || 0) + addMoney;

            await supabase.from('stanze').update({
                lettere_chiamate: newLetters,
                lettere_rivelate: newRevealed,
                montepremi_round: newRound
            }).eq('id', myRoomId);

            await broadcast(isVowel?'hit-1':'hit-2', `${myName} trova ${hits.length} ${ch}.`, {});
            setControls('main');
        } else {
            const {data:me}=await supabase.from('giocatori').select('jolly').eq('id',myId).single();
            if ((me.jolly||0) > 0) {
                window.speak("Lettera assente. Vuoi usare il jolly?");
                document.getElementById('jolly-decision-area').classList.remove('hidden');
                document.getElementById('main-actions').classList.add('hidden');
            } else {
                await broadcast('miss', `${myName} non trova ${ch}.`, {});
                pass();
            }
        }
    };

    window.useJolly = async function() {
        const {data:me}=await supabase.from('giocatori').select('jolly').eq('id',myId).single();
        if ((me.jolly||0) <= 0) {
            setControls('main');
            return;
        }
        await supabase.from('giocatori').update({jolly:(me.jolly||0)-1}).eq('id',myId);
        await broadcast('hit-1', `${myName} usa un jolly e mantiene il turno.`, {});
        document.getElementById('jolly-decision-area').classList.add('hidden');
        setControls('main');
    };

    window.confirmSolve = async function() {
        if(!isMyTurn()) return;
        const inp = document.getElementById('solve-input');
        const txt = inp.value || '';
        inp.value = '';
        window.setControls('main'); 

        if(window.normalize(txt) === curSol) {
            const roundMoney = roomState.montepremi_round || 0;
            const w = roundMoney < 1000 ? 1000 : roundMoney;
            const {data:me}=await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
            await supabase.from('giocatori').update({punteggio_totale:(me.punteggio_totale||0)+w}).eq('id',myId);
            // Incrementa il numero di round giocati e azzera il montepremi del round
            await supabase.from('stanze').update({
                montepremi_round: 0,
                round_giocati: (roomState.round_giocati || 0) + 1
            }).eq('id', myRoomId);
            let allIndices = []; let c = 0; for(let char of curSolDisp) if(char !== ' ') { allIndices.push(c); c++; }
            await broadcast('hit-5', `VITTORIA! ${myName} indovina: ${curSolDisp}`, {lettere_rivelate: allIndices});
            setTimeout(() => { startNewRound(); }, 8000); 
        } else {
            await broadcast('miss', `${myName} sbaglia soluzione.`); 
            setTimeout(pass, 1500);
        }
    };

    async function startNewRound() {
        if(myIndex !== roomState.id_giocatore_corrente) return; 
        // Controlla se è stato raggiunto il limite di 10 frasi
        const roundsPlayed = roomState.round_giocati || 0;
        if(roundsPlayed >= 10) {
            await supabase.from('stanze').update({
                stato: 'chiusa',
                ultimo_messaggio: 'Partita conclusa: avete giocato 10 frasi!',
                ultima_azione: 'fine_partita',
                azione_timestamp: Date.now().toString()
            }).eq('id', myRoomId);
            return;
        }
        const prevWinnerIdx = roomState.vincitore_precedente_idx;
        const consec = roomState.vittorie_consecutive || 0;
        let newConsec = 1;
        let nextStarter = myIndex;

        if(prevWinnerIdx === myIndex) {
            newConsec = consec + 1;
            if(newConsec >= 2) {
                const { count } = await supabase.from('giocatori').select('*', { count: 'exact', head: true }).eq('stanza_id', myRoomId);
                nextStarter = (myIndex + 1) % count;
                newConsec = 0;
            }
        }

        await broadcast('spin_start', "Caricamento nuovo round...", {}); 
        const { data: f } = await supabase.from('frasi').select('*');
        const newFrase = f[Math.floor(Math.random()*f.length)];
        await supabase.from('stanze').update({
            frase_corrente_id: newFrase.id,
            id_giocatore_corrente: nextStarter, 
            vincitore_precedente_idx: myIndex,  
            vittorie_consecutive: newConsec,    
            lettere_chiamate: [], lettere_rivelate: [], montepremi_round: 0,
            ultimo_messaggio: `Nuovo Round! Categoria: ${newFrase.categoria}`,
            ultima_azione: 'ding', azione_timestamp: Date.now().toString()
        }).eq('id', myRoomId);
    }

    // TASTI RAPIDI BASE
    document.addEventListener('keydown', e => {
        if(e.key === 'Escape') {
            if(!document.getElementById('inspector-overlay').classList.contains('hidden')) {
                closeInspector();
                return;
            }
            setControls('main');
        }
        if(e.ctrlKey) {
            if(e.key.toLowerCase()==='g') { e.preventDefault(); document.getElementById('btn-spin').click(); }
            if(e.key.toLowerCase()==='v') { e.preventDefault(); document.getElementById('btn-buy-vowel').click(); }
            if(e.key.toLowerCase()==='s') { e.preventDefault(); setControls('solve'); }
            if(e.key.toLowerCase()==='i') { e.preventDefault(); openInspector(); }
        }
        if(e.key === 'Enter') {
            const letterArea = !document.getElementById('letter-input-area').classList.contains('hidden');
            const solveArea = !document.getElementById('solve-input-area').classList.contains('hidden');
            if(letterArea) window.confirmLetter();
            if(solveArea) window.confirmSolve();
        }
    });

    renderWheel();
</script>
</body>
</html>
