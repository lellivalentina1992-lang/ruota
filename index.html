<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - Versione Unificata Accessibile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- STILE AD ALTO CONTRASTO --- */
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Verdana', sans-serif;
            margin: 0;
            padding: 10px;
            text-align: center;
        }

        *:focus {
            outline: 4px solid #ffd700 !important;
            box-shadow: 0 0 15px #ffd700;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
        }
        .hidden { display: none !important; }

        .container { max-width: 1000px; margin: 0 auto; }

        #setup-panel, #lobby-panel {
            border: 2px solid #ffd700;
            padding: 20px;
            margin-top: 20px;
            background: #111;
            border-radius: 10px;
        }

        /* Tabellone */
        #board-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            background: #053305;
            border: 4px solid #fff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            min-height: 100px;
        }

        .tile {
            width: 45px;
            height: 60px;
            background: #ffffff;
            color: #000000;
            font-weight: 900;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #999;
        }
        .tile.empty {
            background: #006600;
            color: transparent;
            border: 1px dashed #00cc00;
        }
        .tile.space {
            background: transparent;
            border: none;
            width: 20px;
        }

        /* Ruota */
        #wheel-visual {
            width: 250px;
            height: 250px;
            margin: 20px auto;
            border-radius: 50%;
            border: 8px solid #fff;
            background: conic-gradient(
                #ff0000 0deg 36deg, #ff7f00 36deg 72deg, #ffff00 72deg 108deg,
                #00ff00 108deg 144deg, #0000ff 144deg 180deg, #4b0082 180deg 216deg,
                #8b00ff 216deg 252deg, #ffffff 252deg 288deg, #000000 288deg 324deg, #ff1493 324deg 360deg
            );
            transition: transform 3s cubic-bezier(0.1, 0.8, 0.1, 1);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        #wheel-pointer {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #fff;
            margin: 0 auto -15px auto;
            position: relative;
            z-index: 10;
        }

        /* Pulsanti */
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            border-radius: 8px;
            border: 2px solid #fff;
        }
        .btn-primary { background: #ffcc00; color: #000; }
        .btn-secondary { background: #00ccff; color: #000; }
        .btn-danger { background: #ff0000; color: #fff; }
        button:disabled {
            background: #333;
            color: #777;
            border-color: #555;
            cursor: not-allowed;
        }

        /* Input Overlay */
        #input-area {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        input {
            font-size: 1.5em;
            padding: 10px;
            text-align: center;
            width: 80%;
            max-width: 400px;
        }

        /* Status */
        #status-bar {
            background: #222;
            padding: 10px;
            border-bottom: 2px solid #555;
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <!-- Annunciatore per screen reader -->
    <div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

    <h1>La Ruota</h1>

    <!-- Pannello iniziale -->
    <div id="setup-panel" class="container">
        <h2>Benvenuto</h2>
        <label for="inp-name">Tuo Nome:</label><br>
        <input id="inp-name" type="text" placeholder="Nome"><br><br>
        <label for="inp-code">Codice Stanza:</label><br>
        <input id="inp-code" type="text" value="STANZA1"><br><br>
        <button onclick="joinGame(true)" class="btn-primary">CREA STANZA</button>
        <button onclick="joinGame(false)" class="btn-secondary">ENTRA</button>
    </div>

    <!-- Pannello di gioco -->
    <div id="game-panel" class="container hidden">
        <div id="status-bar">
            <span id="turn-indicator">In attesa...</span>
            <span id="my-score">Tu: €0</span>
        </div>

        <h2 id="live-category" style="color:#ffd700; font-size: 2em; margin: 20px 0;">...</h2>

        <div id="board-container" role="region" aria-label="Tabellone di gioco"></div>

        <div id="wheel-pointer"></div>
        <div id="wheel-visual" aria-hidden="true"></div>
        <div id="wheel-status-text" style="font-size: 1.5em; font-weight: bold; color: cyan; margin: 10px;">
            GIRA LA RUOTA
        </div>

        <div id="controls">
            <button id="btn-spin" class="btn-primary" onclick="doSpin()">1. GIRA (G)</button>
            <button id="btn-letter" class="btn-secondary" onclick="openInput('letter')">2. CONSONANTE (C)</button>
            <button id="btn-vowel" class="btn-secondary" onclick="openInput('vowel')">3. VOCALE (V)</button>
            <button id="btn-solve" class="btn-danger" onclick="openInput('solve')">4. RISOLVI (S)</button>
            <br>
            <button onclick="readBoard()">RILEGGI TABELLONE (L)</button>
            <button onclick="readTopic()">RILEGGI ARGOMENTO (T)</button>
        </div>

        <div id="host-controls" class="hidden" style="border-top: 1px solid #555; margin-top: 20px; padding-top: 10px;">
            <button onclick="startNewRound()" style="background: #444; color: #fff;">NUOVO ROUND (N)</button>
        </div>
    </div>

    <!-- Overlay di input -->
    <div id="input-area" class="hidden">
        <h2 id="input-title" style="color:#ffd700">INSERISCI</h2>
        <input id="game-input" type="text" autocomplete="off">
        <div style="margin-top: 20px;">
            <button onclick="submitInput()" class="btn-primary">CONFERMA (Invio)</button>
            <button onclick="closeInput()" class="btn-secondary">ANNULLA (Esc)</button>
        </div>
    </div>

    <script>
        // --- AUDIO SINTETICI (TONI) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            if (type === 'spin') {
                osc.frequency.setValueAtTime(200, now);
                osc.type = 'square';
                gain.gain.setValueAtTime(0.1, now);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'hit') {
                osc.frequency.setValueAtTime(800, now);
                osc.type = 'sine';
                gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'miss') {
                osc.frequency.setValueAtTime(150, now);
                osc.type = 'sawtooth';
                gain.gain.linearRampToValueAtTime(0.00001, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'win') {
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.setValueAtTime(800, now + 0.2);
                osc.type = 'triangle';
                gain.gain.setValueAtTime(0.2, now);
                osc.start(now);
                osc.stop(now + 0.6);
            }
        }

        // --- CONFIGURAZIONE SUPABASE ---
        const SUPABASE_URL = 'https://azcwkpdjbysnivknnino.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATO GIOCO ---
        const NATO = {
            'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze',
            'G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano',
            'N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino',
            'U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara'
        };
        const WHEEL_VALUES = [100, 200, 300, 500, 1000, 2000, 'PASSA', 'BANCAROTTA', 'JOLLY'];

        let myId = null;
        let myIndex = null;
        let roomId = null;
        let isHost = false;
        let myName = "";
        let currentFrase = null;
        let currentStanza = null;
        let lastTimestamp = "";
        let isSpinning = false;
        let inputMode = null;
        let wheelAngle = 0;

        function speak(text) {
            const el = document.getElementById('sr-announcer');
            el.textContent = '';
            setTimeout(() => el.textContent = text, 50);
        }

        // --- AVVIO ---
        async function joinGame(create) {
            const name = document.getElementById('inp-name').value.trim();
            const code = document.getElementById('inp-code').value.trim().toUpperCase();
            if (!name) {
                speak("Inserisci il nome");
                return;
            }
            myName = name;

            let stanza;

            if (create) {
                const { data: frasi } = await supabase.from('frasi').select('id');
                const rid = frasi[Math.floor(Math.random() * frasi.length)].id;
                const { data, error } = await supabase
                    .from('stanze')
                    .insert({ codice: code, stato: 'attesa', frase_corrente_id: rid })
                    .select()
                    .single();
                if (error) {
                    const { data: exist } = await supabase
                        .from('stanze').select('*').eq('codice', code).single();
                    stanza = exist;
                } else {
                    stanza = data;
                }
            } else {
                const { data } = await supabase
                    .from('stanze').select('*').eq('codice', code).single();
                if (!data) {
                    speak("Stanza non trovata");
                    return;
                }
                stanza = data;
            }
            roomId = stanza.id;

            await supabase.from('giocatori')
                .delete()
                .eq('stanza_id', roomId)
                .eq('nome', name);

            const { count } = await supabase
                .from('giocatori')
                .select('*', { count: 'exact', head: true })
                .eq('stanza_id', roomId);

            myIndex = count || 0;
            isHost = (myIndex === 0);

            const { data: player } = await supabase
                .from('giocatori')
                .insert({
                    stanza_id: roomId,
                    nome: name,
                    indice: myIndex,
                    is_host: isHost
                })
                .select()
                .single();

            myId = player.id;

            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('game-panel').classList.remove('hidden');
            if (isHost) document.getElementById('host-controls').classList.remove('hidden');

            speak(`Benvenuto ${name}. Sei il giocatore ${myIndex + 1}.`);

            setupRealtime();
            fetchFullState();
        }

        function setupRealtime() {
            supabase.channel('game')
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'stanze', filter: `id=eq.${roomId}` },
                    () => { fetchFullState(); }
                )
                .subscribe();
        }

        async function fetchFullState() {
            const { data: stanza } = await supabase
                .from('stanze')
                .select('*, frasi(*), giocatori(*)')
                .eq('id', roomId)
                .single();
            if (stanza) updateUI(stanza);
        }

        function updateUI(stanza) {
            const oldFraseId = currentFrase ? currentFrase.id : -1;
            currentStanza = stanza;
            currentFrase = stanza.frasi;

            if (stanza.azione_timestamp && stanza.azione_timestamp !== lastTimestamp) {
                lastTimestamp = stanza.azione_timestamp;
                if (stanza.ultimo_messaggio) speak(stanza.ultimo_messaggio);

                if (stanza.ultima_azione === 'gira_ruota') doVisualSpin();
                if (stanza.ultima_azione === 'chiama_lettera' &&
                    stanza.ultimo_messaggio &&
                    stanza.ultimo_messaggio.includes('Ce ne sono')) {
                    playTone('hit');
                }
                if (stanza.ultima_azione === 'chiama_lettera' &&
                    stanza.ultimo_messaggio &&
                    (stanza.ultimo_messaggio.includes("Non c'è") ||
                     stanza.ultimo_messaggio.includes("non c'è") ||
                     stanza.ultimo_messaggio.includes("sbagliato"))) {
                    playTone('miss');
                }
                if (stanza.ultima_azione === 'vittoria') playTone('win');
            }

            if (currentFrase.id !== oldFraseId) {
                speak("Nuovo Round! Argomento: " + currentFrase.categoria);
            }

            document.getElementById('live-category').textContent =
                "ARGOMENTO: " + currentFrase.categoria;
            document.getElementById('wheel-status-text').textContent =
                stanza.montepremi_round > 0
                    ? `IN PALIO: €${stanza.montepremi_round}`
                    : "GIRA LA RUOTA";

            renderBoard(currentFrase.soluzione, stanza.lettere_rivelate);

            const isMyTurn = (stanza.id_giocatore_corrente === myIndex);
            const turnTxt = isMyTurn ? "È IL TUO TURNO" : "Turno avversario";
            const turnEl = document.getElementById('turn-indicator');
            turnEl.textContent = turnTxt;
            turnEl.style.color = isMyTurn ? "#00ff00" : "#ffffff";

            const busy = isSpinning || !!inputMode;
            document.getElementById('btn-spin').disabled   = !isMyTurn || busy;
            document.getElementById('btn-letter').disabled = !isMyTurn || busy;
            document.getElementById('btn-vowel').disabled  = !isMyTurn || busy;
            document.getElementById('btn-solve').disabled  = !isMyTurn || busy;

            const me = stanza.giocatori.find(p => p.indice === myIndex);
            if (me) {
                const jolly = (typeof me.jolly === 'number') ? me.jolly : 0;
                document.getElementById('my-score').textContent =
                    `Tu: €${me.punteggio_totale} (Jolly: ${jolly})`;
            }
        }

        // --- TABELLONE: NIENTE TABINDEX, SI LEGGE CON LE FRECCE ---
        function renderBoard(text, revealedIndices) {
            const container = document.getElementById('board-container');
            container.innerHTML = '';

            const chars = text.toUpperCase().split('');
            const revealed = Array.isArray(revealedIndices) ? revealedIndices : [];

            let letterCounter = 0;
            const totalLetters = chars.filter(c => c.match(/[A-ZÀ-Ù]/)).length;

            chars.forEach((char, idx) => {
                const isLetter = char.match(/[A-ZÀ-Ù]/);
                const div = document.createElement('div');

                if (!isLetter) {
                    div.className = 'tile space';
                    div.setAttribute('aria-hidden', 'true');
                } else {
                    letterCounter++;
                    const isRevealed = revealed.includes(idx);
                    div.className = isRevealed ? 'tile' : 'tile empty';
                    div.textContent = isRevealed ? char : '';

                    // niente tabindex -> NVDA lo leggerà con le frecce come normale contenuto
                    let label;
                    if (isRevealed) {
                        const nato = NATO[char] ? `, ${NATO[char]}` : '';
                        label = `Lettera ${char}${nato}. ${letterCounter} di ${totalLetters}.`;
                    } else {
                        label = `Vuota. ${letterCounter} di ${totalLetters}.`;
                    }
                    div.setAttribute('aria-label', label);
                }

                container.appendChild(div);
            });
        }

        // --- RUOTA ---
        async function doSpin() {
            if (isSpinning) {
                speak("Aspetta che finisca la rotazione.");
                return;
            }

            speak("Giro la ruota...");
            playTone('spin');
            isSpinning = true;
            document.getElementById('btn-spin').disabled = true;

            const val = WHEEL_VALUES[Math.floor(Math.random() * WHEEL_VALUES.length)];
            const msg = `${myName} ha girato: ${val}`;

            await supabase.from('stanze').update({
                montepremi_round: (typeof val === 'number' ? val : 0),
                ultima_azione: 'gira_ruota',
                ultimo_messaggio: msg,
                azione_timestamp: new Date().toISOString()
            }).eq('id', roomId);

            if (typeof val !== 'number' && val !== 'JOLLY') {
                setTimeout(async () => {
                    speak(val + "! Passi il turno.");
                    playTone('miss');
                    const next = (myIndex + 1) % 2;

                    if (val === 'BANCAROTTA') {
                        await supabase
                            .from('giocatori')
                            .update({ punteggio_totale: 0 })
                            .eq('id', myId);
                    }

                    await supabase.from('stanze').update({
                        id_giocatore_corrente: next,
                        montepremi_round: 0
                    }).eq('id', roomId);
                }, 3000);
            }

            setTimeout(() => { isSpinning = false; }, 3000);
        }

        function doVisualSpin() {
            const w = document.getElementById('wheel-visual');
            wheelAngle += (700 + Math.random() * 300);
            w.style.transform = `rotate(${wheelAngle}deg)`;

            let ticks = 0;
            const interval = setInterval(() => {
                playTone('spin');
                ticks++;
                if (ticks > 10) clearInterval(interval);
            }, 200);
        }

        // --- INPUT (CONSONANTE / VOCALE / SOLUZIONE) ---
        function openInput(mode) {
            inputMode = mode;
            document.getElementById('input-area').classList.remove('hidden');
            const inp = document.getElementById('game-input');
            inp.value = '';
            inp.focus();

            const titles = {
                'letter': 'CONSONANTE',
                'vowel': 'VOCALE (€500)',
                'solve': 'SOLUZIONE'
            };
            document.getElementById('input-title').textContent = titles[mode] || 'INSERISCI';
            speak("Inserisci " + (titles[mode] || 'il testo'));
        }

        function closeInput() {
            document.getElementById('input-area').classList.add('hidden');
            inputMode = null;
            document.getElementById('btn-spin').focus();
        }

        async function submitInput() {
            const txt = document.getElementById('game-input').value.toUpperCase().trim();
            if (!txt) return;
            const mode = inputMode;
            closeInput();

            if (!currentFrase || !currentStanza) return;

            speak("Controllo " + txt + "...");

            if (mode === 'solve') {
                const real = currentFrase.soluzione.toUpperCase().trim();
                if (txt === real) {
                    speak("ESATTO! HAI VINTO!");
                    const len = real.length;
                    await supabase.from('stanze').update({
                        stato: 'finito',
                        ultima_azione: 'vittoria',
                        ultimo_messaggio: `${myName} HA INDOVINATO! ${real}`,
                        azione_timestamp: new Date().toISOString(),
                        lettere_rivelate: Array.from({ length: len }, (_, i) => i)
                    }).eq('id', roomId);
                } else {
                    speak("Sbagliato! Passi il turno.");
                    playTone('miss');
                    await supabase.from('stanze').update({
                        id_giocatore_corrente: (myIndex + 1) % 2,
                        ultima_azione: 'errore',
                        ultimo_messaggio: `${myName} ha sbagliato la soluzione!`,
                        azione_timestamp: new Date().toISOString()
                    }).eq('id', roomId);
                }
                return;
            }

            const char = txt.charAt(0);
            const sol = currentFrase.soluzione.toUpperCase();
            let found = [];
            for (let i = 0; i < sol.length; i++) {
                if (sol[i] === char) found.push(i);
            }

            const oldRev = currentStanza.lettere_rivelate || [];
            const count = found.length;

            if (mode === 'vowel') {
                const me = currentStanza.giocatori.find(p => p.id === myId);
                if (!me || me.punteggio_totale < 500) {
                    speak("Non hai 500 euro per comprare una vocale.");
                    return;
                }
                await supabase
                    .from('giocatori')
                    .update({ punteggio_totale: me.punteggio_totale - 500 })
                    .eq('id', myId);
            }

            let msg = "";
            let nextPlayer = myIndex;

            if (count > 0) {
                const isNew = found.some(idx => !oldRev.includes(idx));
                if (isNew) {
                    msg = `${myName} chiama ${char}. Ce ne sono ${count}!`;

                    if (mode === 'letter') {
                        const val = currentStanza.montepremi_round || 0;
                        const me2 = currentStanza.giocatori.find(p => p.id === myId);
                        if (me2 && val > 0) {
                            await supabase
                                .from('giocatori')
                                .update({ punteggio_totale: me2.punteggio_totale + (val * count) })
                                .eq('id', myId);
                        }
                    }
                } else {
                    msg = `${char} era già stata scoperta.`;
                    nextPlayer = (myIndex + 1) % 2;
                }
            } else {
                msg = `${char} non c'è.`;
                nextPlayer = (myIndex + 1) % 2;
            }

            const newRev = [...new Set([...oldRev, ...found])];

            await supabase.from('stanze').update({
                lettere_rivelate: newRev,
                id_giocatore_corrente: nextPlayer,
                ultima_azione: 'chiama_lettera',
                ultimo_messaggio: msg,
                azione_timestamp: new Date().toISOString()
            }).eq('id', roomId);
        }

        async function startNewRound() {
            speak("Estraggo una nuova frase...");
            const { data: frasi } = await supabase.from('frasi').select('id');
            const rid = frasi[Math.floor(Math.random() * frasi.length)].id;

            await supabase.from('stanze').update({
                frase_corrente_id: rid,
                stato: 'gioco',
                lettere_rivelate: [],
                montepremi_round: 0,
                ultima_azione: 'nuovo_round',
                ultimo_messaggio: 'Nuovo Round Iniziato!',
                azione_timestamp: new Date().toISOString()
            }).eq('id', roomId);
        }

        function readTopic() {
            if (currentFrase) speak("Argomento: " + currentFrase.categoria);
        }

        function readBoard() {
            const tiles = document.querySelectorAll('.tile:not(.space)');
            let revealed = 0;
            tiles.forEach(t => {
                if (!t.classList.contains('empty')) revealed++;
            });
            speak(`Tabellone: ${revealed} lettere scoperte su ${tiles.length}. Usa le frecce di NVDA per leggere le caselle in ordine.`);
        }

        document.addEventListener('keydown', (e) => {
            if (inputMode) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeInput();
                }
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitInput();
                }
                return;
            }

            const k = e.key.toLowerCase();
            if (k === 'g') { e.preventDefault(); doSpin(); }
            if (k === 'c') { e.preventDefault(); openInput('letter'); }
            if (k === 'v') { e.preventDefault(); openInput('vowel'); }
            if (k === 's') { e.preventDefault(); openInput('solve'); }
            if (k === 't') { e.preventDefault(); readTopic(); }
            if (k === 'l') { e.preventDefault(); readBoard(); }
            if (k === 'n' && isHost) { e.preventDefault(); startNewRound(); }
        });
    </script>
</body>
</html>
