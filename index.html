<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - V21 (No Ripetizioni)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* STILE TV SHOW */
        body {
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
            color: #ffffff; font-family: 'Verdana', sans-serif; margin: 0; padding: 10px;
            min-height: 100vh;
        }
        *:focus { outline: 4px solid #ffd700 !important; outline-offset: 4px; box-shadow: 0 0 15px #ffd700; }

        h1 { color: #ffd700; text-align: center; text-shadow: 2px 2px 0 #ff0000; font-size: 2em; margin-bottom: 10px; }
        .container { max-width: 1000px; margin: 0 auto; }

        /* SETUP & LOBBY */
        #setup-panel, #lobby-panel {
            background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px;
            border: 2px solid #444; backdrop-filter: blur(5px); text-align: center; margin-top: 20px;
        }
        
        /* PULSANTE LOBBY GIGANTE */
        .btn-giant {
            display: block; width: 100%; max-width: 400px; margin: 20px auto;
            padding: 25px; font-size: 1.5em; font-weight: 900;
            background: linear-gradient(to bottom, #00cc00, #006600);
            color: white; border: 3px solid #00ff00; border-radius: 15px;
            cursor: pointer; box-shadow: 0 0 20px #00ff00; text-transform: uppercase;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* STATUS BAR */
        .status-bar {
            background: linear-gradient(90deg, #002244 0%, #004488 100%);
            padding: 15px; text-align: center; font-size: 1.3em;
            border: 2px solid #0088ff; border-radius: 10px; margin-bottom: 20px;
        }
        .turn-active {
            background: linear-gradient(90deg, #004400 0%, #008800 100%);
            border-color: #00ff00; color: #fff; text-shadow: 0 0 5px #00ff00;
        }

        /* GIOCO VISIBILE */
        #active-game-interface { display: none; }
        
        /* TABELLONE */
        #board-container {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            background: rgba(0, 50, 0, 0.8); padding: 20px; border-radius: 15px; 
            border: 4px solid #ffd700; margin-bottom: 20px; min-height: 120px; justify-content: center;
        }
        .board-row { display: flex; gap: 6px; }
        .tile {
            width: 40px; height: 55px; background: linear-gradient(to bottom, #ffffff 0%, #e0e0e0 100%);
            color: black; font-weight: 900; font-size: 2em; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; box-shadow: 0 4px 0 #999;
        }
        .tile.hidden { color: transparent; background: white; }
        .tile.empty { background: transparent; box-shadow: none; border: 1px dashed rgba(0,255,0,0.2); }

        /* TASTIERINO NAVIGAZIONE MOBILE (D-PAD) */
        #mobile-dpad {
            background: #222; padding: 15px; border-radius: 10px; border: 2px solid #555;
            margin-bottom: 20px; text-align: center;
        }
        .dpad-row { display: flex; justify-content: center; gap: 10px; margin: 5px 0; }
        .dpad-btn {
            width: 60px; height: 60px; font-size: 2em; border-radius: 10px;
            background: #444; color: #fff; border: 2px solid #777; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .dpad-btn:active { background: #ffd700; color: #000; }
        .dpad-center { width: 60px; height: 60px; } 

        /* LAYOUT */
        .game-area { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; align-items: flex-start; }
        .col-visual { flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; }
        .col-controls { flex: 1; min-width: 300px; }

        /* RUOTA */
        #wheel-wrapper { position: relative; width: 280px; height: 280px; margin-bottom: 15px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5)); }
        #wheel-visual {
            width: 100%; height: 100%; border-radius: 50%; border: 8px solid #fff;
            background: conic-gradient(#ff0000 0deg 36deg, #ff8800 36deg 72deg, #ffff00 72deg 108deg, #00aa00 108deg 144deg, #0088ff 144deg 180deg, #8800ff 180deg 216deg, #ff00ff 216deg 252deg, #222222 252deg 288deg, #cccccc 288deg 324deg, #ffd700 324deg 360deg);
            transition: transform 4s cubic-bezier(0.1, 0.8, 0.1, 1);
        }
        #wheel-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 35px solid #ffffff; z-index: 3;
        }
        #wheel-status-text {
            background: #000; color: #ffd700; padding: 10px 20px; border: 2px solid #ffd700; border-radius: 50px;
            font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 20px;
        }

        /* BOTTONI */
        button { width: 100%; padding: 15px; margin-bottom: 10px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #ffcc00; color: #000; border-bottom: 4px solid #b38f00; }
        .btn-secondary { background: #0088ff; color: #fff; border-bottom: 4px solid #0055aa; }
        .btn-accent { background: #ff0066; color: #fff; border-bottom: 4px solid #aa0044; }
        button:disabled { background: #444; color: #888; border-bottom: none; cursor: not-allowed; }

        /* UTILS */
        input { display: block; width: 95%; padding: 15px; margin: 10px auto; font-size: 1.2em; }
        #player-list { list-style: none; padding: 0; margin-top: 20px; }
        #player-list li { background: rgba(255,255,255,0.1); margin-bottom: 5px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; }
        
        #input-area, #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #game-input { font-size: 3em; padding: 10px; width: 80%; text-align: center; }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<div id="inspector-overlay" class="hidden" role="dialog" aria-label="Ispettore Testuale">
    <div style="background:#222; padding:30px; border-radius:10px; border:2px solid #ffd700; max-width:90%; max-height:80%; overflow:auto;">
        <h2 style="color:#ffd700; margin-top:0;">Modalità Lettura (Frecce SU/GIÙ)</h2>
        <div id="inspector-text" tabindex="-1" style="font-size:1.5em; line-height:1.6; color:#fff;"></div>
        <button onclick="closeInspector()" class="btn-secondary" style="margin-top:20px;">CHIUDI (ESC)</button>
    </div>
</div>

<div class="container">
    <h1>LA RUOTA DELLA FORTUNA</h1>

    <div id="setup-panel">
        <label style="font-size:1.2em;">Tuo Nome:</label>
        <input id="inp-name" type="text" placeholder="Nome">
        <label style="font-size:1.2em;">Codice Stanza:</label>
        <input id="inp-code" type="text" placeholder="Es. CASA">
        <button onclick="joinGame(true)" class="btn-primary">CREA NUOVA STANZA</button>
        <button onclick="joinGame(false)" class="btn-secondary">ENTRA IN STANZA</button>
    </div>

    <div id="game-panel" class="hidden">
        
        <div id="lobby-panel" class="hidden">
            <h2 style="color:#00ff00">SALA D'ATTESA</h2>
            <p id="lobby-msg">In attesa dell'Host...</p>
            <button id="btn-start-round" class="btn-giant hidden" onclick="startNewRound()">AVVIA PARTITA</button>
            <div style="margin-top:30px; text-align:left;">
                <h3>Giocatori Pronti:</h3>
                <ul id="lobby-player-list" style="padding:0; list-style:none;"></ul>
            </div>
        </div>

        <div id="active-game-interface">
            <div class="status-bar">
                <div id="turn-indicator">In attesa...</div>
                <div id="my-score" style="font-size:0.9em; margin-top:5px; color:#ffd700;">Tu: €0 | Jolly: 0</div>
            </div>

            <div class="game-area">
                <div class="col-controls">
                    <div id="category-display" style="text-align:center; font-style:italic; margin-bottom:10px; color:#00ff00; font-size:1.2em;">CATEGORIA: —</div>
                    <div id="board-container" aria-hidden="true"></div>
                    
                    <div id="mobile-dpad" role="group" aria-label="Controlli Tabellone">
                        <div style="color:#aaa; font-size:0.9em; margin-bottom:10px;">NAVIGAZIONE TABELLONE</div>
                        <div class="dpad-row">
                            <button class="dpad-btn" onclick="navUp()" aria-label="Parola Precedente">⬆️</button>
                        </div>
                        <div class="dpad-row">
                            <button class="dpad-btn" onclick="navLeft()" aria-label="Lettera Precedente">⬅️</button>
                            <div class="dpad-center"></div>
                            <button class="dpad-btn" onclick="navRight()" aria-label="Lettera Successiva">➡️</button>
                        </div>
                        <div class="dpad-row">
                            <button class="dpad-btn" onclick="navDown()" aria-label="Parola Successiva">⬇️</button>
                        </div>
                    </div>

                    <div style="border-top:1px solid #444; padding-top:10px;">
                        <ul id="player-list"></ul>
                    </div>
                </div>

                <div class="col-visual">
                    <div id="wheel-wrapper" aria-hidden="true">
                        <div id="wheel-pointer"></div>
                        <div id="wheel-visual"><div id="wheel-center" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40px; height:40px; background:white; border-radius:50%;"></div></div>
                    </div>
                    <div id="wheel-status-text">GIRA LA RUOTA</div>

                    <button id="btn-spin" class="btn-primary" onclick="doSpin()">1. GIRA RUOTA (Ctrl+G)</button>
                    <div style="display:flex; gap:10px; width:100%;">
                        <button id="btn-vowel" class="btn-secondary" onclick="openInput('vowel')">2. VOCALE (Ctrl+V)</button>
                        <button id="btn-solve" class="btn-accent" onclick="openInput('solve')">3. RISOLVI (Ctrl+S)</button>
                    </div>
                    <button id="btn-read-letters" class="btn-secondary" onclick="readRevealedLetters()" style="background:#444;">LEGGI LETTERE (Ctrl+L)</button>

                    <div id="host-controls" class="hidden" style="margin-top:20px;">
                        <button onclick="startNewRound()" style="background:#550000; color:white;">HOST: NUOVO ROUND</button>
                        <button onclick="destroyRoom()" style="background:#330000; color:white;">HOST: CHIUDI STANZA</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="input-area" class="hidden">
    <label id="input-label" for="game-input" style="color:#ffd700; font-size:2em; margin-bottom:20px;">INSERISCI:</label>
    <input id="game-input" type="text" autocomplete="off">
    <div style="display:flex; gap:20px; margin-top:20px; width:80%;">
        <button onclick="submitInput()" class="btn-primary">CONFERMA (Invio)</button>
        <button onclick="closeInput()" class="btn-secondary" style="background:#555;">ANNULLA (Esc)</button>
    </div>
</div>

<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>

<script>
    const supabase = window.supabase.createClient(
        'https://azcwkpdjbysnivknnino.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU'
    );
    const WHEEL_VALUES = [100, 200, 300, 400, 500, 1000, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO'];
    const NATO = {'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','À':'A accentata','È':'E accentata','Ì':'I accentata','Ò':'O accentata','Ù':'U accentata'};

    let myId, myRoomId, myIndex, isHost = false;
    let roomState = {};
    let currentSolution = "";
    let currentRevealed = [];
    let inputMode = null;
    let isSpinning = false;
    let isProcessing = false;
    let navWordIdx = 0;
    let navCharIdx = 0;
    let parsedBoard = [];
    let wheelRot = 0;
    let seqTimer = null;

    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = '';
        setTimeout(() => el.textContent = text, 50);
    }
    
    function speakSequence(msgs) {
        if(seqTimer) clearTimeout(seqTimer);
        let index = 0;
        function next() {
            if(index < msgs.length) {
                speak(msgs[index]);
                index++;
                seqTimer = setTimeout(next, 1200); 
            }
        }
        next();
    }

    function cleanStr(str) { return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z]/g, ""); }
    function playHitSound(times) {
        let count = 0;
        function loop() {
            if (count < times) {
                const audio = document.getElementById('snd-hit');
                if(audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
                count++; setTimeout(loop, 250);
            }
        } loop();
    }
    function play(id) { document.getElementById(id).play().catch(()=>{}); }

    document.getElementById('game-input').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') { e.preventDefault(); submitInput(); }
    });

    // --- FUNZIONI NAVIGAZIONE ---
    function navRight() { moveNav(0, 1); }
    function navLeft() { moveNav(0, -1); }
    function navDown() { moveNav(1, 0); }
    function navUp() { moveNav(-1, 0); }

    function moveNav(dWord, dChar) {
        if(parsedBoard.length === 0) return;
        let moved = false;
        if(dChar !== 0) { navCharIdx += dChar; moved=true; }
        if(dWord !== 0) { navWordIdx += dWord; navCharIdx = 0; moved=true; }

        if(moved) {
            if(navWordIdx < 0) navWordIdx = 0;
            if(navWordIdx >= parsedBoard.length) navWordIdx = parsedBoard.length - 1;
            let w = parsedBoard[navWordIdx];
            if(navCharIdx < 0) navCharIdx = 0;
            if(navCharIdx >= w.chars.length) navCharIdx = w.chars.length - 1;
            
            let c = w.chars[navCharIdx];
            let charText = "Nascosta";
            if(c.isRevealed) {
                let chUpper = c.realChar.toUpperCase();
                if("ÀÈÉÌÒÙ".includes(chUpper)) charText = NATO[chUpper]; 
                else charText = `${chUpper}, ${NATO[chUpper]||""}`;
            }
            let pre = (navCharIdx === 0) ? `Parola ${navWordIdx+1}. ` : "";
            speak(`${pre}${charText}, ${navCharIdx+1} di ${w.chars.length}`);
        }
    }

    // --- KEYBOARD LISTENERS ---
    document.addEventListener('keydown', (e) => {
        const inInput = (document.activeElement.tagName === 'INPUT');

        if(e.ctrlKey) {
            const k = e.key.toLowerCase();
            if(k==='i') { e.preventDefault(); openInspector(); return; }
            if(k==='l') { e.preventDefault(); readRevealedLetters(); return; }
            if(k==='h') { e.preventDefault(); if(isHost) startNewRound(); return; }
            if(k==='arrowright' || k==='arrowleft') { e.preventDefault(); readCurrentWord(); return; }

            if(['g','v','s'].includes(k)) {
                e.preventDefault();
                if(inputMode || document.getElementById('active-game-interface').style.display === 'none') return;
                if(roomState.stato !== 'gioco') { speak("Gioco fermo."); return; }
                if(roomState.id_giocatore_corrente !== myIndex) { speak("Non tocca a te."); return; }
                if(k==='g') doSpin(); if(k==='v') openInput('vowel'); if(k==='s') openInput('solve');
                return;
            }
        }

        if(e.key === 'Escape') {
            if(inputMode) closeInput();
            closeInspector();
            document.getElementById('btn-spin').focus();
            return;
        }

        if(!inInput && roomState.stato === 'gioco' && parsedBoard.length > 0) {
            if(e.key === 'ArrowRight') { e.preventDefault(); navRight(); }
            if(e.key === 'ArrowLeft') { e.preventDefault(); navLeft(); }
            if(e.key === 'ArrowDown') { e.preventDefault(); navDown(); }
            if(e.key === 'ArrowUp') { e.preventDefault(); navUp(); }
        }
    });

    function readCurrentWord() {
        if(parsedBoard.length === 0) return;
        let w = parsedBoard[navWordIdx];
        let missing = w.chars.filter(c => !c.isRevealed).length;
        if(missing === 0) { speak(w.wordStr); }
        else {
            let msgs = [`Mancano ${missing} lettere.`];
            w.chars.forEach(c => {
                if(c.isRevealed) {
                    let ch = c.realChar.toUpperCase();
                    let ph = NATO[ch] || ch;
                    if(!"ÀÈÉÌÒÙ".includes(ch)) ph = `${ch}, ${ph}`;
                    msgs.push(ph);
                } else { msgs.push("Lettera nascosta"); }
            });
            speakSequence(msgs);
        }
    }

    // --- LOGICA ---
    async function joinGame(create) {
        const name = document.getElementById('inp-name').value.trim().toUpperCase();
        const code = document.getElementById('inp-code').value.trim().toUpperCase();
        if(!name || !code) return speak("Dati mancanti");

        if(create) {
             const time = new Date(Date.now() - 3600000).toISOString();
             await supabase.from('stanze').delete().lt('created_at', time);
        }

        let rId;
        if(create) {
            const {data, error} = await supabase.from('stanze').insert({codice:code, stato:'attesa'}).select().single();
            if(error) return speak("Errore codice");
            rId = data.id;
        } else {
            const {data} = await supabase.from('stanze').select('*').eq('codice',code).maybeSingle();
            if(!data) return speak("Stanza inesistente");
            rId = data.id;
        }
        myRoomId = rId;

        const {data:exist} = await supabase.from('giocatori').select('*').eq('stanza_id',rId).eq('nome',name).maybeSingle();
        if(exist) {
            myId=exist.id; myIndex=exist.indice; speak("Bentornato " + name);
        } else {
            const {count} = await supabase.from('giocatori').select('*',{count:'exact',head:true}).eq('stanza_id',rId);
            const {data:neu} = await supabase.from('giocatori').insert({stanza_id:rId, nome:name, indice:count||0}).select().single();
            myId=neu.id; myIndex=neu.indice; speak("Benvenuto " + name);
        }

        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('game-panel').classList.remove('hidden');
        startSync();
    }

    function startSync() {
        supabase.channel('room').on('postgres_changes',{event:'*',schema:'public',table:'stanze',filter:'id=eq.'+myRoomId}, 
            p => { if(p.eventType==='DELETE'){alert("Stanza chiusa");location.reload();} else updateRoom(p.new); })
        .subscribe();
        supabase.channel('players').on('postgres_changes',{event:'*',schema:'public',table:'giocatori',filter:'stanza_id=eq.'+myRoomId}, updatePlayers).subscribe();
        supabase.from('stanze').select('*').eq('id',myRoomId).single().then(r=>updateRoom(r.data));
        updatePlayers();
    }

    async function updatePlayers() {
        const {data: pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        if(!pl) return;
        
        const lobbyList = document.getElementById('lobby-player-list');
        lobbyList.innerHTML = '';
        pl.forEach(p => { const li=document.createElement('li'); li.textContent=`${p.nome} ${p.id===myId?"(TU)":""}`; lobbyList.appendChild(li); });

        const gameList = document.getElementById('player-list');
        gameList.innerHTML = '';
        
        if (pl.length > 0) {
            const oldest = pl[0];
            if (oldest.id === myId && !isHost) { 
                isHost = true; 
                document.getElementById('host-controls').classList.remove('hidden'); 
                document.getElementById('btn-start-round').classList.remove('hidden');
                document.getElementById('lobby-msg').textContent = "SEI L'HOST! Premi il pulsante verde.";
            }
            else if (oldest.id !== myId && isHost) { 
                isHost = false; 
                document.getElementById('host-controls').classList.add('hidden');
                document.getElementById('btn-start-round').classList.add('hidden');
                document.getElementById('lobby-msg').textContent = "In attesa dell'Host...";
            }
        }

        pl.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${p.indice+1}. ${p.nome} ${p.id===myId?"(TU)":""}</span> <strong>€${p.punteggio_totale}</strong> (Jolly: ${p.jolly})`;
            if(p.indice === roomState.id_giocatore_corrente && roomState.stato === 'gioco') {
                li.style.background = 'rgba(0,255,0,0.2)'; li.style.border = '1px solid #0f0';
            }
            gameList.appendChild(li);
            if(p.id === myId) document.getElementById('my-score').textContent = `Tu: €${p.punteggio_totale} | Jolly: ${p.jolly}`;
        });
    }

    async function updateRoom(data) {
        if(!data) return;
        roomState = data;
        
        const lobby = document.getElementById('lobby-panel');
        const game = document.getElementById('active-game-interface');

        if (data.stato === 'attesa') {
            lobby.classList.remove('hidden'); game.classList.add('hidden');
            if(isHost) document.getElementById('btn-start-round').focus();
        } else {
            lobby.classList.add('hidden'); game.classList.remove('hidden');
            if(document.activeElement === document.body) document.getElementById('btn-spin').focus();
        }

        const isMyTurn = (data.id_giocatore_corrente === myIndex && data.stato === 'gioco');
        const ti = document.getElementById('turn-indicator');

        if(isMyTurn) { ti.textContent = "È IL TUO TURNO!"; ti.className='status-bar turn-active'; }
        else { ti.textContent = `Turno Giocatore ${data.id_giocatore_corrente+1}`; ti.className='status-bar'; }

        ['btn-spin','btn-vowel','btn-solve'].forEach(id => document.getElementById(id).disabled = !isMyTurn);
        
        document.getElementById('wheel-status-text').textContent = data.montepremi_round > 0 ? `VALORE: €${data.montepremi_round}` : "GIRA LA RUOTA";

        if(data.frase_corrente_id) {
            if(!currentSolution || data.stato === 'attesa') {
                const {data:f} = await supabase.from('frasi').select('*').eq('id',data.frase_corrente_id).single();
                if(f) { currentSolution = f.soluzione.toUpperCase(); document.getElementById('category-display').textContent = "CATEGORIA: " + f.categoria; }
            }
            currentRevealed = data.lettere_rivelate || [];
            parseBoardData();
        }

        if(isMyTurn && data.montepremi_round > 0 && !inputMode && !isSpinning && !isProcessing) openInput('letter');
    }

    function doSpin() {
        if(isSpinning) return;
        isSpinning = true;
        play('snd-spin');
        wheelRot += (720 + Math.random() * 360);
        document.getElementById('wheel-visual').style.transform = `rotate(${wheelRot}deg)`;
        
        setTimeout(async () => {
            isSpinning = false;
            const val = WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
            
            if(val === 'BANCAROTTA') {
                const {data:me} = await supabase.from('giocatori').select('jolly').eq('id',myId).single();
                if(me.jolly > 0) {
                    await supabase.from('giocatori').update({jolly: me.jolly - 1}).eq('id',myId);
                    speak("Bancarotta! Salvato.");
                    await supabase.from('stanze').update({montepremi_round:0}).eq('id',myRoomId);
                } else {
                    speak("Bancarotta!");
                    await supabase.from('giocatori').update({punteggio_totale:0}).eq('id',myId);
                    passTurn();
                }
            } 
            else if (val === 'PASSA') { speak("Passa"); passTurn(); } 
            else if (val === 'MISTERO') { await handleMistero(); } 
            else {
                speak(`Esce ${val}.`);
                await supabase.from('stanze').update({montepremi_round:val}).eq('id',myRoomId);
            }
        }, 3000);
    }

    async function handleMistero() {
        const outs = ['BANKRUPT', 'DOUBLE', 'FREE_CONS', 'FREE_VOWEL', 'JOLLY'];
        const res = outs[Math.floor(Math.random() * outs.length)];
        const {data:me} = await supabase.from('giocatori').select('*').eq('id',myId).single();

        if(res === 'BANKRUPT') {
            if(me.jolly > 0) {
                await supabase.from('giocatori').update({jolly: me.jolly - 1}).eq('id',myId);
                speak("Mistero Bancarotta (Salvato)");
            } else {
                await supabase.from('giocatori').update({punteggio_totale: 0}).eq('id',myId);
                speak("Mistero Bancarotta"); passTurn(); return;
            }
        } else if (res === 'DOUBLE') {
            await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale * 2}).eq('id',myId);
            speak("Mistero Raddoppio");
        } else if (res === 'JOLLY') {
            await supabase.from('giocatori').update({jolly: me.jolly + 1}).eq('id',myId);
            speak("Mistero Jolly");
        } else {
            let norm = cleanStr(currentSolution);
            let cands = [];
            for(let i=0; i<norm.length; i++) {
                if(!currentRevealed.includes(i)) {
                    let ch = currentSolution[i].toUpperCase();
                    let isV = "AEIOUÀÈÌÒÙ".includes(ch);
                    if((res==='FREE_VOWEL' && isV) || (res==='FREE_CONS' && !isV && /[A-Z]/.test(ch))) cands.push(ch);
                }
            }
            if(cands.length > 0) {
                let pick = cands[Math.floor(Math.random()*cands.length)];
                let ind = [];
                for(let i=0; i<currentSolution.length; i++) if(currentSolution[i].toUpperCase()===pick) ind.push(i);
                let nr = [...new Set([...currentRevealed,...ind])];
                await supabase.from('stanze').update({lettere_rivelate:nr}).eq('id',myRoomId);
                speak("Mistero regala "+pick);
            } else speak("Mistero vuoto");
        }
        await supabase.from('stanze').update({montepremi_round:0}).eq('id',myRoomId);
    }

    function openInput(mode) {
        if(mode === 'vowel') {
            const sc = parseInt(document.getElementById('my-score').textContent.split('€')[1])||0;
            if(sc < 500) { speak("Servono 500 euro"); return; }
        }
        inputMode = mode;
        document.getElementById('input-area').classList.remove('hidden');
        const inp = document.getElementById('game-input');
        const lbl = document.getElementById('input-label');
        inp.value = ''; inp.focus();
        if(mode==='letter') lbl.textContent = `CONSONANTE (€${roomState.montepremi_round})`;
        else if(mode==='vowel') lbl.textContent = "VOCALE (€500)";
        else lbl.textContent = "SOLUZIONE";
    }

    function closeInput() {
        document.getElementById('input-area').classList.add('hidden');
        inputMode = null; document.getElementById('btn-spin').focus();
    }

    async function submitInput() {
        if(isProcessing) return;
        const txt = document.getElementById('game-input').value.toUpperCase().trim();
        if(!txt) return;
        isProcessing = true;
        const mode = inputMode;
        closeInput();

        if(mode === 'solve') {
            if(cleanStr(txt) === cleanStr(currentSolution)) {
                playHitSound(3); speak("VITTORIA!");
                await supabase.from('stanze').update({stato:'attesa',montepremi_round:0}).eq('id',myRoomId);
            } else { play('snd-miss'); speak("Errato."); passTurn(); }
            isProcessing = false; return;
        }

        const char = txt.charAt(0);
        if(mode === 'vowel') {
             const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
             await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale - 500}).eq('id',myId);
        }

        let ind = [];
        for(let i=0; i<currentSolution.length; i++) {
            if(cleanStr(currentSolution[i]) === cleanStr(char)) ind.push(i);
        }

        if(ind.length > 0 && currentRevealed.includes(ind[0])) {
            speak("Già chiamata! Errore."); passTurn();
        } else if(ind.length > 0) {
            playHitSound(ind.length); speak("Trovate "+ind.length);
            let nr = [...new Set([...currentRevealed,...ind])];
            if(mode === 'letter') {
                 const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
                 const win = roomState.montepremi_round * ind.length;
                 await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale + win}).eq('id',myId);
                 await supabase.from('stanze').update({lettere_rivelate:nr, montepremi_round: 0}).eq('id',myRoomId);
            } else {
                 await supabase.from('stanze').update({lettere_rivelate:nr}).eq('id',myRoomId);
            }
        } else {
            play('snd-miss'); speak("Non c'è."); passTurn();
        }
        setTimeout(() => { isProcessing = false; }, 1000);
    }

    async function passTurn() {
        const {data:pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        const nxt = (myIndex + 1) % pl.length;
        await supabase.from('stanze').update({id_giocatore_corrente:nxt, montepremi_round:0}).eq('id',myRoomId);
    }

    // NUOVO ROUND SENZA RIPETIZIONI (V21 LOGIC)
    async function startNewRound() {
        const {data:f} = await supabase.from('frasi').select('*');
        if(!f || !f.length) return speak("Nessuna frase");
        
        // Filtro per evitare la frase appena giocata
        let available = f;
        if(roomState.frase_corrente_id) {
            available = f.filter(p => p.id !== roomState.frase_corrente_id);
        }
        if(available.length === 0) available = f; // Fallback

        const pick = available[Math.floor(Math.random()*available.length)];
        await supabase.from('stanze').update({stato:'gioco', frase_corrente_id:pick.id, lettere_rivelate:[], montepremi_round:0}).eq('id',myRoomId);
        speak("Nuovo round!");
    }
    
    async function destroyRoom() {
        if(!isHost) return;
        if(confirm("Chiudere stanza?")) {
            await supabase.from('giocatori').delete().eq('stanza_id', myRoomId);
            await supabase.from('stanze').delete().eq('id', myRoomId);
            location.reload();
        }
    }

    function readRevealedLetters() {
        if(currentRevealed.length === 0) return speak("Nessuna.");
        let u = new Set(); currentRevealed.forEach(i => u.add(currentSolution[i].toUpperCase()));
        let sorted = Array.from(u).sort();
        let msg = "Presenti: ";
        sorted.forEach(c => { 
            let ph = NATO[c] || c; 
            if(!"ÀÈÉÌÒÙ".includes(c)) ph = `${c}, ${ph}`;
            msg += `${ph}. `; 
        });
        speak(msg);
    }

    function openInspector() {
        const txt = document.getElementById('inspector-text');
        let html = `<p style="color:#ffd700">CAT: ${document.getElementById('category-display').textContent.split(': ')[1]}</p>`;
        parsedBoard.forEach((w, i) => {
            html += `<p>Parola ${i+1}: ${w.chars.map(c => c.isRevealed ? c.realChar : "_").join(" ")}</p>`;
        });
        txt.innerHTML = html;
        document.getElementById('inspector-overlay').classList.remove('hidden');
        txt.focus();
    }
    function closeInspector() {
        document.getElementById('inspector-overlay').classList.add('hidden');
        document.getElementById('btn-spin').focus();
    }

    function parseBoardData() {
        parsedBoard = [];
        if (!currentSolution) return;
        const raw = currentSolution.split(' ');
        let g = 0;
        raw.forEach(w => {
            let obj = { wordStr: w, chars: [] };
            for (let i = 0; i < w.length; i++) {
                const ch = w[i];
                obj.chars.push({ realChar: ch, isRevealed: currentRevealed.includes(g) });
                g++;
            }
            parsedBoard.push(obj); g++; 
        });
        
        const cont = document.getElementById('board-container');
        cont.innerHTML = '';
        parsedBoard.forEach(w => {
            const row = document.createElement('div');
            row.className = 'board-row';
            w.chars.forEach(c => {
                const tile = document.createElement('div');
                tile.className = 'tile' + (c.isRevealed ? '' : ' hidden');
                tile.textContent = c.realChar;
                row.appendChild(tile);
            });
            cont.appendChild(row);
        });
    }
</script>
</body>
</html>