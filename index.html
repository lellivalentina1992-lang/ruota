<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La Ruota - V31 (Anti-Fantasma)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* STILE AD ALTO CONTRASTO (SCURO TOTALE) */
        body {
            background: #000000; 
            color: #ffffff; font-family: 'Verdana', sans-serif; margin: 0; padding: 10px;
            min-height: 100vh;
        }
        *:focus { outline: 4px solid #ffd700 !important; outline-offset: 4px; box-shadow: 0 0 15px #ffd700; }

        h1 { font-size: 1px; color: #000; opacity: 0; margin: 0; height: 1px; overflow: hidden; } 

        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }

        /* SETUP & LOBBY */
        #setup-panel, #lobby-panel {
            border: 2px solid #ffd700; padding: 20px; border-radius: 15px;
            text-align: center; margin-top: 20px; background: #111;
        }
        
        /* STATUS BAR */
        .status-bar {
            border: 4px solid #0088ff; background: #001133;
            padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 20px;
        }
        
        /* ARGOMENTO BEN VISIBILE E NAVIGABILE */
        #live-category {
            color: #ffff00; font-size: 2.5em; font-weight: 900; margin: 0;
            text-transform: uppercase; letter-spacing: 2px;
            border-bottom: 2px solid #fff; padding-bottom: 15px; margin-bottom: 15px;
            min-height: 1.2em; 
        }
        
        /* TABELLONE */
        #board-container {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            border: 4px solid #fff; padding: 20px; margin-bottom: 20px; min-height: 150px; justify-content: center;
            background: #053305; 
        }
        .board-row { display: flex; gap: 8px; }
        .tile {
            width: 45px; height: 60px; background: #ffffff;
            color: #000000; font-weight: 900; font-size: 2.2em; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; border: 2px solid #999;
        }
        .tile.hidden { background: #ffffff; color: transparent; } 
        
        /* BOTTONI */
        button { width: 100%; padding: 20px; margin-bottom: 15px; font-size: 1.3em; border: 2px solid #fff; border-radius: 8px; cursor: pointer; font-weight: bold; color: #000; }
        .btn-primary { background: #ffcc00; }
        .btn-secondary { background: #00ccff; }
        .btn-accent { background: #ff6666; }
        button:disabled { background: #333; color: #777; border-color: #555; }

        /* UTILS */
        input { display: block; width: 95%; padding: 15px; margin: 10px auto; font-size: 1.5em; background: #333; color: #fff; border: 2px solid #fff; }
        #player-list { list-style: none; padding: 0; margin-top: 20px; font-size: 1.2em; }
        #player-list li { border-bottom: 1px solid #444; padding: 10px; }
        
        #wheel-status-text { font-size: 1.5em; color: #ffd700; text-align: center; margin: 15px 0; font-weight: bold; }

        /* RUOTA VISIVA */
        #wheel-wrapper { position: relative; width: 200px; height: 200px; margin: 0 auto 20px auto; }
        #wheel-visual {
            width: 100%; height: 100%; border-radius: 50%; border: 5px solid #fff;
            background: conic-gradient(#ff0000 0deg 36deg, #ff8800 36deg 72deg, #ffff00 72deg 108deg, #00aa00 108deg 144deg, #0088ff 144deg 180deg, #8800ff 180deg 216deg, #ff00ff 216deg 252deg, #222222 252deg 288deg, #cccccc 288deg 324deg, #ffd700 324deg 360deg);
            transition: transform 3s cubic-bezier(0.1, 0.8, 0.1, 1);
        }
        #wheel-pointer {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 20px solid #ffffff; z-index: 3;
        }

        /* OVERLAYS */
        #input-area {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
    </style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<h1>Ruota della Fortuna</h1>

<div class="container">
    
    <div id="setup-panel">
        <label style="font-size:1.5em; display:block; margin-bottom:10px;">Tuo Nome:</label>
        <input id="inp-name" type="text" placeholder="Scrivi nome...">
        <label style="font-size:1.5em; display:block; margin-bottom:10px;">Codice Stanza:</label>
        <input id="inp-code" type="text" placeholder="Scrivi codice...">
        <button onclick="joinGame(true)" class="btn-primary">CREA NUOVA STANZA</button>
        <button onclick="joinGame(false)" class="btn-secondary">ENTRA IN STANZA</button>
    </div>

    <div id="game-panel" class="hidden">
        
        <div id="lobby-panel" class="hidden">
            <h2 style="color:#00ff00; font-size:2em;">SALA D'ATTESA</h2>
            <p id="lobby-msg" style="font-size:1.5em;">In attesa dell'Host...</p>
            <button id="btn-start-round" class="btn-primary hidden" onclick="startNewRound()">AVVIA PARTITA</button>
            <ul id="lobby-player-list"></ul>
        </div>

        <div id="active-game-interface">
            <div class="status-bar" role="region" aria-label="Stato">
                <h2 id="live-category" tabindex="0">CARICAMENTO...</h2>
                
                <div id="turn-indicator" style="font-size:1.5em; color:#fff;">In attesa...</div>
                <div id="my-score" style="font-size:1.2em; color:#ffd700; margin-top:10px;">Tu: €0 | Jolly: 0</div>
            </div>

            <div class="game-area">
                <div id="board-container" role="application" aria-label="Tabellone."></div>
                
                <div class="col-visual">
                    <div id="wheel-wrapper" aria-hidden="true">
                        <div id="wheel-pointer"></div>
                        <div id="wheel-visual"></div>
                    </div>
                    
                    <div id="wheel-status-text">GIRA LA RUOTA</div>

                    <button id="btn-spin" class="btn-primary" onclick="doSpin()">1. GIRA RUOTA (Ctrl+G)</button>
                    <div style="display:flex; gap:10px;">
                        <button id="btn-vowel" class="btn-secondary" onclick="openInput('vowel')">2. VOCALE (Ctrl+V)</button>
                        <button id="btn-solve" class="btn-accent" onclick="openInput('solve')">3. RISOLVI (Ctrl+S)</button>
                    </div>
                    <button id="btn-read-letters" class="btn-secondary" onclick="readRevealedLetters()" style="background:#333; color:#fff;">RILEGGI LETTERE (Ctrl+L)</button>
                    
                    <button onclick="forceReset()" style="background:#660000; border-color:#ff0000; color:#fff; margin-top:20px; font-weight:900;">SBLOCCA: PRENDI TURNO</button>

                    <div style="text-align:center; margin-top:20px; color:#aaa;">
                        Premi <strong>'T'</strong> per rileggere l'Argomento.<br>
                        Premi <strong>Frecce</strong> per esplorare le lettere.
                    </div>

                    <ul id="player-list"></ul>

                    <div id="host-controls" class="hidden" style="margin-top:30px; border-top:2px solid #fff; padding-top:20px;">
                        <button onclick="startNewRound()" style="background:#550000; color:white;">NUOVO ROUND (H)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="input-area" class="hidden">
    <div id="input-category-display" style="color:#ffd700; font-size:2em; margin-bottom:30px; font-weight:bold; text-align:center;">ARGOMENTO</div>
    <label id="input-label" for="game-input" style="color:#fff; font-size:1.5em; margin-bottom:10px;">INSERISCI:</label>
    <input id="game-input" type="text" autocomplete="off">
    <div style="display:flex; gap:20px; margin-top:30px; width:90%;">
        <button onclick="submitInput()" class="btn-primary">CONFERMA (Invio)</button>
        <button onclick="closeInput()" class="btn-secondary">ANNULLA (Esc)</button>
    </div>
</div>

<audio id="snd-spin" src="ruota.wav"></audio>
<audio id="snd-hit" src="lettera presente.wav"></audio>
<audio id="snd-miss" src="lettera assente.wav"></audio>

<script>
    const supabase = window.supabase.createClient(
        'https://azcwkpdjbysnivknnino.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6Y3drcGRqYnlzbml2a25uaW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzAwNDksImV4cCI6MjA3OTIwNjA0OX0.R8wkMJEmsP8cTVUUOcWtD4Rrg_ZhuOE-PYBJ56eGqMU'
    );
    const WHEEL_VALUES = [100, 200, 300, 400, 500, 1000, 2000, 'BANCAROTTA', 'PASSA', 'MISTERO'];
    const NATO = {'A':'Ancona','B':'Bologna','C':'Como','D':'Domodossola','E':'Empoli','F':'Firenze','G':'Genova','H':'Hotel','I':'Imola','J':'Jolly','K':'Kappa','L':'Livorno','M':'Milano','N':'Napoli','O':'Otranto','P':'Palermo','Q':'Quadro','R':'Roma','S':'Savona','T':'Torino','U':'Udine','V':'Venezia','W':'Washington','X':'Xilofono','Y':'Yogurt','Z':'Zara','À':'A accentata','È':'E accentata','Ì':'I accentata','Ò':'O accentata','Ù':'U accentata'};

    let myId, myRoomId, myIndex, isHost = false;
    let roomState = {};
    let currentSolution = "";
    let currentCategory = "ATTESA";
    let currentRevealed = [];
    let inputMode = null;
    let isSpinning = false;
    let isProcessing = false;
    let navWordIdx = 0;
    let navCharIdx = 0;
    let parsedBoard = [];
    let wheelRot = 0;

    function speak(text) {
        const el = document.getElementById('sr-announcer');
        el.textContent = '';
        setTimeout(() => el.textContent = text, 50);
    }

    function cleanStr(str) { return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z]/g, ""); }
    function play(id) { document.getElementById(id).play().catch(()=>{}); }

    // --- TASTIERA ---
    document.getElementById('game-input').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') { e.preventDefault(); submitInput(); }
    });

    document.addEventListener('keydown', (e) => {
        if (!e.key) return;
        const inInput = (document.activeElement.tagName === 'INPUT');

        // T: LEGGI ARGOMENTO
        if(e.key.toLowerCase() === 't' && !inInput) {
            e.preventDefault();
            speak("Argomento: " + currentCategory);
            return;
        }

        if(e.ctrlKey) {
            const k = e.key.toLowerCase();
            if(k==='l') { e.preventDefault(); readRevealedLetters(); return; }
            if(k==='h') { e.preventDefault(); if(isHost) startNewRound(); return; }
            
            if(['g','v','s'].includes(k)) {
                e.preventDefault();
                if(inputMode || document.getElementById('active-game-interface').style.display === 'none') return;
                if(roomState.stato !== 'gioco') { speak("Gioco fermo."); return; }
                if(roomState.id_giocatore_corrente !== myIndex) { speak("Non tocca a te."); return; }
                if(k==='g') doSpin(); if(k==='v') openInput('vowel'); if(k==='s') openInput('solve');
                return;
            }
        }

        if(e.key === 'Escape') {
            if(inputMode) closeInput();
            document.getElementById('btn-spin').focus();
            return;
        }

        // FRECCE
        if(!inInput && roomState.stato === 'gioco' && parsedBoard.length > 0) {
            if(['ArrowRight','ArrowLeft','ArrowDown','ArrowUp'].includes(e.key)) {
                e.preventDefault();
                let dWord=0, dChar=0;
                if(e.key === 'ArrowRight') dChar = 1;
                if(e.key === 'ArrowLeft') dChar = -1;
                if(e.key === 'ArrowDown') dWord = 1;
                if(e.key === 'ArrowUp') dWord = -1;
                moveNav(dWord, dChar);
            }
        }
    });

    function moveNav(dWord, dChar) {
        if(parsedBoard.length === 0) return;
        let moved = false;
        if(dChar !== 0) { navCharIdx += dChar; moved=true; }
        if(dWord !== 0) { navWordIdx += dWord; navCharIdx = 0; moved=true; }

        if(moved) {
            if(navWordIdx < 0) navWordIdx = 0;
            if(navWordIdx >= parsedBoard.length) navWordIdx = parsedBoard.length - 1;
            let w = parsedBoard[navWordIdx];
            if(navCharIdx < 0) navCharIdx = 0;
            if(navCharIdx >= w.chars.length) navCharIdx = w.chars.length - 1;
            
            let c = w.chars[navCharIdx];
            let charText = "Nascosta";
            if(c.isRevealed) {
                let chUpper = c.realChar.toUpperCase();
                if("ÀÈÉÌÒÙ".includes(chUpper)) charText = NATO[chUpper]; 
                else charText = `${chUpper}, ${NATO[chUpper]||""}`;
            }
            let pre = (navCharIdx === 0) ? `Parola ${navWordIdx+1}. ` : "";
            speak(`${pre}${charText}, ${navCharIdx+1} di ${w.chars.length}`);
        }
    }

    // --- GESTIONE INGRESSO ---
    async function joinGame(create) {
        const name = document.getElementById('inp-name').value.trim().toUpperCase();
        const code = document.getElementById('inp-code').value.trim().toUpperCase();
        if(!name || !code) return speak("Dati mancanti");

        if(create) {
             const time = new Date(Date.now() - 3600000).toISOString();
             await supabase.from('stanze').delete().lt('created_at', time);
             
             const {data:exist} = await supabase.from('stanze').select('id').eq('codice',code).maybeSingle();
             if(exist) return speak("Codice occupato. Cambialo.");

             const {data, error} = await supabase.from('stanze').insert({codice:code, stato:'attesa', id_giocatore_corrente:0}).select().single();
             if(error) return speak("Errore creazione.");
             myRoomId = data.id;
        } else {
            const {data} = await supabase.from('stanze').select('*').eq('codice',code).maybeSingle();
            if(!data) return speak("Stanza inesistente");
            myRoomId = data.id;
        }

        // V31: ANTI-FANTASMA - Cancella vecchi giocatori con lo stesso nome nella stanza
        await supabase.from('giocatori').delete().eq('stanza_id', myRoomId).eq('nome', name);

        // Ora entra pulito
        const {count} = await supabase.from('giocatori').select('*',{count:'exact',head:true}).eq('stanza_id',myRoomId);
        const safeIndex = count || 0;
        const {data:neu} = await supabase.from('giocatori').insert({stanza_id:myRoomId, nome:name, indice:safeIndex}).select().single();
        
        myId=neu.id; myIndex=neu.indice; 
        speak("Benvenuto " + name);
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('game-panel').classList.remove('hidden');
        startSync();
    }

    function startSync() {
        supabase.channel('room').on('postgres_changes',{event:'*',schema:'public',table:'stanze',filter:'id=eq.'+myRoomId}, 
            p => { if(p.eventType==='DELETE'){alert("Stanza chiusa");location.reload();} else updateRoom(p.new); })
        .subscribe();
        supabase.channel('players').on('postgres_changes',{event:'*',schema:'public',table:'giocatori',filter:'stanza_id=eq.'+myRoomId}, updatePlayers).subscribe();
        
        supabase.from('stanze').select('*').eq('id',myRoomId).single().then(r => updateRoom(r.data));
        updatePlayers();
    }

    async function updatePlayers() {
        const {data: pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        if(!pl) return;
        
        const lobbyList = document.getElementById('lobby-player-list');
        lobbyList.innerHTML = '';
        pl.forEach(p => { const li=document.createElement('li'); li.textContent=`${p.nome}`; lobbyList.appendChild(li); });

        const gameList = document.getElementById('player-list');
        gameList.innerHTML = '';
        
        // V31: Logica Host più robusta. Se sono il primo (o l'unico), sono Host.
        if (pl.length > 0) {
            if (pl[0].id === myId) { 
                isHost = true; 
                document.getElementById('host-controls').classList.remove('hidden'); 
                document.getElementById('btn-start-round').classList.remove('hidden');
                document.getElementById('lobby-msg').textContent = "SEI L'HOST! Premi AVVIA PARTITA.";
            } else {
                isHost = false;
                document.getElementById('host-controls').classList.add('hidden');
                document.getElementById('btn-start-round').classList.add('hidden');
            }
        }

        pl.forEach((p, i) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${i+1}. ${p.nome} ${p.id===myId?"(TU)":""}</span> <strong>€${p.punteggio_totale}</strong>`;
            if(p.indice === roomState.id_giocatore_corrente && roomState.stato === 'gioco') {
                li.style.background = '#004400'; li.style.border = '2px solid #0f0';
            }
            gameList.appendChild(li);
            if(p.id === myId) document.getElementById('my-score').textContent = `Tu: €${p.punteggio_totale} | Jolly: ${p.jolly}`;
        });
    }

    async function updateRoom(data) {
        if(!data) return;
        roomState = data;
        
        const lobby = document.getElementById('lobby-panel');
        const game = document.getElementById('active-game-interface');

        if (data.stato === 'attesa') {
            lobby.classList.remove('hidden'); game.classList.add('hidden');
        } else {
            lobby.classList.add('hidden'); game.classList.remove('hidden');
        }

        const isMyTurn = (data.id_giocatore_corrente === myIndex && data.stato === 'gioco');
        const ti = document.getElementById('turn-indicator');

        if(isMyTurn) { ti.textContent = "È IL TUO TURNO!"; ti.className='status-bar'; ti.style.background='#006600'; }
        else { ti.textContent = `Turno Giocatore ${data.id_giocatore_corrente+1}`; ti.style.background='transparent'; }

        ['btn-spin','btn-vowel','btn-solve'].forEach(id => document.getElementById(id).disabled = !isMyTurn);
        document.getElementById('wheel-status-text').textContent = data.montepremi_round > 0 ? `VALORE: €${data.montepremi_round}` : "GIRA LA RUOTA";

        if(data.frase_corrente_id) {
            if(data.frase_corrente_id !== currentSolution.id) {
                 const {data:f} = await supabase.from('frasi').select('*').eq('id',data.frase_corrente_id).single();
                 if(f) { 
                    currentSolution = f.soluzione.toUpperCase(); 
                    currentCategory = f.categoria.toUpperCase();
                    
                    document.getElementById('live-category').textContent = ""; 
                    setTimeout(() => {
                        document.getElementById('live-category').textContent = "ARGOMENTO: " + currentCategory;
                        document.getElementById('input-category-display').textContent = "ARGOMENTO: " + currentCategory;
                    }, 50);
                    
                    document.getElementById('board-container').setAttribute('aria-label', `Tabellone per ${currentCategory}.`);
                 }
            }
            currentRevealed = data.lettere_rivelate || [];
            parseBoardData();
        }

        if(isMyTurn && data.montepremi_round > 0 && !inputMode && !isSpinning) openInput('letter');
    }

    function doSpin() {
        if(isSpinning) return;
        
        const visual = document.getElementById('wheel-visual');
        if(!visual) {
            console.error("Elemento ruota non trovato!");
            finishSpinLogic();
            return;
        }

        isSpinning = true;
        play('snd-spin');
        wheelRot += (720 + Math.random() * 360);
        visual.style.transform = `rotate(${wheelRot}deg)`;
        
        const safetyTimer = setTimeout(() => { if(isSpinning) isSpinning = false; }, 4000);

        setTimeout(async () => {
            clearTimeout(safetyTimer); 
            await finishSpinLogic();
        }, 3000);
    }

    async function finishSpinLogic() {
        isSpinning = false;
        const val = WHEEL_VALUES[Math.floor(Math.random()*WHEEL_VALUES.length)];
        
        if(val === 'BANCAROTTA') {
            const {data:me} = await supabase.from('giocatori').select('jolly').eq('id',myId).single();
            if(me.jolly > 0) {
                await supabase.from('giocatori').update({jolly: me.jolly - 1}).eq('id',myId);
                speak("Bancarotta! Salvato dal Jolly.");
                await supabase.from('stanze').update({montepremi_round:0}).eq('id',myRoomId);
            } else {
                speak("Bancarotta!");
                await supabase.from('giocatori').update({punteggio_totale:0}).eq('id',myId);
                passTurn();
            }
        } 
        else if (val === 'PASSA') { speak("Passa"); passTurn(); } 
        else if (val === 'MISTERO') { await handleMistero(); } 
        else {
            speak(`Esce ${val}.`);
            await supabase.from('stanze').update({montepremi_round:val}).eq('id',myRoomId);
        }
    }

    // V31: RESET CHE FORZA IL TURNO A ME
    async function forceReset() {
        isSpinning = false;
        inputMode = null;
        closeInput();
        speak("Forzo il turno a te...");
        // Questo è il trucco: dico al database che tocca al mio indice
        await supabase.from('stanze').update({id_giocatore_corrente: myIndex}).eq('id', myRoomId);
    }

    async function handleMistero() {
        speak("Mistero...");
        const res = Math.random() > 0.5 ? 'JOLLY' : 'BANKRUPT'; 
        if(res==='JOLLY') {
             const {data:me} = await supabase.from('giocatori').select('jolly').eq('id',myId).single();
             await supabase.from('giocatori').update({jolly: me.jolly + 1}).eq('id',myId);
             speak("Hai vinto un Jolly!");
        } else {
             speak("Bancarotta!");
             await supabase.from('giocatori').update({punteggio_totale:0}).eq('id',myId);
             passTurn(); return;
        }
        await supabase.from('stanze').update({montepremi_round:0}).eq('id',myRoomId);
    }

    function openInput(mode) {
        if(mode === 'vowel') {
            const sc = parseInt(document.getElementById('my-score').textContent.split('€')[1])||0;
            if(sc < 500) { speak("Servono 500 euro"); return; }
        }
        inputMode = mode;
        document.getElementById('input-area').classList.remove('hidden');
        
        const lbl = document.getElementById('input-label');
        const hint = document.getElementById('input-category-display');
        hint.textContent = "ARGOMENTO: " + currentCategory;

        const inp = document.getElementById('game-input');
        inp.value = ''; inp.focus();
        
        let type = "";
        if(mode==='letter') { lbl.textContent = `CONSONANTE (€${roomState.montepremi_round})`; type="Inserisci Consonante"; }
        else if(mode==='vowel') { lbl.textContent = "VOCALE (€500)"; type="Compra Vocale"; }
        else { lbl.textContent = "SOLUZIONE"; type="Scrivi Soluzione"; }
        
        speak(`${currentCategory}. ${type}`);
    }

    function closeInput() {
        document.getElementById('input-area').classList.add('hidden');
        inputMode = null; document.getElementById('btn-spin').focus();
    }

    async function submitInput() {
        if(isProcessing) return;
        const txt = document.getElementById('game-input').value.toUpperCase().trim();
        if(!txt) return;
        isProcessing = true;
        const mode = inputMode;
        closeInput();

        if(mode === 'solve') {
            if(cleanStr(txt) === cleanStr(currentSolution)) {
                play('snd-hit'); speak("ESATTO! VITTORIA!");
                await supabase.from('stanze').update({stato:'attesa',montepremi_round:0}).eq('id',myRoomId);
            } else { play('snd-miss'); speak("Sbagliato."); passTurn(); }
            isProcessing = false; return;
        }

        const char = txt.charAt(0);
        if(mode === 'vowel') {
             const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
             await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale - 500}).eq('id',myId);
        }

        let ind = [];
        for(let i=0; i<currentSolution.length; i++) if(cleanStr(currentSolution[i]) === cleanStr(char)) ind.push(i);

        if(ind.length > 0 && currentRevealed.includes(ind[0])) {
            speak("Già detta!"); passTurn();
        } else if(ind.length > 0) {
            play('snd-hit'); speak("Ce ne sono "+ind.length);
            let nr = [...new Set([...currentRevealed,...ind])];
            if(mode === 'letter') {
                 const {data:me} = await supabase.from('giocatori').select('punteggio_totale').eq('id',myId).single();
                 const win = roomState.montepremi_round * ind.length;
                 await supabase.from('giocatori').update({punteggio_totale: me.punteggio_totale + win}).eq('id',myId);
                 await supabase.from('stanze').update({lettere_rivelate:nr, montepremi_round: 0}).eq('id',myRoomId);
            } else {
                 await supabase.from('stanze').update({lettere_rivelate:nr}).eq('id',myRoomId);
            }
        } else {
            play('snd-miss'); speak("Non c'è."); passTurn();
        }
        setTimeout(() => { isProcessing = false; }, 1000);
    }

    async function passTurn() {
        const {data:pl} = await supabase.from('giocatori').select('*').eq('stanza_id',myRoomId).order('indice');
        const nxt = (myIndex + 1) % pl.length;
        await supabase.from('stanze').update({id_giocatore_corrente:nxt, montepremi_round:0}).eq('id',myRoomId);
    }

    async function startNewRound() {
        const {data:f} = await supabase.from('frasi').select('*');
        if(!f || !f.length) return speak("Errore database frasi");
        
        const pick = f[Math.floor(Math.random()*f.length)];
        currentCategory = pick.categoria.toUpperCase();
        
        speak("Nuovo round! Argomento: " + currentCategory);
        
        isSpinning = false;
        inputMode = null;

        await supabase.from('stanze').update({
            stato:'gioco', 
            frase_corrente_id:pick.id, 
            lettere_rivelate:[], 
            montepremi_round:0,
            id_giocatore_corrente:0 
        }).eq('id',myRoomId);
    }

    function readRevealedLetters() {
        if(currentRevealed.length === 0) return speak("Nessuna.");
        let u = new Set(); currentRevealed.forEach(i => u.add(currentSolution[i].toUpperCase()));
        let sorted = Array.from(u).sort();
        let msg = "LETTERE USCITE: ";
        sorted.forEach(c => { msg += `${c}, ${NATO[c]||c}. `; });
        speak(msg);
    }

    function parseBoardData() {
        parsedBoard = [];
        if (!currentSolution) return;
        const raw = currentSolution.split(' ');
        let g = 0;
        raw.forEach(w => {
            let obj = { wordStr: w, chars: [] };
            for (let i = 0; i < w.length; i++) {
                const ch = w[i];
                obj.chars.push({ realChar: ch, isRevealed: currentRevealed.includes(g) });
                g++;
            }
            parsedBoard.push(obj); g++; 
        });
        
        const cont = document.getElementById('board-container');
        cont.innerHTML = '';
        parsedBoard.forEach(w => {
            const row = document.createElement('div');
            row.className = 'board-row';
            w.chars.forEach(c => {
                const tile = document.createElement('div');
                tile.className = 'tile' + (c.isRevealed ? '' : ' hidden');
                tile.textContent = c.realChar;
                row.appendChild(tile);
            });
            cont.appendChild(row);
        });
    }
</script>
</body>
</html>