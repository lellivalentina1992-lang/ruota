<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Ruota - Multiplayer</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background-color: #000000; 
            color: #ffffff; 
            font-family: 'Verdana', sans-serif; 
            margin: 0; padding: 10px;
            text-align: center;
            overflow-x: hidden;
        }
        
        *:focus { outline: 4px solid #ffd700 !important; box-shadow: 0 0 15px #ffd700; }
        .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); }
        .hidden { display: none !important; }

        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; }
        
        #setup-panel, #game-panel, #end-panel { 
            border: 2px solid #ffd700; padding: 20px; margin-top: 20px; 
            background: #1e1e1e; border-radius: 15px;
        }
        
        #board-container {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            background: #053305; border: 5px solid #fff; padding: 25px; margin: 20px 0;
            border-radius: 10px; min-height: 150px;
        }
        .board-row { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
        
        .tile {
            width: 45px; height: 65px; background: #fff; color: #000;
            font-weight: 900; font-size: 2.2em; display: flex; align-items: center; justify-content: center;
            border: 2px solid #333;
        }
        .tile.empty { background: #006600; color: transparent; border: 1px solid #fff; opacity: 0.8; }
        
        .tile.cursor-char { border: 4px solid #00ffff; transform: scale(1.2); z-index: 10; }
        .board-row.cursor-word { border: 3px solid #ffd700; padding: 4px; border-radius: 5px; }

        #wheel-visual {
            width: 220px; height: 220px; margin: 20px auto;
            border-radius: 50%; border: 8px solid #fff;
            background: conic-gradient(#ff0000, #ffa500, #ffff00, #008000, #0000ff, #4b0082, #ee82ee);
            transition: transform 3.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #wheel-pointer { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #fff; margin: 0 auto -20px auto; position: relative; z-index: 10; }

        button { padding: 12px 20px; font-size: 1.1em; cursor: pointer; font-weight: bold; margin: 5px; border-radius: 8px; border: 2px solid #fff; text-transform: uppercase; }
        .btn-primary { background: #ffcc00; color: #000; }
        .btn-secondary { background: #00ccff; color: #000; }
        .btn-danger { background: #ff0000; color: #fff; }
        
        .disabled-btn { background: #444 !important; color: #888 !important; border-color: #666 !important; cursor: not-allowed; }

        .btn-blink { animation: blinker 1.5s linear infinite; background: #00ff00; color: #000; border-color: #fff; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        
        #input-area, #inspector-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #inspector-content { background: #222; border: 2px solid #ffd700; padding: 20px; width: 85%; max-height: 80%; overflow-y: auto; text-align: left; color: #fff; font-size: 1.4em; line-height: 1.6; }
        input { font-size: 1.8em; padding: 10px; text-align: center; width: 80%; max-width: 400px; background: #333; color: white; border: 2px solid #ffd700; }
        
        #ranking-list li { font-size: 1.5em; margin: 15px 0; list-style: none; border-bottom: 1px solid #555; padding: 10px; }
        
        .score-box { border: 1px solid #555; padding: 5px; border-radius: 5px; margin-bottom: 5px; display:inline-block; width: 45%; }
    </style>
</head>
<body>

    <div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

    <audio id="snd-spin" src="ruota.wav"></audio>
    <audio id="snd-hit" src="lettera presente.wav"></audio>
    <audio id="snd-miss" src="lettera assente.wav"></audio>
    <audio id="snd-win" src="vittoria.wav"></audio> 
    
    <h1 style="color:#ffd700;">LA RUOTA</h1>

    <div id="setup-panel" class="container">
        <h2>BENVENUTO</h2>
        <input id="inp-name" type="text" placeholder="IL TUO NOME"><br><br>
        <input id="inp-code" type="text" value="STANZA1"><br><br>
        <button onclick="joinGame(true)" class="btn-primary">CREA STANZA (RESET)</button>
        <button onclick="joinGame(false)" class="btn-secondary">ENTRA</button>
    </div>

    <div id="game-panel" class="container hidden">
        
        <div style="background:#000; padding:10px; border-radius:5px; border-bottom: 1px solid #333;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align: left;">
                    <span id="round-indicator" style="color:#ffcc00; font-weight:bold; font-size:1.2em;">ROUND 1 / 10</span><br>
                    <span id="turn-indicator" style="font-size:1.2em;">...</span>
                </div>
                <div style="text-align: right; width: 60%;">
                    <div class="score-box" style="border-color: #00ff00;">
                        <small style="color:#aaa;">NEL ROUND</small><br>
                        <span id="score-round" style="color:#00ff00; font-weight:bold; font-size:1.1em;">€0</span>
                    </div>
                    <div class="score-box" style="border-color: #ffd700;">
                        <small style="color:#aaa;">TOTALE</small><br>
                        <span id="score-total" style="color:#ffd700; font-weight:bold; font-size:1.1em;">€0</span>
                    </div>
                </div>
            </div>
        </div>

        <h2 id="live-category" style="color:#00ffff; font-size: 1.8em; margin: 15px 0 5px 0;">...</h2>
        <h3 id="round-hint" style="color:#ffd700; font-size: 1.4em; margin: 0 0 15px 0; min-height: 1.5em;"></h3>

        <div id="board-container" aria-hidden="true" tabindex="-1"></div>
        
        <div id="wheel-pointer"></div>
        <div id="wheel-visual"></div>
        <div id="wheel-status-text" style="font-size: 1.5em; font-weight: bold; color: lime; margin: 10px;">PREMI G</div>

        <div id="controls">
            <button id="btn-spin" class="btn-primary" onclick="doSpin()">1. GIRA (G)</button>
            <button id="btn-vowel" class="btn-secondary" onclick="openInput('vowel')">2. VOCALE (V)</button>
            <button id="btn-solve" class="btn-danger" onclick="openInput('solve')">3. RISOLVI (S)</button>
            
            <br>
            <button id="btn-manual-cons" class="btn-blink hidden" onclick="openInput('letter')" style="margin-top:15px; width: 80%;">
                INSERISCI CONSONANTE (INVIO)
            </button>
            <br>

            <div style="color:#aaa; margin-top:10px;">
                <strong>Frecce:</strong> Lettera | <strong>Ctrl+Frecce:</strong> Parola<br>
                <strong>Ctrl+I:</strong> Ispettore | <strong>Ctrl+L:</strong> Lettere presenti
            </div>
        </div>
    </div>

    <div id="end-panel" class="container hidden">
        <h2 style="color:#ffd700; font-size:2.5em;">PARTITA TERMINATA</h2>
        <p>Ecco la classifica finale:</p>
        <ul id="ranking-list" style="padding:0;"></ul>
        <button onclick="location.reload()" class="btn-primary" style="margin-top:30px;">TORNA AL MENU</button>
    </div>

    <div id="input-area" class="hidden">
        <h2 id="input-title" style="color:#ffd700">...</h2>
        <input id="game-input" type="text" autocomplete="off" placeholder="Scrivi qui...">
        <div style="margin-top: 20px;">
            <button onclick="submitInput()" class="btn-primary">CONFERMA</button>
            <button onclick="closeInput()" class="btn-secondary">ANNULLA</button>
        </div>
    </div>

    <div id="inspector-overlay" class="hidden">
        <div id="inspector-content" tabindex="0"></div>
        <button onclick="closeInspector()" class="btn-secondary" style="margin-top:20px;">CHIUDI (ESC)</button>
    </div>

    <script>
        // FRASI LOCALI (FALLBACK se Supabase non ha frasi)
        const FRASI_LOCALI = [
            { categoria: "PERSONAGGIO FAMOSO", soluzione: "LEONARDO DA VINCI" },
            { categoria: "CITTÀ ITALIANA", soluzione: "ROMA" },
            { categoria: "FILM CELEBRE", soluzione: "IL PADRINO" }
        ];

        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = "https://edujomecvlqekzcvnxlr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdWpvbWVjdmxxZWt6Y3ZueGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0NDAyNTUsImV4cCI6MjA0ODAxNjI1NX0.eBkxUHu6eqOGSn5Rcu9Q5aOL0l2k6cqVy4MdFYkRUYk";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const NATO = { A:"Alfa",B:"Bravo",C:"Charlie",D:"Delta",E:"Echo",F:"Foxtrot",G:"Golf",H:"Hotel",I:"India",J:"Juliet",K:"Kilo",L:"Lima",M:"Mike",N:"November",O:"Oscar",P:"Papa",Q:"Quebec",R:"Romeo",S:"Sierra",T:"Tango",U:"Uniform",V:"Victor",W:"Whiskey",X:"Xray",Y:"Yankee",Z:"Zulu" };
        
        let roomId=null, myId=null, allPlayers=[], currentStanza={}, currentFrase={}, currentPuzzleText="";
        let parsedBoard=[], curChar=0, curWord=0;
        let inputMode=false, inputModeType="", turnPolling=null;

        function cleanStr(s) { 
            return s.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,""); 
        }

        function speak(txt) { 
            console.log("[SPEAK]", txt);
            document.getElementById('sr-announcer').textContent=txt; 
            if(window.speechSynthesis){ 
                speechSynthesis.cancel(); 
                let u=new SpeechSynthesisUtterance(txt); 
                u.lang='it-IT'; 
                speechSynthesis.speak(u);
            }
        }

        function playSound(id) {
            const el = document.getElementById(id);
            if(!el) return;
            el.pause(); el.currentTime=0; el.play().catch(()=>{});
        }

        async function getRandomFrase() {
            // Prova prima da Supabase
            try {
                const {data, error} = await supabase.from('frasi').select('*');
                if(!error && data && data.length > 0) {
                    const random = data[Math.floor(Math.random() * data.length)];
                    console.log("Frase da Supabase:", random);
                    return random;
                }
            } catch(e) {
                console.log("Supabase non disponibile, uso frasi locali");
            }
            // Fallback a frasi locali
            const random = FRASI_LOCALI[Math.floor(Math.random() * FRASI_LOCALI.length)];
            console.log("Frase locale:", random);
            return random;
        }

        async function joinGame(asCreator) {
            const name=document.getElementById('inp-name').value.trim();
            const code=document.getElementById('inp-code').value.trim().toUpperCase();
            if(!name || !code) return alert("Nome e codice obbligatori!");

            try {
                if(asCreator) {
                    // Cancella stanza esistente
                    const {data:oldRoom}=await supabase.from('stanze').select('id').eq('codice',code).maybeSingle();
                    if(oldRoom) {
                        await supabase.from('giocatori').delete().eq('stanza_id', oldRoom.id);
                        await supabase.from('stanze').delete().eq('codice',code);
                    }
                    
                    // Prendi una frase casuale
                    const frase = await getRandomFrase();
                    
                    const {data:room,error:eR}=await supabase.from('stanze').insert({
                        codice:code,
                        stato:'in_gioco',
                        frase_corrente_id: frase.id || null,
                        round_giocati:1
                    }).select().single();
                    if(eR) throw eR;
                    roomId=room.id;

                    currentFrase = frase;
                    currentPuzzleText = frase.soluzione;

                    const {data:me,error:eM}=await supabase.from('giocatori').insert({
                        stanza_id:roomId,nome:name,indice:0
                    }).select().single();
                    if(eM) throw eM;
                    myId=me.id;
                } else {
                    const {data:room,error:eR}=await supabase.from('stanze').select('*').eq('codice',code).single();
                    if(eR||!room) throw new Error("Stanza non trovata");
                    roomId=room.id;

                    const {data:pls}=await supabase.from('giocatori').select('*').eq('stanza_id',roomId).order('indice');
                    const nextIdx= pls ? pls.length:0;
                    const {data:me,error:eM}=await supabase.from('giocatori').insert({
                        stanza_id:roomId,nome:name,indice:nextIdx
                    }).select().single();
                    if(eM) throw eM;
                    myId=me.id;
                }

                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('game-panel').classList.remove('hidden');
                loadGameState();
                startPolling();
            } catch(err) {
                alert("Errore: "+err.message);
            }
        }

        async function loadGameState() {
            try {
                const {data:room}=await supabase.from('stanze').select('*').eq('id',roomId).single();
                if(!room) return;
                currentStanza=room;

                const {data:pls}=await supabase.from('giocatori').select('*').eq('stanza_id',roomId).order('indice');
                allPlayers=pls||[];

                // Carica la frase se non l'abbiamo ancora
                if(!currentFrase.categoria && room.frase_corrente_id) {
                    const {data:frase}=await supabase.from('frasi').select('*').eq('id',room.frase_corrente_id).single();
                    if(frase) {
                        currentFrase = frase;
                        currentPuzzleText = frase.soluzione;
                    }
                } else if(!currentFrase.categoria) {
                    currentFrase = await getRandomFrase();
                    currentPuzzleText = currentFrase.soluzione;
                }

                document.getElementById('live-category').textContent = currentFrase.categoria;
                document.getElementById('round-hint').textContent = "";
                
                const me=allPlayers.find(p=>p.id===myId);
                if(me) {
                    document.getElementById('score-round').textContent='€'+(me.punteggio_round||0);
                    document.getElementById('score-total').textContent='€'+(me.punteggio_totale||0);
                }

                document.getElementById('round-indicator').textContent=`ROUND ${room.round_giocati} / 10`;
                
                const curP=allPlayers[room.id_giocatore_corrente];
                const isMyTurn=(curP && curP.id===myId);
                document.getElementById('turn-indicator').textContent=`Turno di ${curP?.nome||'...'}`;
                
                updateControls(isMyTurn);
                renderBoard();

                if(room.stato==='completata') endGame();
            } catch(e) {
                console.error("Errore loadGameState",e);
            }
        }

        function updateControls(isMyTurn) {
            const spinBtn = document.getElementById('btn-spin');
            const vowelBtn = document.getElementById('btn-vowel');
            const solveBtn = document.getElementById('btn-solve');
            const manualBtn = document.getElementById('btn-manual-cons');
            const wheelText = document.getElementById('wheel-status-text');

            if(!isMyTurn) {
                spinBtn.classList.add('disabled-btn'); spinBtn.disabled=true;
                vowelBtn.classList.add('disabled-btn'); vowelBtn.disabled=true;
                solveBtn.classList.add('disabled-btn'); solveBtn.disabled=true;
                manualBtn.classList.add('hidden');
                wheelText.textContent = "Aspetta il tuo turno";
                wheelText.style.color = "#888";
            } else {
                const hasSpun = (currentStanza.montepremi_round||0)>0 && (currentStanza.montepremi_round||0)<=10000;
                if(!hasSpun) {
                    spinBtn.classList.remove('disabled-btn'); spinBtn.disabled=false;
                    vowelBtn.classList.remove('disabled-btn'); vowelBtn.disabled=false;
                    solveBtn.classList.remove('disabled-btn'); solveBtn.disabled=false;
                    manualBtn.classList.add('hidden');
                    wheelText.textContent = "PREMI G";
                    wheelText.style.color = "lime";
                } else {
                    spinBtn.classList.add('disabled-btn'); spinBtn.disabled=true;
                    vowelBtn.classList.add('disabled-btn'); vowelBtn.disabled=true;
                    solveBtn.classList.remove('disabled-btn'); solveBtn.disabled=false;
                    manualBtn.classList.remove('hidden');
                    wheelText.textContent = `Hai girato: €${currentStanza.montepremi_round}`;
                    wheelText.style.color = "#ffd700";
                }
            }
        }

        function renderBoard() {
            const sol = currentPuzzleText.toUpperCase();
            const rev = currentStanza.lettere_rivelate || [];
            const words = sol.split(/\s+/);
            parsedBoard=[];
            let globalIdx=0;

            words.forEach(w=>{
                let arr=[];
                for(let i=0; i<w.length; i++){
                    const ch=w[i];
                    const isLetter = ch.match(/[A-ZÀ-Ù0-9]/)!==null;
                    if(isLetter){
                        arr.push({char:ch,isLetter:true,isRevealed:rev.includes(globalIdx),globalIndex:globalIdx});
                        globalIdx++;
                    } else {
                        arr.push({char:ch,isLetter:false,isRevealed:true,globalIndex:-1});
                    }
                }
                parsedBoard.push({chars:arr});
            });

            const bc=document.getElementById('board-container');
            bc.innerHTML='';
            parsedBoard.forEach((w,wi)=>{
                const row=document.createElement('div');
                row.className='board-row';
                row.dataset.wordIndex=wi;
                w.chars.forEach((c,ci)=>{
                    const tile=document.createElement('div');
                    tile.className='tile';
                    if(c.isLetter){
                        tile.textContent=c.isRevealed?c.char:'';
                        tile.dataset.charIndex=ci;
                        tile.dataset.wordIndex=wi;
                        tile.dataset.revealed=c.isRevealed;
                        if(!c.isRevealed) tile.classList.add('empty');
                    } else {
                        tile.textContent=c.char;
                        tile.style.background='#333';
                    }
                    row.appendChild(tile);
                });
                bc.appendChild(row);
            });
            updateCursors();
        }

        function updateCursors() {
            document.querySelectorAll('.tile').forEach(t=>{
                t.classList.remove('cursor-char');
            });
            document.querySelectorAll('.board-row').forEach(r=>{
                r.classList.remove('cursor-word');
            });

            if(parsedBoard[curWord]){
                const letterTiles = Array.from(document.querySelectorAll(`.board-row[data-word-index="${curWord}"] .tile[data-char-index]`));
                if(letterTiles[curChar]) letterTiles[curChar].classList.add('cursor-char');
                document.querySelector(`.board-row[data-word-index="${curWord}"]`)?.classList.add('cursor-word');
            }
        }

        function moveNav(dir) {
            if(!parsedBoard[curWord]) return;
            const letters = parsedBoard[curWord].chars.filter(c=>c.isLetter);
            curChar = (curChar+dir+letters.length)%letters.length;
            updateCursors();
            const c=letters[curChar];
            speak(c.isRevealed?c.char:"Vuota");
        }

        function moveWordNav(dir) {
            curWord = (curWord+dir+parsedBoard.length)%parsedBoard.length;
            curChar=0;
            updateCursors();
            speak(`Parola ${curWord+1}`);
        }

        function startPolling() {
            if(turnPolling) clearInterval(turnPolling);
            turnPolling = setInterval(loadGameState, 2000);
        }

        async function doSpin() {
            const me=allPlayers.find(p=>p.id===myId);
            if(!me) return;
            const curIdx = allPlayers.indexOf(me);
            if(currentStanza.id_giocatore_corrente !== curIdx) return;
            if((currentStanza.montepremi_round||0)>0 && (currentStanza.montepremi_round||0)<=10000) return;

            playSound('snd-spin');
            const wheel=document.getElementById('wheel-visual');
            const baseRot=3600;
            const rand=Math.floor(Math.random()*360);
            wheel.style.transform=`rotate(${baseRot+rand}deg)`;

            const values=[0,500,700,1000,1500,2000,3000,5000,999999];
            const val=values[Math.floor(Math.random()*values.length)];

            setTimeout(async()=>{
                if(val===999999 || val===0){
                    await supabase.from('stanze').update({
                        id_giocatore_corrente:(curIdx+1)%allPlayers.length,
                        ultima_azione:'gira_ruota',
                        ultimo_messaggio:(val===999999)?'PERDE TUTTO':'PASSA',
                        azione_timestamp:new Date().toISOString(),
                        montepremi_round:0
                    }).eq('id',roomId);
                    if(val===999999){
                        await supabase.from('giocatori').update({punteggio_round:0}).eq('id',myId);
                    }
                } else {
                    await supabase.from('stanze').update({
                        montepremi_round:val,
                        ultima_azione:'gira_ruota',
                        ultimo_messaggio:`Hai girato: €${val}`,
                        azione_timestamp:new Date().toISOString()
                    }).eq('id',roomId);
                }
            },3500);
        }

        function openInput(mode) {
            inputMode=true;
            inputModeType=mode;
            const inp=document.getElementById('game-input');
            const title=document.getElementById('input-title');
            
            if(mode==='vowel') title.textContent='COMPRA UNA VOCALE (500€)';
            else if(mode==='solve') title.textContent='RISOLVI IL PUZZLE';
            else title.textContent='INSERISCI UNA CONSONANTE';

            inp.value='';
            document.getElementById('input-area').classList.remove('hidden');
            inp.focus();
        }

        function closeInput() {
            inputMode=false;
            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('btn-spin').focus();
        }

        async function submitInput() {
            const txt=document.getElementById('game-input').value.trim().toUpperCase();
            if(!txt) return;
            closeInput();

            try {
                const me=allPlayers.find(p=>p.id===myId);
                if(!me) return;
                const myIndex=allPlayers.indexOf(me);
                const numPlayers=allPlayers.length;

                // RISOLUZIONE
                if(inputModeType==='solve') {
                    const isCorrect = cleanStr(txt)===cleanStr(currentPuzzleText);
                    if(isCorrect) {
                        playSound('snd-win');
                        const prizeRound = me.punteggio_round||0;
                        await supabase.from('giocatori').update({
                            punteggio_totale:(me.punteggio_totale||0)+prizeRound,
                            punteggio_round:0
                        }).eq('id',myId);

                        const nextRound = currentStanza.round_giocati+1;
                        if(nextRound>10){
                            await supabase.from('stanze').update({stato:'completata'}).eq('id',roomId);
                            return;
                        }

                        // Nuova frase per il prossimo round
                        const nuovaFrase = await getRandomFrase();
                        currentFrase = nuovaFrase;
                        currentPuzzleText = nuovaFrase.soluzione;

                        await supabase.from('stanze').update({
                            round_giocati: nextRound,
                            frase_corrente_id: nuovaFrase.id || null,
                            lettere_chiamate:[],
                            lettere_rivelate:[],
                            id_giocatore_corrente:0,
                            montepremi_round:0,
                            ultima_azione:'nuovo_round',
                            ultimo_messaggio:`VITTORIA! Round ${nextRound}`,
                            azione_timestamp:new Date().toISOString()
                        }).eq('id', roomId);
                    } else {
                        await supabase.from('stanze').update({
                            id_giocatore_corrente:(myIndex+1)%numPlayers,
                            ultima_azione:'errore',
                            ultimo_messaggio:`Errata`,
                            azione_timestamp:new Date().toISOString(),
                            montepremi_round: 0
                        }).eq('id',roomId);
                    }
                    return;
                }

                // LETTERE
                const char = txt.charAt(0);
                const sol = currentPuzzleText.toUpperCase();
                let found = [], globalIdx = 0;
                
                for(let i=0; i<sol.length; i++) {
                    if(sol[i].match(/[A-ZÀ-Ù0-9]/)) { 
                        if(cleanStr(sol[i]) === cleanStr(char)) found.push(globalIdx);
                        globalIdx++;
                    }
                }

                const oldCalls = currentStanza.lettere_chiamate || [];
                const alreadyCalled = oldCalls.some(c => cleanStr(c) === cleanStr(char));

                if (alreadyCalled) {
                    await supabase.from('stanze').update({
                        id_giocatore_corrente: (myIndex+1)%numPlayers,
                        ultima_azione: 'chiama_lettera',
                        ultimo_messaggio: `${char} già chiamata`,
                        montepremi_round: 0, 
                        azione_timestamp: new Date().toISOString()
                    }).eq('id', roomId);
                    return;
                }
                const newCalls = [...new Set([...oldCalls, char])];

                // VOCALE
                if(inputModeType==='vowel') {
                    if((me.punteggio_round || 0) < 500) { speak("Servono 500€"); return; } 
                    await supabase.from('giocatori').update({ punteggio_round: me.punteggio_round - 500 }).eq('id',myId);
                }

                const oldRev = currentStanza.lettere_rivelate || [];
                const count = found.length;
                let msg="", next=myIndex;
                let resetSpinValue = 0;

                if (count > 0) {
                    msg = `${count} ${char}`;
                    if(inputModeType==='letter') {
                        const val = currentStanza.montepremi_round||0;
                        const realVal = (val > 10000) ? 0 : val;
                        
                        await supabase.from('giocatori').update({
                            punteggio_round: (me.punteggio_round || 0) + (realVal*count)
                        }).eq('id',myId);
                    }
                } else {
                    msg = `Nessuna ${char}`; 
                    next = (myIndex+1)%numPlayers;
                    resetSpinValue = 0; 
                }

                const newRev = [...new Set([...oldRev, ...found])];
                
                await supabase.from('stanze').update({
                    lettere_rivelate: newRev, 
                    lettere_chiamate: newCalls,
                    id_giocatore_corrente: next, 
                    ultima_azione: 'chiama_lettera', 
                    ultimo_messaggio: msg, 
                    montepremi_round: resetSpinValue, 
                    azione_timestamp: new Date().toISOString()
                }).eq('id', roomId);

            } catch(e) {
                console.error("Errore input", e);
            }
        }

        function openInspector() {
            const div = document.getElementById('inspector-content');
            let html = `<h2 style="color:#ffd700;">${currentFrase.categoria}</h2>`;
            parsedBoard.forEach((w, i) => {
                let s = "";
                w.chars.forEach(c => { s += c.isRevealed ? c.char : "_"; });
                html += `<p>${s}</p>`;
            });
            div.innerHTML = html;
            document.getElementById('inspector-overlay').classList.remove('hidden');
            div.focus();
        }
        
        function closeInspector() { 
            document.getElementById('inspector-overlay').classList.add('hidden'); 
            if(inputMode) {
                 document.getElementById('game-input').focus();
            } else {
                 document.getElementById('btn-spin').focus(); 
            }
        }

        function readRevealedLetters() {
            const found = new Set();
            parsedBoard.forEach(w => {
                w.chars.forEach(c => {
                    if(c.isLetter && c.isRevealed) found.add(c.char);
                });
            });
            
            const sortedList = Array.from(found).sort();
            if (sortedList.length === 0) return speak("Nessuna lettera");
            
            const text = sortedList.join(", ");
            speak("Lettere: " + text);
        }

        async function endGame() {
            clearInterval(turnPolling);
            document.getElementById('game-panel').classList.add('hidden');
            document.getElementById('end-panel').classList.remove('hidden');
            
            const ranking = [...allPlayers].sort((a,b)=>(b.punteggio_totale||0)-(a.punteggio_totale||0));
            const ul = document.getElementById('ranking-list');
            ul.innerHTML='';
            ranking.forEach((p,i)=>{
                const li=document.createElement('li');
                li.innerHTML=`<strong>${i+1}°</strong> ${p.nome} - €${p.punteggio_totale||0}`;
                ul.appendChild(li);
            });
        }

        document.addEventListener('keydown', (e) => {
            if(!e.key) return;
            const k = e.key.toLowerCase();

            if(e.ctrlKey) {
                if(k==='i') { e.preventDefault(); openInspector(); return; }
                if(k==='l') { e.preventDefault(); readRevealedLetters(); return; }
                
                if(k==='s') {
                    e.preventDefault();
                    if(inputMode) closeInput(); 
                    if(!document.getElementById('inspector-overlay').classList.contains('hidden')) closeInspector();
                    openInput('solve');
                    return;
                }
                
                if(!inputMode) {
                     if(k==='g') { e.preventDefault(); doSpin(); return; }
                     if(k==='v') { e.preventDefault(); openInput('vowel'); return; }
                }
            }

            if(inputMode || !document.getElementById('inspector-overlay').classList.contains('hidden')) {
                if(e.key==='Escape') { closeInput(); closeInspector(); }
                if(e.key==='Enter' && inputMode) submitInput();
                return; 
            }

            if(e.key==='ArrowRight') { e.preventDefault(); e.ctrlKey ? moveWordNav(1) : moveNav(1); }
            if(e.key==='ArrowLeft') { e.preventDefault(); e.ctrlKey ? moveWordNav(-1) : moveNav(-1); }
            if(e.key==='ArrowDown') { e.preventDefault(); moveWordNav(1); }
            if(e.key==='ArrowUp') { e.preventDefault(); moveWordNav(-1); }
            
            if(!e.ctrlKey && !inputMode) {
                if(k==='g') { e.preventDefault(); doSpin(); return; }
                if(k==='v') { e.preventDefault(); openInput('vowel'); return; }
                if(k==='s') { e.preventDefault(); openInput('solve'); return; }
            }
        });
    </script>
</body>
</html>
